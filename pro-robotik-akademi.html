<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Pro Robotik Akademi: Ultra S√ºr√ºm</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;800&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --bg-gradient: radial-gradient(circle at center, #240b36, #c31432);
      --panel-bg: rgba(255, 255, 255, 0.98);
      --primary: #f9ca24;
      --success: #6ab04c;
      --danger: #eb4d4b;
      --block-move: #2980b9;
      --block-turn: #27ae60;
      --block-action: #8e44ad;
      --block-loop: #e67e22;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

    body {
      background: var(--bg-gradient);
      width: 100%; height: 100vh; margin: 0; padding: 0;
      overflow: hidden; font-family: 'Nunito', sans-serif;
      display: flex; flex-direction: column;
    }

    /* --- √úST PANEL --- */
    header {
      height: 60px; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 15px; color: white; z-index: 500; flex-shrink: 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .brand { 
      font-family: 'Fredoka One', cursive; font-size: 20px; 
      display: flex; align-items: center; gap: 8px; color: var(--primary);
      text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
    }
    .brand i { animation: float 3s ease-in-out infinite; }

    .level-info {
      display: flex; flex-direction: column; align-items: center;
      background: rgba(255,255,255,0.1); padding: 2px 15px; border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .level-sub { font-size: 10px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }
    .level-main { font-weight: 800; font-size: 14px; color: #fff; }

    .header-btns { display: flex; gap: 8px; }
    .btn-circle {
      width: 36px; height: 36px; border-radius: 50%; border: none;
      background: rgba(255,255,255,0.15); color: white; font-size: 16px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .btn-circle:hover { background: var(--primary); transform: scale(1.1); color: #333; }
    .btn-circle.active { background: var(--danger); box-shadow: 0 0 10px var(--danger); }

    /* --- ANA YERLE≈ûƒ∞M (LAYOUT) --- */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column; /* Varsayƒ±lan: Mobil (Alt alta) */
      overflow: hidden;
      position: relative;
    }

    /* --- OYUN ALANI --- */
    .stage-wrapper {
      flex: 1; /* Kalan t√ºm alanƒ± kapla */
      position: relative; overflow: hidden;
      display: flex; justify-content: center; align-items: center;
      padding: 10px;
    }

    .game-board {
      position: relative;
      background: rgba(20, 20, 40, 0.7);
      border-radius: 16px;
      border: 3px solid rgba(255,255,255,0.15);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      transition: transform 0.3s;
      /* Grid Deseni */
      background-image: 
        linear-gradient(rgba(255,255,255,0.08) 2px, transparent 2px),
        linear-gradient(90deg, rgba(255,255,255,0.08) 2px, transparent 2px);
    }
    .game-board.shake { animation: shake 0.5s; border-color: var(--danger); }
    .game-board.win { border-color: var(--success); box-shadow: 0 0 50px var(--success); }

    /* Grid H√ºcreleri */
    .grid-cell { position: absolute; border-radius: 6px; transition: 0.3s; }
    .grid-cell.path { background: rgba(106, 176, 76, 0.4); box-shadow: inset 0 0 10px #6ab04c; }
    .grid-cell.error { background: rgba(235, 77, 75, 0.5); animation: flashRed 0.5s infinite; }

    /* NESNELER */
    .game-obj {
      position: absolute; display: flex; justify-content: center; align-items: center;
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 10; font-size: 2.5em; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.4));
    }

    /* Tilki */
    .fox { z-index: 20; transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), left 0.5s, top 0.5s; }
    .fox-avatar {
      display: inline-block; font-size: 0.8em;
      animation: breathe 2s ease-in-out infinite;
    }
    .fox[data-dir="0"] .fox-avatar { transform: scaleX(1); } 
    .fox[data-dir="2"] .fox-avatar { transform: scaleX(-1); } 
    .fox[data-dir="1"] .fox-avatar { transform: rotate(90deg); }
    .fox[data-dir="3"] .fox-avatar { transform: rotate(-90deg); }
    .fox.jump .fox-avatar { animation: jumpAnim 0.6s; }

    .star { font-size: 0.8em; animation: spinStar 4s linear infinite; filter: drop-shadow(0 0 10px gold); }
    .rock { font-size: 0.8em; filter: grayscale(0.6); }

    .bubble {
      position: absolute; top: -60px; left: 50%; transform: translateX(-50%);
      background: white; color: #2f3542; padding: 6px 10px; border-radius: 10px;
      font-weight: bold; font-size: 12px; white-space: nowrap; opacity: 0;
      transition: 0.3s; pointer-events: none; border: 2px solid #2f3542; z-index: 100;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .bubble.show { opacity: 1; top: -75px; }
    .bubble::after {
      content: ''; position: absolute; bottom: -6px; left: 50%; margin-left: -6px;
      border-width: 6px 6px 0; border-style: solid; border-color: #2f3542 transparent;
    }

    /* --- KODLAMA PANELƒ∞ --- */
    .coding-panel {
      /* Mobil i√ßin optimize y√ºkseklik */
      height: 35vh; min-height: 200px; max-height: 300px;
      background: var(--panel-bg);
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -5px 30px rgba(0,0,0,0.3);
      padding: 10px; display: flex; flex-direction: column; gap: 8px;
      z-index: 400; position: relative;
    }

    .panel-titles { display: flex; justify-content: space-between; font-size: 11px; font-weight: 800; color: #747d8c; text-transform: uppercase; padding: 0 5px; }

    .toolbar {
      display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px;
      scrollbar-width: none; flex-shrink: 0; min-height: 45px; align-items: center;
    }
    .toolbar::-webkit-scrollbar { display: none; }

    .block-btn {
      padding: 8px 12px; border-radius: 8px; color: white; cursor: pointer;
      display: flex; align-items: center; gap: 6px; font-weight: 700; font-size: 13px;
      box-shadow: 0 3px 0 rgba(0,0,0,0.15); transition: transform 0.1s;
      white-space: nowrap; user-select: none; flex-shrink: 0;
    }
    .block-btn:active { transform: translateY(2px); box-shadow: none; }
    .block-btn i { font-size: 1.2em; }

    .b-move { background: var(--block-move); }
    .b-turn { background: var(--block-turn); }
    .b-action { background: var(--block-action); }
    .b-loop { background: var(--block-loop); color: #333; border: 2px solid #e1b12c; }

    .program-wrapper {
      flex: 1; background: #dfe4ea; border-radius: 12px; border: 2px dashed #ced6e0;
      padding: 5px 10px; position: relative; overflow: hidden; display: flex; align-items: center;
    }
    
    .program-area {
      display: flex; align-items: center; gap: 8px; overflow-x: auto;
      width: 100%; height: 100%; padding-right: 30px; scroll-behavior: smooth;
    }

    .empty-hint {
      position: absolute; width: 100%; text-align: center; font-size: 14px;
      color: #747d8c; font-style: italic; pointer-events: none; font-weight: bold;
    }

    .p-block {
      background: white; padding: 6px 10px; border-radius: 8px;
      border: 2px solid #a4b0be; box-shadow: 0 3px 0 #747d8c;
      display: flex; flex-direction: column; align-items: center; min-width: 55px;
      cursor: pointer; font-weight: 800; font-size: 10px; color: var(--text);
      transition: 0.2s; flex-shrink: 0; position: relative;
    }
    .p-block:hover { transform: translateY(-2px); border-color: var(--danger); color: var(--danger); }
    .p-block.active { 
      border-color: var(--success); background: #d1f2eb; 
      transform: scale(1.15); z-index: 10; box-shadow: 0 0 15px var(--success); 
    }
    .p-block.loop-start { background: #fff3cd; border-left: 4px solid var(--b-loop); }
    .p-block.loop-end { background: #fff3cd; border-right: 4px solid var(--b-loop); opacity: 0.8; }
    
    .idx-badge { 
      position: absolute; top: -8px; left: -8px; width: 18px; height: 18px; 
      background: #2f3542; color: white; border-radius: 50%; font-size: 9px; 
      display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .controls { display: flex; gap: 10px; margin-top: 5px; }
    .btn-main {
      flex: 1; padding: 12px; border: none; border-radius: 12px;
      font-family: 'Fredoka One', cursive; font-size: 16px; color: white;
      cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
      box-shadow: 0 5px 0 rgba(0,0,0,0.2); transition: 0.1s; text-transform: uppercase;
    }
    .btn-main:active { transform: translateY(3px); box-shadow: none; }
    .btn-run { background: var(--success); }
    .btn-reset { background: var(--danger); flex: 0.4; }

    /* --- RESPONSIVE LAYOUT (MASA√úST√ú/TABLET ƒ∞√áƒ∞N YAN YANA) --- */
    @media (min-width: 768px) {
      .main-content {
        flex-direction: row; /* Yan yana */
      }
      
      .stage-wrapper {
        flex: 2; /* Sahneye daha √ßok yer */
        background-size: 50px 50px;
        padding: 30px;
      }

      .coding-panel {
        width: 350px; /* Sabit geni≈ülik */
        height: auto; /* Y√ºkseklik full */
        max-height: none;
        border-radius: 0;
        border-left: 5px solid rgba(0,0,0,0.1);
        padding: 20px;
      }

      /* Yatayda toolbar ta≈üarsa a≈üaƒüƒ± insin */
      .toolbar { flex-wrap: wrap; overflow-y: auto; max-height: 150px; }
      .program-wrapper { flex: 1; flex-direction: column; align-items: flex-start; overflow-y: auto; }
      .program-area { flex-wrap: wrap; width: 100%; height: auto; overflow-y: auto; padding-bottom: 20px; }
      .empty-hint { position: relative; top: 0; left: 0; transform: none; margin-top: 20px; }
    }

    /* Modallar */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); z-index: 2000;
      display: flex; justify-content: center; align-items: center;
      opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(8px);
    }
    .modal-overlay.open { opacity: 1; pointer-events: auto; }
    
    .modal-card {
      background: white; width: 90%; max-width: 450px; padding: 30px;
      border-radius: 24px; text-align: center; transform: scale(0.8);
      transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 5px solid rgba(255,255,255,0.5); box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    .modal-overlay.open .modal-card { transform: scale(1); }

    .grade-btn {
      width: 100%; padding: 18px; margin: 10px 0; border: none; border-radius: 16px;
      background: #f1f2f6; font-size: 18px; font-weight: bold; cursor: pointer;
      display: flex; justify-content: space-between; align-items: center; transition: 0.2s;
      color: #2f3542; box-shadow: 0 4px 0 #dcdde1; border-left: 8px solid transparent;
    }
    .grade-btn:hover { background: #dfe4ea; border-left-color: var(--primary); padding-left: 25px; }
    
    .stars-container { font-size: 50px; color: #dcdde1; margin: 15px 0; }
    .stars-container .filled { color: #f1c40f; filter: drop-shadow(0 0 5px gold); animation: popIn 0.5s backwards; }

    /* ANƒ∞MASYONLAR */
    @keyframes shake { 0%,100% {transform:translateX(0);} 25% {transform:translateX(-5px);} 75% {transform:translateX(5px);} }
    @keyframes flashRed { 0%, 100% {opacity: 1;} 50% {opacity: 0.5;} }
    @keyframes jumpAnim { 0%,100% {transform: translateY(0) scaleX(1);} 50% {transform: translateY(-40%) scale(1.2);} }
    @keyframes breathe { 0%,100% {transform: scale(1);} 50% {transform: scale(1.05);} }
    @keyframes spinStar { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    @keyframes pulseWin { 0% { box-shadow: 0 0 20px var(--success); } 100% { box-shadow: 0 0 50px var(--success); } }

  </style>
</head>

<body>

  <canvas id="confetti-canvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;"></canvas>

  <!-- MODAL: Seviye Se√ßimi -->
  <div class="modal-overlay open" id="levelModal">
    <div class="modal-card">
      <h2 style="color: var(--primary); font-family: 'Fredoka One'; margin-top:0;">Sƒ±nƒ±fƒ±nƒ± Se√ß! üéì</h2>
      <p style="color: #636e72; font-weight: bold;">Macera hangi seviyede ba≈ülasƒ±n?</p>
      
      <button class="grade-btn" onclick="app.setGrade(1)">
        <div>üë∂ 1-2. Sƒ±nƒ±f (Simgeler)</div>
        <i class="fas fa-shapes"></i>
      </button>
      <button class="grade-btn" onclick="app.setGrade(2)">
        <div>üë¶ 3-4. Sƒ±nƒ±f (Kelimeler)</div>
        <i class="fas fa-font"></i>
      </button>
      <button class="grade-btn" onclick="app.setGrade(3)">
        <div>üë©‚Äçüíª 5-7. Sƒ±nƒ±f (Kodlar)</div>
        <i class="fas fa-code"></i>
      </button>
    </div>
  </div>

  <!-- MODAL: Ba≈üarƒ± -->
  <div class="modal-overlay" id="winModal">
    <div class="modal-card" style="border-top: 8px solid var(--success);">
      <h2 style="color: var(--success); font-family: 'Fredoka One'; font-size: 36px; margin:0;">HARƒ∞KA! üéâ</h2>
      <div class="stars-container" id="winStars">
        <i class="fas fa-star filled" style="animation-delay: 0.1s"></i>
        <i class="fas fa-star filled" style="animation-delay: 0.3s"></i>
        <i class="fas fa-star filled" style="animation-delay: 0.5s"></i>
      </div>
      <p id="winMsg" style="font-size: 18px; font-weight: bold; color: #2f3542;">B√∂l√ºm√º ba≈üarƒ±yla tamamladƒ±n!</p>
      <button class="btn-main btn-run" onclick="app.nextLevel()">
        Sonraki B√∂l√ºm <i class="fas fa-arrow-right"></i>
      </button>
    </div>
  </div>

  <header>
    <div class="brand">
      <i class="fas fa-paw"></i>
      <span>RoboTilki</span>
    </div>
    
    <div class="level-info">
      <span class="level-sub" id="gradeTitle">BA≈ûLANGI√á</span>
      <span class="level-main" id="levelVal">1. B√∂l√ºm</span>
    </div>

    <div class="header-btns">
      <button class="btn-circle" onclick="app.showHint()" title="ƒ∞pucu"><i class="far fa-lightbulb"></i></button>
      <button class="btn-circle" onclick="app.openMenu()" title="Men√º"><i class="fas fa-bars"></i></button>
      <button class="btn-circle" id="muteBtn" onclick="app.toggleMute()" title="Ses"><i class="fas fa-volume-up"></i></button>
    </div>
  </header>

  <!-- ANA ƒ∞√áERƒ∞K (Responsive D√ºzen) -->
  <div class="main-content">
    
    <div class="stage-wrapper">
      <div class="game-board" id="board">
        <!-- Grid JS ile olu≈üturulacak -->
      </div>
    </div>

    <div class="coding-panel">
      <div class="panel-titles">
        <span><i class="fas fa-cubes"></i> Bloklar</span>
        <span><i class="fas fa-code-branch"></i> Program</span>
      </div>
      
      <!-- Bloklar -->
      <div class="toolbar" id="toolbar"></div>

      <!-- Program -->
      <div class="program-wrapper">
        <div class="program-area" id="programArea">
          <div class="empty-hint">
            <i class="fas fa-hand-pointer"></i> Blok ekle...
          </div>
        </div>
      </div>

      <!-- Kontroller -->
      <div class="controls">
        <button class="btn-main btn-reset" onclick="app.resetLevel()"><i class="fas fa-undo"></i> SIFIRLA</button>
        <button class="btn-main btn-run" onclick="app.runCode()"><i class="fas fa-play"></i> √áALI≈ûTIR</button>
      </div>
    </div>

  </div>

  <!-- Konfeti K√ºt√ºphanesi -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    // --- OYUN VERƒ∞LERƒ∞ (HER SINIF ƒ∞√áƒ∞N AYRI HARƒ∞TALAR) ---
    const DATA = {
      grades: {
        1: { title: "1-2. Sƒ±nƒ±f", blocks: ['up', 'down', 'left', 'right', 'jump'] },
        2: { title: "3-4. Sƒ±nƒ±f", blocks: ['fwd', 'left', 'right', 'jump', 'color'] },
        3: { title: "5-7. Sƒ±nƒ±f", blocks: ['move', 'turnR', 'loop', 'end', 'func'] }
      },
      blocks: {
        'up': { id: 'up', icon: 'fa-arrow-up', type: 'b-move', act: 'moveUp' },
        'down': { id: 'down', icon: 'fa-arrow-down', type: 'b-move', act: 'moveDown' },
        'left': { id: 'left', icon: 'fa-arrow-left', type: 'b-move', act: 'moveLeft' },
        'right': { id: 'right', icon: 'fa-arrow-right', type: 'b-move', act: 'moveRight' },
        
        'fwd': { id: 'fwd', label: 'ƒ∞leri', icon: 'fa-shoe-prints', type: 'b-move', act: 'moveFwd' },
        'color': { id: 'color', label: 'Renk', icon: 'fa-palette', type: 'b-action', act: 'color' },
        'jump': { id: 'jump', label: 'Zƒ±pla', icon: 'fa-frog', type: 'b-action', act: 'jump' },
        
        'move': { id: 'move', label: 'move(1)', type: 'b-move', act: 'moveFwd' },
        'turnR': { id: 'turnR', label: 'turn(90)', icon: 'fa-redo', type: 'b-turn', act: 'turnRight' },
        'loop': { id: 'loop', label: 'loop(3)', type: 'b-loop', act: 'loop' },
        'end': { id: 'end', label: 'end', type: 'b-loop', act: 'loopEnd' },
        'func': { id: 'func', label: 'func()', type: 'b-action', act: 'color' }
      },
      levels: [
        { w: 5, h: 4, start: [0,1], goal: [4,1], obs: [], hint: "D√ºz bir √ßizgi √ßekmeye ne dersin?" },
        { w: 6, h: 5, start: [0,0], goal: [5,4], obs: [[1,0],[3,2],[4,3]], hint: "Engellerden ka√ßƒ±nmak i√ßin etrafƒ±ndan dola≈ü." },
        { w: 5, h: 5, start: [2,2], goal: [2,0], obs: [[2,1]], hint: "Yolunda bir engel var! Zƒ±playarak ge√ßebilirsin." },
        { w: 7, h: 4, start: [0,2], goal: [6,2], obs: [[3,2],[3,1],[3,3]], hint: "Labirentin i√ßinden doƒüru yolu bulmalƒ±sƒ±n." },
        { w: 6, h: 6, start: [0,0], goal: [5,5], obs: [[1,1],[2,2],[3,3],[4,4]], hint: "Merdiven gibi basamak basamak inmelisin." }
      ]
    };

    class App {
      constructor() {
        this.grade = 1;
        this.levelIndex = 0;
        this.program = [];
        this.isRunning = false;
        this.isMuted = false;
        this.cellSize = 80;
        
        // State
        this.fox = { x: 0, y: 0, dir: 0 }; 
        this.map = null; 
        
        // DOM Elements
        this.elBoard = document.getElementById('board');
        this.elProgram = document.getElementById('programArea');
        this.elToolbar = document.getElementById('toolbar');
        this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // G√úVENLƒ∞ BA≈ûLATMA
        // √ñnce varsayƒ±lan haritayƒ± y√ºkle
        this.map = DATA.levels[0];
        
        window.addEventListener('resize', () => {
          if(this.map) this.resizeBoard();
        });
        
        // ƒ∞lk √ßizimi yap
        this.buildBoard();
        this.renderToolbar();
      }

      setGrade(g) {
        this.grade = g;
        this.levelIndex = 0;
        document.getElementById('gradeTitle').innerText = DATA.grades[g].title;
        document.getElementById('levelModal').classList.remove('open');
        this.loadLevel();
      }

      openMenu() { document.getElementById('levelModal').classList.add('open'); }

      loadLevel() {
        this.map = DATA.levels[this.levelIndex % DATA.levels.length];
        this.fox = { x: this.map.start[0], y: this.map.start[1], dir: 0 };
        document.getElementById('levelVal').innerText = `${this.levelIndex + 1}. B√∂l√ºm`;
        
        this.program = []; 
        this.buildBoard();
        this.renderToolbar();
        this.renderProgram(); 
        this.resetLevel();
      }

      // --- SAHNE ---
      buildBoard() {
        if (!this.map) return;
        this.elBoard.innerHTML = '';
        
        const wrapper = document.querySelector('.stage-wrapper');
        const maxW = wrapper.clientWidth - 20; 
        const maxH = wrapper.clientHeight - 20;
        
        // Responsive H√ºcre Boyutu Hesapla (Maksimum ekranƒ± dolduracak ≈üekilde)
        this.cellSize = Math.min(Math.floor(maxW / this.map.w), Math.floor(maxH / this.map.h));
        
        // Sƒ±nƒ±rlar (Mobilde √ßok k√º√ß√ºk, PC'de devasa olmasƒ±n)
        if (this.cellSize > 140) this.cellSize = 140;
        if (this.cellSize < 40) this.cellSize = 40;

        this.elBoard.style.width = (this.map.w * this.cellSize) + 'px';
        this.elBoard.style.height = (this.map.h * this.cellSize) + 'px';
        this.elBoard.style.backgroundSize = `${this.cellSize}px ${this.cellSize}px`;

        // Hedef
        this.spawnObj(this.map.goal, 'game-obj star', '‚≠êÔ∏è');

        // Engeller
        this.map.obs.forEach(pos => {
          this.spawnObj(pos, 'game-obj rock', 'ü™®');
        });

        // Tilki
        const foxEl = document.createElement('div');
        foxEl.id = 'fox';
        foxEl.className = 'game-obj fox';
        foxEl.style.width = this.cellSize + 'px';
        foxEl.style.height = this.cellSize + 'px';
        foxEl.style.fontSize = (this.cellSize * 0.7) + 'px'; 
        foxEl.innerHTML = `
          <div class="bubble" id="bubble">Hazƒ±r!</div>
          <div class="fox-avatar">ü¶ä</div>
        `;
        this.elBoard.appendChild(foxEl);
        this.updateFoxPos(false);
      }

      spawnObj(pos, cls, icon) {
        const el = document.createElement('div');
        el.className = cls;
        el.innerHTML = icon;
        el.style.width = this.cellSize + 'px';
        el.style.height = this.cellSize + 'px';
        el.style.left = (pos[0] * this.cellSize) + 'px';
        el.style.top = (pos[1] * this.cellSize) + 'px';
        el.style.fontSize = (this.cellSize * 0.6) + 'px';
        this.elBoard.appendChild(el);
      }

      resizeBoard() { if(this.map) this.buildBoard(); }

      // --- KODLAMA ---
      renderToolbar() {
        this.elToolbar.innerHTML = '';
        const blockKeys = DATA.grades[this.grade].blocks;
        
        blockKeys.forEach(key => {
          const b = DATA.blocks[key];
          const btn = document.createElement('div');
          btn.className = `block-btn ${b.type}`;
          btn.innerHTML = `${b.icon ? `<i class="fas ${b.icon}"></i>` : ''} ${b.label}`;
          // Klonlayarak ekle
          btn.onclick = () => this.addBlock({ ...b });
          this.elToolbar.appendChild(btn);
        });
      }

      addBlock(block) {
        if(this.isRunning) return;
        
        let newBlock = { ...block, id: Date.now() + Math.random() }; 
        if(block.act === 'loop') newBlock.isLoop = true;
        if(block.act === 'loopEnd') newBlock.isLoopEnd = true;

        this.program.push(newBlock);
        this.renderProgram();
        
        // Son eklenene kaydƒ±r (Timeout, DOM g√ºncellemesini beklemek i√ßin)
        setTimeout(() => {
            // Dikey (PC) veya yatay (Mobil) kaydƒ±rma
            if(window.innerWidth >= 768) {
               // Dikey scroll
               const lastEl = this.elProgram.lastElementChild;
               if(lastEl) lastEl.scrollIntoView({ behavior: "smooth" });
            } else {
               // Yatay scroll
               this.elProgram.scrollLeft = this.elProgram.scrollWidth;
            }
        }, 50);
        
        this.playSound(600, 'sine', 0.05);
      }

      renderProgram() {
        this.elProgram.innerHTML = '';
        
        if(this.program.length === 0) {
          this.elProgram.innerHTML = '<div class="empty-hint"><i class="fas fa-hand-pointer"></i> Blok ekle...</div>';
          return;
        }

        this.program.forEach((blk, idx) => {
          const el = document.createElement('div');
          el.className = 'p-block';
          if(blk.isLoop) el.classList.add('loop-start');
          if(blk.isLoopEnd) el.classList.add('loop-end');

          el.innerHTML = `
            <div class="idx-badge">${idx + 1}</div>
            ${blk.icon ? `<i class="fas ${blk.icon}"></i>` : blk.label}
          `;
          if(blk.isLoop) el.innerHTML += '<span style="position:absolute;top:-5px;right:-5px;background:orange;color:white;font-size:9px;padding:2px 4px;border-radius:4px;">3x</span>';

          // Silme
          el.onclick = () => {
            if(!this.isRunning) {
              this.program.splice(idx, 1);
              this.renderProgram();
              this.playSound(200, 'triangle', 0.05);
            }
          };
          this.elProgram.appendChild(el);
        });
      }

      // --- √áALI≈ûTIRMA ---
      resetLevel() {
        this.isRunning = false;
        if (!this.map) return; 
        
        this.fox = { x: this.map.start[0], y: this.map.start[1], dir: 0 };
        this.updateFoxPos(false);
        document.querySelectorAll('.grid-cell').forEach(c => c.remove());
        this.elBoard.classList.remove('shake', 'win');
        this.speak("Sƒ±fƒ±rlandƒ±!");
        
        const foxEl = document.getElementById('fox');
        if(foxEl) {
          foxEl.classList.remove('jump');
          foxEl.querySelector('.fox-avatar').style.filter = 'none';
        }
      }

      async runCode() {
        if(this.isRunning || this.program.length === 0) {
          this.speak("√ñnce kod ekle!");
          return;
        }
        this.isRunning = true;
        
        // Ba≈üa d√∂n
        this.fox = { x: this.map.start[0], y: this.map.start[1], dir: 0 };
        this.updateFoxPos(false);
        document.querySelectorAll('.grid-cell').forEach(c => c.remove());

        const queue = this.compile();
        const uiBlocks = document.querySelectorAll('.p-block');

        for(let i=0; i<queue.length; i++) {
          if(!this.isRunning) break;

          const cmd = queue[i];
          
          if(cmd.uiIdx !== undefined && uiBlocks[cmd.uiIdx]) {
            const block = uiBlocks[cmd.uiIdx];
            block.classList.add('active');
            block.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
          }

          const result = await this.execute(cmd.act);

          if(cmd.uiIdx !== undefined && uiBlocks[cmd.uiIdx]) uiBlocks[cmd.uiIdx].classList.remove('active');

          if(result === 'crash') {
            this.handleFail();
            return;
          }
          if(result === 'win') {
            this.handleWin();
            return;
          }
        }
        this.isRunning = false;
        if(this.fox.x !== this.map.goal[0] || this.fox.y !== this.map.goal[1]) {
           this.speak("Hedefe varamadƒ±m...");
        }
      }

      compile() {
        let q = [];
        let i = 0;
        while(i < this.program.length) {
          const b = this.program[i];
          if(b.isLoop) {
            let loopBody = [];
            let j = i + 1;
            let depth = 1;
            while(j < this.program.length && depth > 0) {
              if(this.program[j].isLoop) depth++;
              if(this.program[j].isLoopEnd) depth--;
              if(depth > 0) loopBody.push({...this.program[j], uiIdx: j});
              j++;
            }
            for(let k=0; k<3; k++) q = q.concat(loopBody);
            i = j; 
          } else if(!b.isLoopEnd) {
            q.push({ ...b, uiIdx: i });
            i++;
          } else { i++; }
        }
        return q;
      }

      async execute(act) {
        return new Promise(resolve => {
          let dx=0, dy=0;
          let moved = false;
          const foxEl = document.getElementById('fox');

          switch(act) {
            case 'moveUp': dy=-1; this.fox.dir=3; moved=true; break;
            case 'moveDown': dy=1; this.fox.dir=1; moved=true; break;
            case 'moveLeft': dx=-1; this.fox.dir=2; moved=true; break;
            case 'moveRight': dx=1; this.fox.dir=0; moved=true; break;
            
            case 'moveFwd':
              if(this.fox.dir===0) dx=1;
              if(this.fox.dir===1) dy=1;
              if(this.fox.dir===2) dx=-1;
              if(this.fox.dir===3) dy=-1;
              moved=true;
              break;

            case 'turnRight':
              this.fox.dir = (this.fox.dir + 1) % 4;
              this.playSound(400, 'triangle', 0.1);
              break;
            case 'turnLeft':
              this.fox.dir = (this.fox.dir + 3) % 4; 
              this.playSound(400, 'triangle', 0.1);
              break;

            case 'jump':
              foxEl.classList.add('jump');
              this.playSound(600, 'square', 0.2);
              setTimeout(() => foxEl.classList.remove('jump'), 600);
              if(this.fox.dir===0) dx=2;
              if(this.fox.dir===1) dy=2;
              if(this.fox.dir===2) dx=-2;
              if(this.fox.dir===3) dy=-2;
              moved=true;
              break;

            case 'color':
              const hue = Math.floor(Math.random()*360);
              foxEl.querySelector('.fox-avatar').style.filter = `hue-rotate(${hue}deg)`;
              this.playSound(800, 'sine', 0.2);
              break;
          }

          if(moved) {
            const nx = this.fox.x + dx;
            const ny = this.fox.y + dy;

            if(nx < 0 || ny < 0 || nx >= this.map.w || ny >= this.map.h || 
               this.map.obs.some(o => o[0] === nx && o[1] === ny)) {
              
              this.markCell(this.fox.x, this.fox.y, 'error');
              this.playSound(150, 'sawtooth', 0.3);
              setTimeout(() => resolve('crash'), 400);
              return;
            }

            this.markCell(this.fox.x, this.fox.y, 'path');
            this.fox.x = nx;
            this.fox.y = ny;
            this.playSound(440, 'sine', 0.1);
          }

          this.updateFoxPos();

          if(this.fox.x === this.map.goal[0] && this.fox.y === this.map.goal[1]) {
            setTimeout(() => resolve('win'), 500);
          } else {
            setTimeout(() => resolve('ok'), 600);
          }
        });
      }

      updateFoxPos(animate=true) {
        const el = document.getElementById('fox');
        if(animate) el.style.transition = 'transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), left 0.5s, top 0.5s';
        else el.style.transition = 'none';

        el.style.left = (this.fox.x * this.cellSize) + 'px';
        el.style.top = (this.fox.y * this.cellSize) + 'px';
        el.setAttribute('data-dir', this.fox.dir);
      }

      markCell(x, y, type) {
        const el = document.createElement('div');
        el.className = `grid-cell ${type}`;
        el.style.width = this.cellSize + 'px';
        el.style.height = this.cellSize + 'px';
        el.style.left = (x * this.cellSize) + 'px';
        el.style.top = (y * this.cellSize) + 'px';
        this.elBoard.appendChild(el);
      }

      handleFail() {
        this.isRunning = false;
        this.elBoard.classList.add('shake');
        this.speak("Eyvah! √áarptƒ±m!");
        setTimeout(() => this.elBoard.classList.remove('shake'), 500);
      }

      handleWin() {
        this.isRunning = false;
        this.elBoard.classList.add('win');
        
        // Hata korumalƒ± konfeti
        if (typeof confetti === 'function') {
          this.fireConfetti();
        }
        
        this.playSound(800, 'square', 0.1);
        setTimeout(() => this.playSound(1200, 'square', 0.3), 150);
        document.getElementById('winModal').classList.add('open');
      }

      nextLevel() {
        document.getElementById('winModal').classList.remove('open');
        this.levelIndex++;
        this.loadLevel();
      }

      showHint() {
        this.speak(this.map.hint || "Yƒ±ldƒ±za ula≈ümaya √ßalƒ±≈ü!");
      }

      fireConfetti() {
        var count = 200;
        var defaults = { origin: { y: 0.7 } };
        function fire(particleRatio, opts) {
          confetti(Object.assign({}, defaults, opts, {
            particleCount: Math.floor(count * particleRatio)
          }));
        }
        fire(0.25, { spread: 26, startVelocity: 55, });
        fire(0.2, { spread: 60, });
        fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
      }

      // --- SES & YARDIMCI ---
      toggleMute() {
        this.isMuted = !this.isMuted;
        const btn = document.getElementById('muteBtn');
        btn.classList.toggle('muted', this.isMuted);
        btn.innerHTML = this.isMuted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
      }

      speak(text) {
        const b = document.getElementById('bubble');
        b.innerText = text;
        b.classList.add('show');
        setTimeout(() => b.classList.remove('show'), 2000);

        if(!this.isMuted && 'speechSynthesis' in window) {
          window.speechSynthesis.cancel();
          const u = new SpeechSynthesisUtterance(text);
          u.lang = 'tr-TR'; u.rate = 1.2; u.pitch = 1.4;
          window.speechSynthesis.speak(u);
        }
      }

      playSound(freq, type, dur) {
        if(this.isMuted) return;
        if(this.audioCtx.state === 'suspended') this.audioCtx.resume();
        const o = this.audioCtx.createOscillator();
        const g = this.audioCtx.createGain();
        o.type = type; o.frequency.value = freq;
        o.connect(g); g.connect(this.audioCtx.destination);
        o.start();
        g.gain.exponentialRampToValueAtTime(0.00001, this.audioCtx.currentTime + dur);
        o.stop(this.audioCtx.currentTime + dur);
      }
    }

    // G√úVENLƒ∞ BA≈ûLATMA
    window.addEventListener('DOMContentLoaded', () => {
      window.app = new App();
    });
  </script>
</body>
</html>
