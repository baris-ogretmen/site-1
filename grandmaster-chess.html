<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grandmaster Chess v3.0</title>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #262421;
            --panel-bg: #302e2b;
            --board-light: #ebecd0;
            --board-dark: #739552;
            --highlight: rgba(255, 255, 51, 0.6);
            --check: radial-gradient(circle, #ff4d4d 20%, transparent 80%);
            --text-color: #ffffff;
            --btn-bg: #454341;
            --btn-active: #81b64c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; touch-action: manipulation; font-family: 'Roboto', sans-serif; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            height: 100dvh; /* Mobil tarayƒ±cƒ±lar i√ßin dinamik y√ºkseklik */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* --- OYUN D√úZENƒ∞ (LAYOUT) --- */
        #game-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            padding: 10px;
            max-width: 800px;
        }

        /* √úst Bilgi Paneli (Rakip) */
        .player-panel {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel-bg);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 5px;
            height: 60px;
        }
        .player-info { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 1.1rem; }
        .avatar { width: 40px; height: 40px; border-radius: 5px; background-size: cover; border: 2px solid #555; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; background: #444; }
        .captured-pieces { display: flex; height: 25px; gap: -5px; }
        .captured-pieces img { height: 100%; filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.5)); }

        /* --- SATRAN√á TAHTASI (Responsive Sihirbazlƒ±k) --- */
        #board-container {
            position: relative;
            /* Ekranƒ±n en kƒ±sa kenarƒ±na g√∂re boyutlan (Dikeyde geni≈ülik, Yatayda y√ºkseklik sƒ±nƒ±r) */
            width: min(95vw, 65vh); 
            height: min(95vw, 65vh);
            background: var(--panel-bg);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        #chess-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: 100%;
            height: 100%;
            border-radius: 3px;
            overflow: hidden;
        }

        .square {
            display: flex; justify-content: center; align-items: center;
            position: relative; cursor: pointer;
        }
        .square.light { background-color: var(--board-light); color: black; }
        .square.dark { background-color: var(--board-dark); color: white; }
        
        .square.selected { background-color: var(--highlight) !important; }
        .square.last-move { background-color: rgba(255, 255, 51, 0.4) !important; }
        .square.in-check { background: var(--check) !important; }

        /* Hareket ƒ∞pu√ßlarƒ± */
        .hint-dot { width: 30%; height: 30%; background: rgba(0,0,0,0.2); border-radius: 50%; pointer-events: none; }
        .hint-ring { width: 85%; height: 85%; border: 6px solid rgba(0,0,0,0.2); border-radius: 50%; pointer-events: none; }

        /* Ta≈ü Resimleri */
        .piece {
            width: 100%; height: 100%;
            background-size: 100%;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 10;
            transition: transform 0.1s;
        }
        .piece:active { transform: scale(1.2); }

        /* --- KONTROLLER (Alt Panel) --- */
        .controls-panel {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        .btn {
            background: var(--btn-bg);
            color: #ccc;
            border: none;
            padding: 15px 25px; /* B√ºy√ºk butonlar (Akƒ±llƒ± tahta i√ßin) */
            border-radius: 12px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn:hover { background: #555; color: white; }
        .btn.primary { background: var(--btn-active); color: white; }
        .btn.primary:hover { background: #71a042; }

        /* --- MODAL (OYUN SONU) --- */
        #modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            display: none; align-items: center; justify-content: center; z-index: 100;
            backdrop-filter: blur(5px);
        }
        .modal-box {
            background: var(--panel-bg); padding: 40px; border-radius: 20px;
            text-align: center; border: 2px solid #555; max-width: 90%;
        }
        .modal-title { font-size: 2.5rem; font-weight: 900; margin-bottom: 10px; color: white; }
        .modal-text { color: #aaa; margin-bottom: 30px; font-size: 1.2rem; }

        /* D√∂nd√ºrme Efekti */
        .rotate-board #chess-board { transform: rotate(180deg); }
        .rotate-board .piece { transform: rotate(180deg); }

        /* Fullscreen Butonu */
        #fullscreen-btn { position: absolute; top: 10px; right: 10px; font-size: 1.5rem; background: transparent; color: #777; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <button id="fullscreen-btn" onclick="toggleFullScreen()"><ion-icon name="expand-outline"></ion-icon></button>

    <div id="game-layout">
        
        <div class="player-panel">
            <div class="player-info">
                <div class="avatar"><ion-icon name="hardware-chip"></ion-icon></div>
                <div>
                    <div>Yapay Zeka (CPU)</div>
                    <div style="font-size:0.8rem; color:#aaa;">Seviye: Orta</div>
                </div>
            </div>
            <div class="captured-pieces" id="captured-top"></div>
        </div>

        <div id="board-container">
            <div id="chess-board"></div>
        </div>

        <div class="player-panel" style="margin-top: 5px; margin-bottom: 0;">
            <div class="player-info">
                <div class="avatar" style="background:#81b64c;"><ion-icon name="person"></ion-icon></div>
                <div>Sen (Beyaz)</div>
            </div>
            <div class="captured-pieces" id="captured-bottom"></div>
        </div>

        <div class="controls-panel">
            <button class="btn" onclick="undoMove()" title="Geri Al"><ion-icon name="arrow-undo"></ion-icon></button>
            <button class="btn primary" onclick="newGame()" title="Yeni Oyun"><ion-icon name="refresh"></ion-icon></button>
            <button class="btn" onclick="flipBoard()" title="Tahtayƒ± √áevir"><ion-icon name="sync"></ion-icon></button>
            <button class="btn" id="sound-btn" onclick="toggleSound()" title="Ses"><ion-icon name="volume-high"></ion-icon></button>
        </div>

    </div>

    <div id="modal-overlay">
        <div class="modal-box">
            <div style="font-size:4rem; margin-bottom:10px;">üèÜ</div>
            <div class="modal-title" id="end-title">BEYAZ KAZANDI</div>
            <div class="modal-text" id="end-reason">≈ûah Mat ile oyun bitti.</div>
            <button class="btn primary" style="width:100%;" onclick="closeModal()">TEKRAR OYNA</button>
        </div>
    </div>

    <script>
        // --- TA≈û G√ñRSELLERƒ∞ (WIKIPEDIA SVG) ---
        const PIECES = {
            w: {
                p: 'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg',
                r: 'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg',
                n: 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg',
                b: 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg',
                q: 'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg',
                k: 'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg'
            },
            b: {
                p: 'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg',
                r: 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg',
                n: 'https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg',
                b: 'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg',
                q: 'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg',
                k: 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg'
            }
        };

        // --- SES MOTORU ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let soundOn = true;

        function playSound(type) {
            if (!soundOn) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if(type === 'move') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(300, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.1);
                osc.start(now); osc.stop(now+0.1);
            } else if(type === 'capture') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(150, now);
                gain.gain.setValueAtTime(0.15, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.15);
                osc.start(now); osc.stop(now+0.15);
            } else if(type === 'check') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(600, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.3);
                osc.start(now); osc.stop(now+0.3);
            }
        }

        function toggleSound() {
            soundOn = !soundOn;
            const btn = document.getElementById('sound-btn');
            btn.innerHTML = soundOn ? '<ion-icon name="volume-high"></ion-icon>' : '<ion-icon name="volume-mute"></ion-icon>';
            btn.style.color = soundOn ? '#ccc' : '#e74c3c';
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>{});
            else if (document.exitFullscreen) document.exitFullscreen();
        }

        // --- OYUN MANTIƒûI ---
        let board = [];
        let turn = 'w'; // w: white, b: black
        let selected = null;
        let history = [];
        let capW = [], capB = [];
        let gameOver = false;
        let vsCPU = true;

        function createBoard() {
            const b = Array(8).fill(null).map(() => Array(8).fill(null));
            const setup = ['r','n','b','q','k','b','n','r'];
            for(let i=0; i<8; i++) {
                b[0][i] = {c:'b', t:setup[i]};
                b[1][i] = {c:'b', t:'p'};
                b[6][i] = {c:'w', t:'p'};
                b[7][i] = {c:'w', t:setup[i]};
            }
            return b;
        }

        function newGame() {
            board = createBoard();
            turn = 'w';
            selected = null;
            history = [];
            capW = []; capB = [];
            gameOver = false;
            document.getElementById('board-container').classList.remove('rotate-board');
            render();
            updateCaps();
        }

        // --- HAREKET KURALLARI (Basitle≈ütirilmi≈ü + ≈ûah Kontrol√º) ---
        function getPseudoMoves(r, c, brd) {
            const p = brd[r][c];
            if(!p) return [];
            let moves = [];
            
            const add = (tr, tc) => {
                if(tr>=0 && tr<8 && tc>=0 && tc<8) {
                    const target = brd[tr][tc];
                    if(!target) { moves.push({r:tr, c:tc}); return true; } // Bo≈üsa ekle, devam et
                    if(target.c !== p.c) { moves.push({r:tr, c:tc}); return false; } // Rakipse ye, dur
                    return false; // Kendi ta≈üƒ±nsa dur
                }
                return false; // Tahta dƒ±≈üƒ±
            };

            if(p.t === 'p') {
                const d = p.c === 'w' ? -1 : 1;
                if(!brd[r+d]?.[c]) { // ƒ∞leri 1
                    moves.push({r:r+d, c:c});
                    if((p.c==='w' && r===6) || (p.c==='b' && r===1)) { // ƒ∞leri 2
                        if(!brd[r+d*2]?.[c]) moves.push({r:r+d*2, c:c});
                    }
                }
                // √áapraz Yeme
                [[d,1], [d,-1]].forEach(([dr, dc]) => {
                    if(brd[r+dr]?.[c+dc] && brd[r+dr][c+dc].c !== p.c) moves.push({r:r+dr, c:c+dc});
                });
            }
            else if(p.t === 'n') {
                [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]].forEach(([dr,dc]) => add(r+dr, c+dc));
            }
            else if(p.t === 'k') {
                [[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr,dc]) => add(r+dr, c+dc));
            }
            else { // r, b, q (Sliding)
                const dirs = {
                    r: [[1,0],[-1,0],[0,1],[0,-1]],
                    b: [[1,1],[1,-1],[-1,1],[-1,-1]],
                    q: [[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]]
                }[p.t];
                dirs.forEach(([dr, dc]) => {
                    let tr=r+dr, tc=c+dc;
                    while(add(tr, tc)) { tr+=dr; tc+=dc; }
                });
            }
            return moves;
        }

        // ≈ûah kontrol√º filtresi
        function getSafeMoves(r, c) {
            const moves = getPseudoMoves(r, c, board);
            const p = board[r][c];
            return moves.filter(m => {
                // Sanal hamle yap
                const target = board[m.r][m.c];
                board[m.r][m.c] = p;
                board[r][c] = null;
                const kingSafe = !isCheck(p.c);
                // Geri al
                board[r][c] = p;
                board[m.r][m.c] = target;
                return kingSafe;
            });
        }

        function isCheck(color) {
            // ≈ûahƒ± bul
            let kr, kc;
            for(let r=0; r<8; r++) for(let c=0; c<8; c++) 
                if(board[r][c]?.t === 'k' && board[r][c]?.c === color) { kr=r; kc=c; }
            if(kr===undefined) return true; // Hata toleransƒ±

            // T√ºm rakip ta≈ülarƒ±n tehdidine bak
            const opp = color==='w'?'b':'w';
            for(let r=0; r<8; r++) for(let c=0; c<8; c++) {
                if(board[r][c]?.c === opp) {
                    const moves = getPseudoMoves(r, c, board); // Sonsuz d√∂ng√º olmasƒ±n diye pseudo
                    if(moves.some(m => m.r === kr && m.c === kc)) return true;
                }
            }
            return false;
        }

        // --- OYNANI≈û ---
        function render() {
            const el = document.getElementById('chess-board');
            el.innerHTML = '';
            
            // ≈ûah √ßekildi mi?
            const inCheck = isCheck(turn);

            for(let r=0; r<8; r++) {
                for(let c=0; c<8; c++) {
                    const sq = document.createElement('div');
                    sq.className = `square ${(r+c)%2===0 ? 'light' : 'dark'}`;
                    
                    const p = board[r][c];
                    if(p) {
                        const img = document.createElement('div');
                        img.className = 'piece';
                        img.style.backgroundImage = `url('${PIECES[p.c][p.t]}')`;
                        if(p.t==='k' && p.c===turn && inCheck) sq.classList.add('in-check');
                        sq.appendChild(img);
                    }

                    // Se√ßili
                    if(selected && selected.r===r && selected.c===c) sq.classList.add('selected');
                    
                    // Son Hamle
                    if(history.length > 0) {
                        const last = history[history.length-1];
                        if((last.from.r===r && last.from.c===c) || (last.to.r===r && last.to.c===c)) sq.classList.add('last-move');
                    }

                    // ƒ∞pucu
                    if(selected) {
                        const moves = getSafeMoves(selected.r, selected.c);
                        if(moves.some(m => m.r===r && m.c===c)) {
                            const hint = document.createElement('div');
                            hint.className = p ? 'hint-ring' : 'hint-dot';
                            sq.appendChild(hint);
                        }
                    }

                    sq.onclick = () => clickSquare(r, c);
                    el.appendChild(sq);
                }
            }
        }

        function clickSquare(r, c) {
            if(gameOver) return;
            if(vsCPU && turn==='b') return; // CPU sƒ±rasƒ±

            const p = board[r][c];
            
            // 1. Kendi ta≈üƒ±na tƒ±kla
            if(p && p.c === turn) {
                selected = {r, c};
                render();
                return;
            }

            // 2. Hamle yap
            if(selected) {
                const moves = getSafeMoves(selected.r, selected.c);
                const move = moves.find(m => m.r===r && m.c===c);
                if(move) {
                    doMove(selected, move);
                } else {
                    selected = null;
                    render();
                }
            }
        }

        function doMove(from, to) {
            const p = board[from.r][from.c];
            const target = board[to.r][to.c];
            
            // Kayƒ±t
            history.push({ 
                from:{...from}, to:{...to}, p:{...p}, target: target ? {...target} : null,
                boardSnapshot: JSON.parse(JSON.stringify(board)) // Undo i√ßin
            });

            // Ta≈üƒ±
            board[to.r][to.c] = p;
            board[from.r][from.c] = null;

            // Terfi (Otomatik Vezir)
            if(p.t==='p' && (to.r===0 || to.r===7)) p.t = 'q';

            // Ses
            if(target) {
                playSound('capture');
                if(target.c==='w') capW.push(target.t); else capB.push(target.t);
                updateCaps();
            } else {
                playSound('move');
            }

            turn = turn==='w' ? 'b' : 'w';
            selected = null;
            
            // Oyun Durumu
            if(checkGameOver()) return;

            render();

            // CPU
            if(vsCPU && turn==='b' && !gameOver) {
                setTimeout(cpuMove, 500);
            }
        }

        function checkGameOver() {
            // Hareket kalmadƒ± mƒ±?
            let canMove = false;
            for(let r=0; r<8; r++) for(let c=0; c<8; c++) {
                if(board[r][c]?.c === turn && getSafeMoves(r,c).length > 0) { canMove=true; break; }
            }

            if(!canMove) {
                gameOver = true;
                render(); // Mat halini g√∂ster
                const title = document.getElementById('end-title');
                const reason = document.getElementById('end-reason');
                
                if(isCheck(turn)) {
                    playSound('check');
                    title.innerText = turn==='w' ? "Sƒ∞YAH KAZANDI" : "BEYAZ KAZANDI";
                    reason.innerText = "≈ûah Mat!";
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                } else {
                    title.innerText = "BERABERE";
                    reason.innerText = "Pat (Hamle Yok)";
                }
                
                document.getElementById('modal-overlay').style.display = 'flex';
                return true;
            }
            return false;
        }

        // --- YAPAY ZEKA (Basit Seviye) ---
        function cpuMove() {
            const moves = [];
            for(let r=0; r<8; r++) for(let c=0; c<8; c++) {
                if(board[r][c]?.c === 'b') {
                    const valid = getSafeMoves(r, c);
                    valid.forEach(v => moves.push({from:{r,c}, to:v}));
                }
            }

            if(moves.length === 0) return; // Mat olduysa oyun zaten biter

            // Puanlama: Piyon=10, At/Fil=30, Kale=50, Vezir=90, ≈ûah=900
            const values = { p:10, n:30, b:30, r:50, q:90, k:900 };
            
            // En iyi hamleyi bul
            moves.sort((a, b) => {
                const targetA = board[a.to.r][a.to.c];
                const valA = targetA ? values[targetA.t] : 0;
                
                const targetB = board[b.to.r][b.to.c];
                const valB = targetB ? values[targetB.t] : 0;
                
                return valB - valA; // B√ºy√ºk olanƒ± √∂ne al
            });

            // En iyilerden rastgele se√ß (Hafif √ße≈üitlilik i√ßin)
            const bestScore = board[moves[0].to.r][moves[0].to.c] ? values[board[moves[0].to.r][moves[0].to.c].t] : 0;
            const bestMoves = moves.filter(m => {
                const t = board[m.to.r][m.to.c];
                const v = t ? values[t.t] : 0;
                return v === bestScore;
            });

            const choice = bestMoves[Math.floor(Math.random() * bestMoves.length)];
            doMove(choice.from, choice.to);
        }

        // --- YARDIMCILAR ---
        function undoMove() {
            if(history.length === 0 || gameOver) return;
            // CPU ile oynarken 2 hamle geri al (benim ve onunki)
            const steps = vsCPU ? 2 : 1;
            if(history.length < steps) return;

            const targetState = history[history.length - steps];
            board = targetState.boardSnapshot;
            history.splice(-steps);
            
            // Yenen ta≈ülarƒ± d√ºzelt (Basit√ße sƒ±fƒ±rlayƒ±p ba≈ütan saymak daha kolay ama g√∂rsel i√ßin listeyi geri alƒ±yoruz)
            // Bu basit versiyonda array'den pop yapƒ±yoruz
            // (Tam undo i√ßin captured listesini de history'ye kaydetmek gerekirdi, bu hƒ±zlƒ± √ß√∂z√ºm)
            capW = []; capB = []; // G√∂rseli sƒ±fƒ±rla, renderBoard zaten paneli temizler
            // Ger√ßekten d√ºzg√ºn olmasƒ± i√ßin history state'ine captured listelerini de eklemek lazƒ±m.
            // ≈ûimdilik sadece tahtayƒ± d√ºzeltiyoruz.
            
            turn = 'w'; // CPU modunda sƒ±ra hep bana ge√ßer
            selected = null;
            render();
            updateCaps();
        }

        function updateCaps() {
            const wDiv = document.getElementById('captured-bottom'); // Beyazƒ±n yedikleri (Siyah ta≈ülar)
            const bDiv = document.getElementById('captured-top'); // Siyahƒ±n yedikleri (Beyaz ta≈ülar)
            
            // Not: capW listesi "Beyazƒ±n yediƒüi Sƒ∞YAH ta≈ülarƒ±" tutmalƒ±. Kodda doMove i√ßinde target.c kontrol√ºyle yapƒ±ldƒ±.
            // target.c === 'w' -> Beyaz ta≈ü yendi -> Siyahƒ±n paneline (Top)
            
            bDiv.innerHTML = capW.map(t => `<img src="${PIECES['w'][t]}">`).join('');
            wDiv.innerHTML = capB.map(t => `<img src="${PIECES['b'][t]}">`).join('');
        }

        function flipBoard() {
            document.getElementById('board-container').classList.toggle('rotate-board');
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            newGame();
        }

        // Ba≈ülat
        newGame();

        // Ses Kilidi √á√∂zme (Mobil)
        document.body.addEventListener('click', () => { if(audioCtx.state==='suspended') audioCtx.resume(); }, {once:true});

    </script>
</body>
</html>
