<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Okul Ligi Pro - AI Destekli</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .glass-panel { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body class="bg-slate-50">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, query, orderBy, limit, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // =================================================================
        // FIREBASE AYARLARI
        // =================================================================
        const yourFirebaseConfig = {
            apiKey: "BURAYA_API_KEY_YAPISTIR", 
            authDomain: "sekilli-totem-481514-c5.firebaseapp.com",
            projectId: "sekilli-totem-481514-c5",
            storageBucket: "sekilli-totem-481514-c5.firebasestorage.app",
            messagingSenderId: "519295049418",
            appId: "BURAYA_APP_ID_YAPISTIR" 
        };

        // --- ICONS ---
        const Icon = ({ path, className, color }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={{ color }}>
                {path}
            </svg>
        );

        const Icons = {
            Trophy: (props) => <Icon {...props} path={<><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></>} />,
            Users: (props) => <Icon {...props} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />,
            Brain: (props) => <Icon {...props} path={<><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></>} />,
            Swords: (props) => <Icon {...props} path={<><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" x2="19" y1="19" y2="13"/><line x1="16" x2="20" y1="16" y2="20"/><line x1="19" x2="21" y1="21" y2="19"/><polyline points="14.5 6.5 18 3 21 3 21 6 17.5 9.5"/><line x1="5" x2="9" y1="14" y2="18"/><line x1="7" x2="4" y1="17" y2="20"/><line x1="3" x2="5" y1="19" y2="21"/></>} />,
            Sparkles: (props) => <Icon {...props} path={<><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 17v4"/><path d="M3 21l6-6"/></>} />,
            Play: (props) => <Icon {...props} path={<polygon points="5 3 19 12 5 21 5 3"/>} />,
            Flame: (props) => <Icon {...props} path={<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>} />,
            Zap: (props) => <Icon {...props} path={<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>} />,
            RefreshCw: (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></>} />,
            Star: (props) => <Icon {...props} path={<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>} />,
            MessageCircle: (props) => <Icon {...props} path={<path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>} />,
        };

        const { useState, useEffect, useRef } = React;

        // --- SES EFEKTLERİ ---
        const playSound = (type) => {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            const now = ctx.currentTime;
            
            if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, now);
                osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(now); osc.stop(now + 0.5);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(now); osc.stop(now + 0.5);
            } else if (type === 'joker') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.linearRampToValueAtTime(800, now + 0.1);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(now); osc.stop(now + 0.5);
            }
        };

        // --- YEREL SORU BANKASI ---
        const generateLocalQuestion = (grade) => {
            const subjects = ['Matematik', 'Türkçe', 'Fen Bilimleri', 'Sosyal/Hayat'];
            const subject = subjects[Math.floor(Math.random() * subjects.length)];
            let q = { text: '', options: [], correct: 0, subject };

            if (subject === 'Matematik') {
                const operation = Math.random();
                let a, b, ans;
                if (grade <= 2) {
                    a = Math.floor(Math.random() * 20) + 1;
                    b = Math.floor(Math.random() * 20) + 1;
                    if (operation > 0.5) { q.text = `${a} + ${b} = ?`; ans = a + b; }
                    else { q.text = `${Math.max(a, b)} - ${Math.min(a, b)} = ?`; ans = Math.max(a, b) - Math.min(a, b); }
                } else {
                    a = Math.floor(Math.random() * 10) + 2;
                    b = Math.floor(Math.random() * 10) + 2;
                    if (operation > 0.5) { q.text = `${a} x ${b} = ?`; ans = a * b; }
                    else { let res = a * b; q.text = `${res} ÷ ${a} = ?`; ans = b; }
                }
                let options = [ans];
                while (options.length < 4) {
                    let fake = ans + Math.floor(Math.random() * 10) - 5;
                    if (fake !== ans && fake >= 0 && !options.includes(fake)) options.push(fake);
                }
                q.options = options.sort(() => Math.random() - 0.5);
                q.correct = q.options.indexOf(ans);
            } else {
                const templates = [
                    { t: "İstiklal Marşı'mızın şairi kimdir?", o: ["Mehmet Akif Ersoy", "Ömer Seyfettin", "Ziya Gökalp", "Namık Kemal"], c: 0, s: "Türkçe" },
                    { t: "Hangisi bir duyu organımız değildir?", o: ["Kalp", "Göz", "Kulak", "Deri"], c: 0, s: "Fen Bilimleri" },
                    { t: "Türkiye'nin başkenti neresidir?", o: ["Ankara", "İstanbul", "İzmir", "Konya"], c: 0, s: "Sosyal/Hayat" },
                    { t: "Bir deste kaç tanedir?", o: ["10", "12", "20", "5"], c: 0, s: "Matematik" },
                    { t: "Hangisi yaz mevsimi ayıdır?", o: ["Temmuz", "Ocak", "Mart", "Ekim"], c: 0, s: "Sosyal/Hayat" },
                    { t: "Dünyamızın şekli neye benzer?", o: ["Küre", "Küp", "Üçgen", "Düz Tepsi"], c: 0, s: "Fen Bilimleri" },
                    { t: "'Beyaz' kelimesinin eş anlamlısı nedir?", o: ["Ak", "Kara", "Al", "Sarı"], c: 0, s: "Türkçe" },
                ];
                const selected = templates[Math.floor(Math.random() * templates.length)];
                q.text = selected.t;
                q.options = selected.o;
                q.correct = selected.c;
                q.subject = selected.s;
            }
            return q;
        };

        // --- GEMINI SORU ÜRETME ---
        const fetchGeminiQuestion = async (apiKey, grade, customTopic) => {
            if (!apiKey) return null;
            
            // Konu belirleme mantığı: Eğer özel konu varsa onu kullan, yoksa genel.
            const topicPrompt = customTopic 
                ? `"${customTopic}" konusunda` 
                : 'Matematik, Türkçe, Fen veya Sosyal derslerinden rastgele birinden';

            const prompt = `Sen bir öğretmensin. ${grade}. Sınıf seviyesine uygun, ${topicPrompt}, daha önce sormadığın, özgün bir ÇOKTAN SEÇMELİ soru hazırla. JSON formatı: {"text": "soru", "options": ["A", "B", "C", "D"], "correctIndex": 0, "subject": "ders"}`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const rawText = data.candidates[0].content.parts[0].text;
                const jsonString = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                const parsed = JSON.parse(jsonString);
                return { text: parsed.text, options: parsed.options, correct: parsed.correctIndex, subject: parsed.subject };
            } catch (e) { return null; }
        };

        // --- GEMINI AÇIKLAMA ÜRETME (YENİ ÖZELLİK) ---
        const fetchGeminiExplanation = async (apiKey, questionText, correctOption) => {
            if (!apiKey) return "API Anahtarı eksik, açıklama yapılamıyor.";
            
            const prompt = `Sen sevecen ve bilge bir öğretmensin. Şu soruya 1-2 cümlelik, öğrencilerin anlayacağı kısa ve net bir açıklama yap. Sorunun cevabının neden "${correctOption}" olduğunu açıkla. Soru: "${questionText}".`;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) { return "Açıklama yüklenirken bir hata oluştu."; }
        };

        function OkulLigiApp() {
            // --- INIT ---
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [appId, setAppId] = useState('school-league-v1');
            const [firebaseActive, setFirebaseActive] = useState(false);

            useEffect(() => {
                let configToUse = null;
                if (window.__firebase_config) {
                    configToUse = JSON.parse(window.__firebase_config);
                } else if (yourFirebaseConfig.apiKey !== "BURAYA_API_KEY_YAPISTIR") {
                    configToUse = yourFirebaseConfig;
                }

                if (configToUse) {
                    try {
                        const app = initializeApp(configToUse);
                        const auth = getAuth(app);
                        const firestore = getFirestore(app);
                        setDb(firestore);
                        setAppId(window.__app_id || 'school-league-v1');

                        const initAuth = async () => {
                            if (window.__initial_auth_token) {
                                await signInWithCustomToken(auth, window.__initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        };
                        initAuth();
                        onAuthStateChanged(auth, (u) => {
                            setUser(u);
                            setFirebaseActive(true);
                        });
                    } catch (err) {
                        console.error("Firebase Hatası:", err);
                    }
                }
            }, []);

            // --- STATE ---
            const [phase, setPhase] = useState('setup'); 
            const [grade, setGrade] = useState(5);
            const [apiKey, setApiKey] = useState('');
            const [rawNames, setRawNames] = useState('');
            const [customTopic, setCustomTopic] = useState(''); // YENİ: Özel Konu
            const [matches, setMatches] = useState([]);
            const [currentMatchIndex, setCurrentMatchIndex] = useState(0);
            const [leaderboardData, setLeaderboardData] = useState([]);
            const [seenQuestions, setSeenQuestions] = useState(new Set());

            // Battle State
            const [p1Score, setP1Score] = useState(0);
            const [p2Score, setP2Score] = useState(0);
            const [p1Streak, setP1Streak] = useState(0);
            const [p2Streak, setP2Streak] = useState(0);
            const [p1JokerUsed, setP1JokerUsed] = useState(false);
            const [p2JokerUsed, setP2JokerUsed] = useState(false);
            const [currentQuestion, setCurrentQuestion] = useState(null);
            const [loadingQ, setLoadingQ] = useState(false);
            const [answerState, setAnswerState] = useState('waiting');
            const [timer, setTimer] = useState(20);
            const [hiddenOptions, setHiddenOptions] = useState([]);
            
            // YENİ: Açıklama State'leri
            const [explanation, setExplanation] = useState(null);
            const [loadingExplanation, setLoadingExplanation] = useState(false);
            const [showNextButton, setShowNextButton] = useState(false);

            // --- LEADERBOARD LISTENER ---
            useEffect(() => {
                if (!user || !db) return;
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'scores');
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = [];
                    snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
                    setLeaderboardData(data);
                }, (error) => console.error("Data fetch error:", error));
                return () => unsubscribe();
            }, [user, db, appId]);

            const saveWinnerToCloud = async (winnerName, score) => {
                if (!user || !db) return;
                const studentId = `${winnerName}-${grade}`.replace(/\s+/g, '-').toLowerCase();
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'scores', studentId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        await updateDoc(docRef, { score: increment(score), wins: increment(1), lastPlayed: new Date().toISOString() });
                    } else {
                        await setDoc(docRef, { name: winnerName, grade: grade, score: score, wins: 1, lastPlayed: new Date().toISOString() });
                    }
                } catch (e) { console.error("Save error:", e); }
            };

            const handleCreateMatches = () => {
                const names = rawNames.split('\n').map(n => n.trim()).filter(n => n.length > 0);
                if (names.length < 2) return alert("En az 2 öğrenci gerekli.");
                const shuffled = [...names].sort(() => Math.random() - 0.5);
                const newMatches = [];
                for (let i = 0; i < shuffled.length; i += 2) {
                    if (i + 1 < shuffled.length) newMatches.push({ p1: shuffled[i], p2: shuffled[i+1], winner: null });
                    else newMatches.push({ p1: shuffled[i], p2: "BAY (Otomatik)", winner: shuffled[i] });
                }
                setMatches(newMatches);
                setPhase('bracket');
            };

            const startMatch = (index) => {
                if (matches[index].p2.includes("BAY")) return;
                setCurrentMatchIndex(index);
                setP1Score(0); setP2Score(0);
                setP1Streak(0); setP2Streak(0);
                setP1JokerUsed(false); setP2JokerUsed(false);
                setPhase('battle');
                loadNewQuestion();
            };

            const loadNewQuestion = async () => {
                setLoadingQ(true);
                setAnswerState('waiting');
                setHiddenOptions([]);
                setExplanation(null);
                setLoadingExplanation(false);
                setShowNextButton(false);
                setTimer(20);

                let q = null;
                let attempts = 0;
                const maxAttempts = 3;

                while (attempts < maxAttempts) {
                    if (apiKey) {
                        q = await fetchGeminiQuestion(apiKey, grade, customTopic); // Özel konu gönderiliyor
                    } else {
                        q = generateLocalQuestion(grade);
                    }

                    if (q && !seenQuestions.has(q.text)) {
                        break;
                    }
                    attempts++;
                }
                
                if (q) {
                    setSeenQuestions(prev => new Set(prev).add(q.text));
                    setCurrentQuestion(q);
                }
                
                setLoadingQ(false);
            };

            // YENİ: Açıklama Al Fonksiyonu
            const handleGetExplanation = async () => {
                if (!apiKey) return alert("Açıklama için API Anahtarı gereklidir.");
                setLoadingExplanation(true);
                const correctText = currentQuestion.options[currentQuestion.correct];
                const exp = await fetchGeminiExplanation(apiKey, currentQuestion.text, correctText);
                setExplanation(exp);
                setLoadingExplanation(false);
            };

            useEffect(() => {
                let interval;
                if (phase === 'battle' && answerState === 'waiting' && timer > 0) interval = setInterval(() => setTimer(t => t - 1), 1000);
                else if (timer === 0 && answerState === 'waiting') { setAnswerState('timeout'); playSound('wrong'); setShowNextButton(true); }
                return () => clearInterval(interval);
            }, [timer, phase, answerState]);

            const useJoker = (player) => {
                if ((player === 'p1' && p1JokerUsed) || (player === 'p2' && p2JokerUsed)) return;
                if (answerState !== 'waiting' || !currentQuestion) return;
                const wrongIndices = currentQuestion.options.map((_, idx) => idx).filter(idx => idx !== currentQuestion.correct);
                const toHide = wrongIndices.sort(() => Math.random() - 0.5).slice(0, 2);
                setHiddenOptions(toHide);
                playSound('joker');
                if (player === 'p1') setP1JokerUsed(true);
                else setP2JokerUsed(true);
            };

            const handleAnswer = (optionIndex, player) => {
                if (answerState !== 'waiting') return;
                const isCorrect = optionIndex === currentQuestion.correct;
                
                setShowNextButton(true); // Cevap verilince sonraki soru butonu aktif olur (açıklama okumak için zaman kazanılır)

                if (isCorrect) {
                    setAnswerState('correct'); playSound('correct');
                    const multiplier = player === 'p1' ? (p1Streak >= 2 ? 2 : 1) : (p2Streak >= 2 ? 2 : 1);
                    const points = 10 * multiplier;
                    if (player === 'p1') { setP1Score(s => s + points); setP1Streak(s => s + 1); setP2Streak(0); }
                    else { setP2Score(s => s + points); setP2Streak(s => s + 1); setP1Streak(0); }
                } else {
                    setAnswerState('wrong'); playSound('wrong');
                    if (player === 'p1') setP1Streak(0);
                    else setP2Streak(0);
                }
            };

            const nextQuestionOrFinish = () => {
                const currentP1 = p1Score;
                const currentP2 = p2Score;
                // Kazanma koşulu 60 puan
                if (currentP1 >= 60 || currentP2 >= 60) {
                    const winner = currentP1 > currentP2 ? matches[currentMatchIndex].p1 : matches[currentMatchIndex].p2;
                    const wScore = Math.max(currentP1, currentP2);
                    saveWinnerToCloud(winner, wScore);
                    const updatedMatches = [...matches];
                    updatedMatches[currentMatchIndex].winner = winner;
                    setMatches(updatedMatches);
                    setPhase('bracket');
                } else {
                    loadNewQuestion();
                }
            };

            // --- RENDER ---
            const renderSetup = () => (
                <div className="max-w-3xl mx-auto bg-white p-8 rounded-3xl shadow-2xl mt-10">
                    <div className="text-center mb-10">
                        <h1 className="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-4 flex items-center justify-center gap-4">
                            <Icons.Brain className="w-12 h-12 text-blue-600" /> Okul Ligi Pro
                        </h1>
                        <p className="text-gray-500 text-lg">AI Destekli Bilgi Yarışması</p>
                    </div>
                    <div className="grid md:grid-cols-2 gap-8">
                        <div className="space-y-6">
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">Sınıf Seviyesi</label>
                                <select value={grade} onChange={(e) => setGrade(Number(e.target.value))} className="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                                    {[1,2,3,4,5,6,7,8].map(g => <option key={g} value={g}>{g}. Sınıf</option>)}
                                </select>
                            </div>
                            
                            {/* YENİ: ÖZEL KONU GİRİŞİ */}
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                    <Icons.Sparkles className="w-4 h-4 text-purple-600" /> Özel Konu (İsteğe Bağlı)
                                </label>
                                <input 
                                    type="text" 
                                    value={customTopic} 
                                    onChange={(e) => setCustomTopic(e.target.value)} 
                                    placeholder="Örn: Fotosentez, Kesirler..." 
                                    className="w-full p-4 bg-purple-50 border border-purple-200 rounded-xl outline-none focus:ring-purple-500 placeholder-purple-300" 
                                />
                                <p className="text-xs text-gray-400 mt-1">Boş bırakırsanız tüm derslerden karışık sorar.</p>
                            </div>

                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                    <Icons.Sparkles className="w-4 h-4 text-purple-500" /> Gemini API
                                </label>
                                <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="AI-..." className="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-purple-500" />
                            </div>
                            <button onClick={() => setPhase('leaderboard')} className="w-full py-4 bg-orange-100 text-orange-700 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-orange-200 transition-colors">
                                <Icons.Trophy className="w-5 h-5" /> SIRALAMALARI GÖR
                            </button>
                        </div>
                        <div className="space-y-4">
                            <label className="block text-sm font-bold text-gray-700">Öğrenci Listesi</label>
                            <textarea rows={8} className="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="Ali Yılmaz&#10;Ayşe Can&#10;..." value={rawNames} onChange={(e) => setRawNames(e.target.value)} />
                            <button onClick={handleCreateMatches} className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transform hover:-translate-y-1 transition-all flex items-center justify-center gap-2">
                                <Icons.Swords className="w-6 h-6" /> TURNUVAYI BAŞLAT
                            </button>
                        </div>
                    </div>
                </div>
            );

            const renderLeaderboard = () => {
                const schoolRank = [...leaderboardData].sort((a, b) => b.score - a.score).slice(0, 10);
                const classRank = [...leaderboardData].filter(d => d.grade === grade).sort((a, b) => b.score - a.score);
                return (
                    <div className="max-w-5xl mx-auto p-6">
                        <div className="flex justify-between items-center mb-8">
                            <h2 className="text-3xl font-bold text-gray-800 flex items-center gap-3"><Icons.Trophy className="text-yellow-500 w-8 h-8" /> Liderlik Tablosu</h2>
                            <button onClick={() => setPhase('setup')} className="bg-gray-200 px-6 py-2 rounded-full font-bold hover:bg-gray-300 transition">Geri Dön</button>
                        </div>
                        <div className="grid md:grid-cols-2 gap-8">
                            <div className="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-yellow-400">
                                <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-yellow-600"><Icons.Star className="fill-yellow-500" /> Okul Geneli Top 10</h3>
                                <div className="space-y-3">
                                    {schoolRank.map((s, i) => (
                                        <div key={i} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                            <div className="flex items-center gap-3"><span className={`w-8 h-8 flex items-center justify-center rounded-full font-bold ${i < 3 ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-200 text-gray-600'}`}>{i+1}</span><div><div className="font-bold">{s.name}</div><div className="text-xs text-gray-500">{s.grade}. Sınıf</div></div></div>
                                            <div className="text-right"><div className="font-bold text-blue-600">{s.score} P</div><div className="text-xs text-gray-400">{s.wins} Galibiyet</div></div>
                                        </div>
                                    ))}
                                    {schoolRank.length === 0 && <p className="text-center text-gray-400 py-4">Veri yok veya Firebase bağlı değil.</p>}
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-blue-400">
                                <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-blue-600"><Icons.Users /> {grade}. Sınıf Sıralaması</h3>
                                <div className="space-y-3">
                                    {classRank.map((s, i) => (
                                        <div key={i} className="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                                            <div className="flex items-center gap-3"><span className="font-bold text-blue-800 w-6">{i+1}.</span><div className="font-bold">{s.name}</div></div>
                                            <div className="font-bold text-blue-600">{s.score} P</div>
                                        </div>
                                    ))}
                                    {classRank.length === 0 && <p className="text-center text-gray-400 py-4">Veri yok.</p>}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderBattle = () => {
                const m = matches[currentMatchIndex];
                if (!m) return null;
                return (
                    <div className="h-screen flex flex-col bg-slate-900 text-white overflow-hidden">
                        <div className="h-24 bg-slate-800 flex items-center justify-between px-8 border-b border-slate-700 shadow-lg z-10">
                            <div className="flex items-center gap-4 w-1/3">
                                <div className={`flex flex-col items-start ${p1Streak >= 2 ? 'animate-pulse' : ''}`}>
                                    <h3 className="text-2xl font-bold text-blue-400 flex items-center gap-2">{m.p1} {p1Streak >= 2 && <Icons.Flame className="text-orange-500 fill-orange-500 animate-bounce" />}</h3>
                                    <div className="flex items-center gap-2"><span className="text-4xl font-mono">{p1Score}</span>{p1Streak >= 2 && <span className="text-xs bg-orange-500 text-black px-2 py-1 rounded-full font-bold">x2 COMBO</span>}</div>
                                </div>
                                <button onClick={() => useJoker('p1')} disabled={p1JokerUsed} className={`p-2 rounded-lg border-2 ${p1JokerUsed ? 'border-gray-600 text-gray-600 opacity-30' : 'border-blue-500 text-blue-400 hover:bg-blue-900'}`} title="50/50 Jokeri"><Icons.Zap className="w-6 h-6" /></button>
                            </div>
                            <div className="flex flex-col items-center"><div className={`text-5xl font-black ${timer < 5 ? 'text-red-500 scale-110' : 'text-yellow-400'} transition-all`}>{timer}</div></div>
                            <div className="flex items-center gap-4 w-1/3 justify-end">
                                <button onClick={() => useJoker('p2')} disabled={p2JokerUsed} className={`p-2 rounded-lg border-2 ${p2JokerUsed ? 'border-gray-600 text-gray-600 opacity-30' : 'border-red-500 text-red-400 hover:bg-red-900'}`} title="50/50 Jokeri"><Icons.Zap className="w-6 h-6" /></button>
                                <div className={`flex flex-col items-end ${p2Streak >= 2 ? 'animate-pulse' : ''}`}>
                                    <h3 className="text-2xl font-bold text-red-400 flex items-center gap-2">{p2Streak >= 2 && <Icons.Flame className="text-orange-500 fill-orange-500 animate-bounce" />} {m.p2}</h3>
                                    <div className="flex items-center gap-2">{p2Streak >= 2 && <span className="text-xs bg-orange-500 text-black px-2 py-1 rounded-full font-bold">x2 COMBO</span>}<span className="text-4xl font-mono">{p2Score}</span></div>
                                </div>
                            </div>
                        </div>
                        <div className="flex-1 flex items-center justify-center p-6 relative">
                            {loadingQ ? <div className="animate-spin"><Icons.RefreshCw className="w-20 h-20 text-blue-500 opacity-50" /></div> : currentQuestion ? (
                                <div className="w-full max-w-5xl flex flex-col gap-6">
                                    <div className="glass-panel p-8 rounded-3xl shadow-2xl text-center relative">
                                        <span className="absolute top-4 right-4 bg-purple-600 text-white px-4 py-1 rounded-full text-sm font-bold tracking-wider uppercase shadow-lg">{customTopic || currentQuestion.subject}</span>
                                        <h2 className="text-3xl md:text-5xl font-bold mt-4 leading-snug drop-shadow-lg">{currentQuestion.text}</h2>
                                    </div>
                                    <div className="grid grid-cols-2 gap-6">
                                        {currentQuestion.options.map((opt, idx) => {
                                            let btnClass = "bg-slate-800 hover:bg-slate-700 border-2 border-slate-600";
                                            if (answerState !== 'waiting') {
                                                if (idx === currentQuestion.correct) btnClass = "bg-green-600 border-green-400 scale-105 shadow-[0_0_30px_rgba(34,197,94,0.5)]";
                                                else btnClass = "bg-slate-800 opacity-30 grayscale";
                                            }
                                            if (hiddenOptions.includes(idx)) return <div key={idx} className="bg-transparent"></div>;
                                            return <div key={idx} className={`p-6 rounded-2xl text-2xl font-bold transition-all transform duration-300 text-center flex items-center justify-center min-h-[100px] text-white shadow-xl ${btnClass}`}>{opt}</div>;
                                        })}
                                    </div>

                                    {/* AI EXPLANATION AREA */}
                                    {showNextButton && (
                                        <div className="flex flex-col items-center gap-4 animate-fadeIn">
                                            <div className="flex gap-4">
                                                {/* YENİ: AÇIKLAMA BUTONU */}
                                                {!explanation && apiKey && (
                                                    <button 
                                                        onClick={handleGetExplanation}
                                                        disabled={loadingExplanation}
                                                        className="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-full font-bold flex items-center gap-2 shadow-lg transition-all"
                                                    >
                                                        {loadingExplanation ? <Icons.RefreshCw className="animate-spin"/> : <Icons.MessageCircle />}
                                                        {loadingExplanation ? "AI Öğretmene Soruluyor..." : "✨ Cevabı Açıkla"}
                                                    </button>
                                                )}
                                                <button onClick={nextQuestionOrFinish} className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-full font-bold shadow-lg flex items-center gap-2">
                                                    Sonraki Soru <Icons.Play className="w-4 h-4" />
                                                </button>
                                            </div>

                                            {/* Açıklama Metni */}
                                            {explanation && (
                                                <div className="bg-purple-900/80 border border-purple-500/50 p-6 rounded-2xl max-w-3xl text-center">
                                                    <h4 className="text-purple-300 font-bold mb-2 flex items-center justify-center gap-2"><Icons.Sparkles className="w-4 h-4"/> AI Öğretmen Diyor ki:</h4>
                                                    <p className="text-white text-lg leading-relaxed">{explanation}</p>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* TEACHER CONTROLS */}
                                    <div className="mt-4 flex justify-between items-center opacity-60 hover:opacity-100 transition-opacity">
                                        <div className="bg-blue-900/50 p-3 rounded-xl border border-blue-500/30">
                                            <p className="text-blue-300 text-[10px] mb-1 font-bold uppercase tracking-widest text-center">Öğretmen: {m.p1}</p>
                                            <div className="flex gap-2">{["A", "B", "C", "D"].map((l, i) => (<button key={i} disabled={answerState !== 'waiting' || hiddenOptions.includes(i)} onClick={() => handleAnswer(i, 'p1')} className="w-10 h-10 bg-blue-600 hover:bg-blue-500 rounded font-bold text-lg shadow disabled:opacity-20">{l}</button>))}</div>
                                        </div>
                                        
                                        {!showNextButton && (
                                            <div className="text-center">
                                                {answerState === 'wrong' && <div className="text-red-500 text-4xl font-black animate-shake">YANLIŞ!</div>}
                                                {answerState === 'timeout' && <div className="text-yellow-500 text-4xl font-black">ZAMAN DOLDU</div>}
                                            </div>
                                        )}

                                        <div className="bg-red-900/50 p-3 rounded-xl border border-red-500/30">
                                            <p className="text-red-300 text-[10px] mb-1 font-bold uppercase tracking-widest text-center">Öğretmen: {m.p2}</p>
                                            <div className="flex gap-2">{["A", "B", "C", "D"].map((l, i) => (<button key={i} disabled={answerState !== 'waiting' || hiddenOptions.includes(i)} onClick={() => handleAnswer(i, 'p2')} className="w-10 h-10 bg-red-600 hover:bg-red-500 rounded font-bold text-lg shadow disabled:opacity-20">{l}</button>))}</div>
                                        </div>
                                    </div>
                                </div>
                            ) : null}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen">
                    {phase === 'bracket' && (
                        <div className="max-w-6xl mx-auto p-6">
                            <div className="flex justify-between items-center mb-8">
                                <h2 className="text-3xl font-bold text-gray-800">Fikstür</h2>
                                <div className="flex gap-4">
                                    <button onClick={() => setPhase('leaderboard')} className="flex items-center gap-2 text-blue-600 font-bold bg-blue-100 px-4 py-2 rounded-lg hover:bg-blue-200"><Icons.Trophy size={18}/> Sıralama</button>
                                    <button onClick={() => setPhase('setup')} className="text-gray-500 hover:text-red-500 font-medium">Yeni Yarışma</button>
                                </div>
                            </div>
                            <div className="grid md:grid-cols-2 gap-6">
                                {matches.map((m, idx) => (
                                    <div key={idx} className={`relative bg-white p-6 rounded-2xl shadow-lg border-l-8 ${m.winner ? 'border-green-500 bg-green-50' : 'border-blue-500'} flex items-center justify-between transition-transform hover:scale-[1.01]`}>
                                        <div className="flex-1 grid grid-cols-[1fr,auto,1fr] items-center gap-4 text-center">
                                            <div className={`font-bold text-lg ${m.winner === m.p1 ? 'text-green-700' : 'text-gray-700'}`}>{m.p1} {m.winner === m.p1 && <Icons.Trophy className="inline w-4 h-4 text-yellow-500"/>}</div>
                                            <div className="bg-gray-200 text-gray-500 text-xs font-bold px-2 py-1 rounded">VS</div>
                                            <div className={`font-bold text-lg ${m.winner === m.p2 ? 'text-green-700' : 'text-gray-700'}`}>{m.p2} {m.winner === m.p2 && <Icons.Trophy className="inline w-4 h-4 text-yellow-500"/>}</div>
                                        </div>
                                        {!m.winner && !m.p2.includes("BAY") && <button onClick={() => startMatch(idx)} className="ml-4 bg-blue-600 text-white p-4 rounded-full hover:bg-blue-700 shadow-xl hover:scale-110 transition-all group"><Icons.Play className="w-6 h-6 ml-1 group-hover:animate-pulse" /></button>}
                                        {m.winner && <div className="ml-4 text-green-600 font-bold bg-green-200 px-3 py-1 rounded-full text-xs">BİTTİ</div>}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    {phase === 'setup' && renderSetup()}
                    {phase === 'leaderboard' && renderLeaderboard()}
                    {phase === 'battle' && renderBattle()}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<OkulLigiApp />);
    </script>
</body>
</html>
