<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitap Okuma Modu</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; padding: 0; background-color: #1e293b; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* KAPAT BUTONU */
        .close-btn { position: absolute; top: 20px; right: 20px; color: white; font-size: 2rem; text-decoration: none; z-index: 100; cursor: pointer; opacity: 0.8; }
        .close-btn:hover { opacity: 1; transform: scale(1.1); }

        /* KİTAP ALANI */
        .book-stage { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; padding: 20px; }
        
        .page-card { width: 100%; max-width: 500px; height: 80vh; background: white; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; overflow: hidden; position: relative; animation: pageIn 0.5s ease-out; }
        @keyframes pageIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* RESİM ALANI */
        .page-image-area { flex: 3; background: #f1f5f9; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .page-image-area img { width: 100%; height: 100%; object-fit: contain; }
        .no-img { color: #94a3b8; font-size: 0.9rem; }

        /* YAZI ALANI */
        .page-text-area { flex: 2; padding: 25px; overflow-y: auto; font-size: 1.25rem; line-height: 1.6; color: #334155; text-align: center; display: flex; align-items: center; justify-content: center; }

        /* BUTONLAR */
        .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; transition: 0.3s; z-index: 50; }
        .nav-btn:hover { background: white; color: #1e293b; }
        .prev-btn { left: 20px; }
        .next-btn { right: 20px; }

        /* SAYFA NUMARASI */
        .page-num { position: absolute; bottom: 20px; width: 100%; text-align: center; color: rgba(255,255,255,0.5); font-size: 0.9rem; font-weight: bold; pointer-events: none; }

        /* YÜKLENİYOR */
        #loader { color: white; font-size: 1.2rem; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.2); border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <a href="index.html" class="close-btn" title="Kapat">&times;</a>

    <div class="book-stage" id="stage">
        <div id="loader">
            <div class="spinner"></div>
            <div>Kitap Açılıyor...</div>
        </div>
    </div>

    <div class="nav-btn prev-btn" onclick="sayfaDegis(-1)"><i class="fas fa-chevron-left"></i></div>
    <div class="nav-btn next-btn" onclick="sayfaDegis(1)"><i class="fas fa-chevron-right"></i></div>

    <div class="page-num" id="page-indicator"></div>

    <script>
        const db = firebase.firestore();
        let pages = [];
        let currentIndex = 0;

        // URL'den Kitap ID'sini al
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('id');

        if(!bookId) {
            document.getElementById('stage').innerHTML = "<div style='color:white;'>⚠️ Kitap bulunamadı.</div>";
        } else {
            // Veritabanından Kitabı Çek
            db.collection("dijital_kitaplar").doc(bookId).get().then(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    pages = data.sayfalar || [];
                    
                    if(pages.length > 0) {
                        renderPage();
                    } else {
                        document.getElementById('stage').innerHTML = "<div style='color:white;'>⚠️ Bu kitabın sayfası yok.</div>";
                    }
                } else {
                    document.getElementById('stage').innerHTML = "<div style='color:white;'>⚠️ Kitap silinmiş olabilir.</div>";
                }
            }).catch(err => {
                document.getElementById('stage').innerHTML = "<div style='color:white;'>Hata: " + err.message + "</div>";
            });
        }

        // Sayfayı Ekrana Bas
        function renderPage() {
            const pageData = pages[currentIndex];
            const stage = document.getElementById('stage');
            
            // Resim var mı kontrolü
            let imgHTML = '<div class="no-img">Resim Yok</div>';
            if(pageData.img && pageData.img.length > 2) {
                // Eğer tam link değilse (dosya adıysa) başına klasör yolu ekleyebiliriz ama şimdilik direkt basıyoruz
                imgHTML = `<img src="${pageData.img}" onerror="this.style.display='none'">`;
            }

            stage.innerHTML = `
                <div class="page-card">
                    <div class="page-image-area">${imgHTML}</div>
                    <div class="page-text-area">${pageData.text}</div>
                </div>
            `;

            document.getElementById('page-indicator').innerText = `Sayfa ${currentIndex + 1} / ${pages.length}`;
        }

        // İleri Geri Fonksiyonu
        function sayfaDegis(yon) {
            if(pages.length === 0) return;
            
            let yeniIndex = currentIndex + yon;

            // Sınırları Kontrol Et
            if(yeniIndex < 0) {
                alert("Başlangıçtasın!");
                return;
            }
            if(yeniIndex >= pages.length) {
                if(confirm("Kitap bitti! Ana sayfaya dönmek ister misin?")) {
                    window.location.href = "index.html";
                }
                return;
            }

            currentIndex = yeniIndex;
            renderPage();
        }

        // Klavye Yön Tuşları
        document.addEventListener('keydown', (e) => {
            if(e.key === "ArrowRight") sayfaDegis(1);
            if(e.key === "ArrowLeft") sayfaDegis(-1);
        });

    </script>
</body>
</html>
