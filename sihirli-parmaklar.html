<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sihirli Parmaklar Yazƒ± At√∂lyesi</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Konfeti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body {
            font-family: 'Lexend', sans-serif;
            background-color: #f0f9ff;
            overscroll-behavior: none;
            touch-action: none; /* Mobilde sayfa kaymasƒ±nƒ± engeller */
            user-select: none;
            -webkit-user-select: none;
        }
        
        .canvas-container {
            position: relative;
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            cursor: crosshair;
        }

        /* Arka Plan Desenleri */
        .bg-lined {
            background-size: 100% 70px;
            background-image: repeating-linear-gradient(0deg, transparent, transparent 68px, #94a3b8 69px, #94a3b8 70px);
            position: relative;
        }
        /* Kƒ±rmƒ±zƒ± kenar √ßizgisi */
        .bg-lined::before {
            content: '';
            position: absolute;
            left: 50px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #fca5a5;
            z-index: 5;
            pointer-events: none;
        }
        
        .bg-grid {
            background-size: 40px 40px;
            background-image: 
                linear-gradient(to right, #e2e8f0 1px, transparent 1px),
                linear-gradient(to bottom, #e2e8f0 1px, transparent 1px);
        }

        .bg-plain { background-image: none; }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        #guideCanvas { z-index: 10; pointer-events: none; }
        #drawingCanvas { z-index: 20; }

        /* ƒ∞mle√ßler */
        .cursor-draw { cursor: crosshair; }
        .cursor-move { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }

        .tool-btn {
            transition: all 0.2s;
        }
        .tool-btn:active { transform: scale(0.95); }
        .tool-btn.active {
            background-color: #dbeafe;
            border-color: #3b82f6;
            color: #1d4ed8;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }

        .pattern-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #2563eb;
        }

        .color-swatch {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .color-swatch.active {
            transform: scale(1.2);
            border-color: #3b82f6;
        }
        
        .mode-switch {
            display: flex;
            background: #f3f4f6;
            padding: 4px;
            border-radius: 12px;
        }
        .mode-switch button {
            flex: 1;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .mode-switch button.active {
            background: white;
            color: #2563eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Slider Stil */
        input[type=range] {
            height: 6px;
            border-radius: 5px;
            background: #e2e8f0;
            outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px; height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="h-screen w-full flex flex-col p-2 md:p-4 overflow-hidden select-none bg-blue-50">

    <!-- √úST PANEL -->
    <header class="flex flex-col gap-2 mb-2 bg-white p-3 rounded-2xl shadow-sm border border-blue-100 z-30 flex-shrink-0">
        
        <!-- √úst Satƒ±r: Ba≈ülƒ±k, Modlar, Kaƒüƒ±t, Kaydet -->
        <div class="flex flex-col md:flex-row items-center justify-between gap-3">
            <div class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-start">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">‚úèÔ∏è</span>
                    <h1 class="text-lg md:text-xl font-bold text-gray-800 hidden md:block">Sihirli Parmaklar</h1>
                </div>
                
                <!-- Mod Se√ßici -->
                <div class="mode-switch">
                    <button onclick="setMode('text')" id="btnModeText" class="active">Yazƒ±</button>
                    <button onclick="setMode('pattern')" id="btnModePattern">√áizgi</button>
                </div>
            </div>

            <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0 items-center justify-between md:justify-end">
                <!-- Kaƒüƒ±t Tipi Se√ßici -->
                <div class="flex bg-gray-100 rounded-lg p-1 gap-1">
                    <button onclick="setPaper('lined')" class="p-2 rounded hover:bg-white text-gray-600" title="√áizgili"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
                    <button onclick="setPaper('grid')" class="p-2 rounded hover:bg-white text-gray-600" title="Kareli"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h16v16H4zM4 12h16M12 4v16"></path></svg></button>
                    <button onclick="setPaper('plain')" class="p-2 rounded hover:bg-white text-gray-600" title="D√ºz"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2" stroke-width="2"></rect></svg></button>
                </div>

                <button onclick="downloadWork()" class="bg-blue-50 text-blue-600 px-3 py-2 rounded-lg text-sm font-medium hover:bg-blue-100 flex items-center gap-1 whitespace-nowrap ml-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    Kaydet
                </button>
            </div>
        </div>

        <!-- Alt Satƒ±r: Yazƒ±/√áizgi Kontrolleri -->
        <div id="controlsArea" class="w-full pt-2 border-t border-gray-100">
            
            <!-- Yazƒ± Modu Kontrolleri -->
            <div id="textControls" class="flex flex-col md:flex-row gap-3 items-center">
                <div class="flex-1 w-full flex flex-col gap-1">
                    <!-- KULLANICI ƒ∞STEƒûƒ∞: BELƒ∞RGƒ∞N ETƒ∞KET -->
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wide ml-1">‚úèÔ∏è C√ºmleyi Buraya Yaz:</label>
                    <input type="text" id="textInput" value="Barƒ±≈ü eve geldi" 
                        class="w-full px-4 py-2 rounded-xl border-2 border-blue-200 focus:border-blue-500 outline-none text-gray-700 font-medium text-lg bg-blue-50/30"
                        placeholder="√ñrn: Ali ata bak">
                </div>
                
                <div class="flex items-center gap-2 w-full md:w-auto bg-gray-50 px-3 py-2 rounded-xl justify-between md:justify-start border border-gray-100">
                    <span class="text-sm text-gray-500 whitespace-nowrap font-medium">Harf Boyutu:</span>
                    <div class="flex items-center gap-2 flex-1 md:flex-none">
                        <span class="text-xs text-gray-400">A</span>
                        <input type="range" id="fontSizeSlider" min="40" max="400" value="130" class="flex-1 md:w-32 accent-blue-500" oninput="updateGuide()">
                        <span class="text-lg text-gray-600 font-bold">A</span>
                    </div>
                </div>
            </div>

            <!-- √áizgi √áalƒ±≈ümasƒ± Kontrolleri (Ba≈ülangƒ±√ßta Gizli) -->
            <div id="patternControls" class="hidden flex overflow-x-auto pb-1 w-full gap-2 no-scrollbar">
                <button onclick="setPattern('straight')" class="pattern-btn px-4 py-2 rounded-lg border border-gray-200 hover:bg-gray-50 text-sm font-medium whitespace-nowrap bg-white shadow-sm">D√ºz √áizgi</button>
                <button onclick="setPattern('zigzag')" class="pattern-btn px-4 py-2 rounded-lg border border-gray-200 hover:bg-gray-50 text-sm font-medium whitespace-nowrap bg-white shadow-sm">Zikzak</button>
                <button onclick="setPattern('wave')" class="pattern-btn px-4 py-2 rounded-lg border border-gray-200 hover:bg-gray-50 text-sm font-medium whitespace-nowrap bg-white shadow-sm">Dalga</button>
                <button onclick="setPattern('square')" class="pattern-btn px-4 py-2 rounded-lg border border-gray-200 hover:bg-gray-50 text-sm font-medium whitespace-nowrap bg-white shadow-sm">Kale</button>
                <button onclick="setPattern('loop')" class="pattern-btn px-4 py-2 rounded-lg border border-gray-200 hover:bg-gray-50 text-sm font-medium whitespace-nowrap bg-white shadow-sm">ƒ∞lmek</button>
            </div>
        </div>
    </header>

    <!-- ANA √áƒ∞Zƒ∞M ALANI -->
    <main class="flex-1 relative w-full h-full min-h-0 flex flex-col px-1">
        <div class="canvas-container flex-1 w-full border-4 border-white shadow-inner bg-lined relative" id="canvasWrapper">
            <!-- Rehber Katmanƒ± -->
            <canvas id="guideCanvas"></canvas>
            <!-- √áizim Katmanƒ± -->
            <canvas id="drawingCanvas"></canvas>
            
            <!-- Konum Sƒ±fƒ±rlama Butonu (Sadece kƒ±lavuz kaydƒ±rƒ±ldƒ±ƒüƒ±nda i≈üe yarar) -->
            <button onclick="resetPosition()" id="resetBtn" class="absolute top-2 right-2 bg-white/90 p-2 rounded-full shadow hover:bg-white text-gray-500 z-30 hidden border border-gray-200" title="Ortala">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                </svg>
            </button>

            <!-- Ta≈üƒ±ma Modu Uyarƒ±sƒ± -->
            <div id="moveHint" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-blue-600/90 text-white px-4 py-2 rounded-full pointer-events-none hidden z-40 text-sm font-bold shadow-lg animate-pulse whitespace-nowrap">
                üñêÔ∏è Yazƒ±yƒ± istediƒüin yere ta≈üƒ±
            </div>
        </div>
    </main>

    <!-- ALT ARA√á √áUBUƒûU (Versiyon 3.0 Tasarƒ±mƒ±) -->
    <footer class="mt-2 bg-white p-2 md:p-3 rounded-2xl shadow-lg border border-gray-100 flex flex-wrap items-center justify-between gap-3 z-40 flex-shrink-0">
        
        <!-- Renkler -->
        <div class="flex items-center gap-2 overflow-x-auto px-1 py-1 scrollbar-hide w-full md:w-auto justify-center md:justify-start order-1 md:order-1 border-b md:border-b-0 border-gray-100 pb-2 md:pb-0">
            <button class="color-swatch active" style="background: #ef4444;" onclick="setTool('pen', '#ef4444', this)"></button>
            <button class="color-swatch" style="background: #f97316;" onclick="setTool('pen', '#f97316', this)"></button>
            <button class="color-swatch" style="background: #eab308;" onclick="setTool('pen', '#eab308', this)"></button>
            <button class="color-swatch" style="background: #22c55e;" onclick="setTool('pen', '#22c55e', this)"></button>
            <button class="color-swatch" style="background: #3b82f6;" onclick="setTool('pen', '#3b82f6', this)"></button>
            <button class="color-swatch" style="background: #000000;" onclick="setTool('pen', '#000000', this)"></button>
        </div>

        <!-- Ara√ß Butonlarƒ± -->
        <div class="flex items-center justify-between md:justify-end gap-2 w-full md:w-auto order-2 md:order-2">
            
            <!-- Ta≈üƒ±ma Aracƒ± (El ƒ∞konu) -->
            <button onclick="setTool('move')" id="btnMove" class="tool-btn bg-gray-100 text-gray-600 p-3 rounded-xl border-2 border-transparent" title="Yazƒ±yƒ± Ta≈üƒ±">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11" />
                </svg>
            </button>

            <div class="w-px h-8 bg-gray-300 mx-1"></div>

            <!-- Kalem Kalƒ±nlƒ±ƒüƒ± (ARTIK MOBƒ∞LDE DE G√ñR√úN√úR) -->
            <div class="flex flex-col items-center mx-1 min-w-[60px]">
                <input type="range" id="lineWidth" min="5" max="40" value="15" class="w-full accent-gray-500 h-2 bg-gray-200 rounded-lg cursor-pointer">
                <span class="text-[10px] text-gray-400 mt-1 font-medium">Kalem Ucu</span>
            </div>

            <div class="w-px h-8 bg-gray-300 mx-1"></div>

            <!-- Silgi -->
            <button onclick="setTool('eraser')" id="btnEraser" class="tool-btn bg-gray-100 text-gray-600 p-3 rounded-xl border-2 border-transparent" title="Silgi">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z" />
                </svg>
            </button>

            <!-- Temizle -->
             <button onclick="clearCanvas()" class="tool-btn bg-red-100 hover:bg-red-200 text-red-600 p-3 rounded-xl border-2 border-transparent" title="Hepsini Sil">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>

            <!-- Kutlama -->
            <button onclick="celebrate()" class="ml-2 tool-btn bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-xl font-bold shadow-md shadow-green-200 active:scale-95">
                üéâ
            </button>
        </div>
    </footer>

    <script>
        // --- 1. DEƒûƒ∞≈ûKENLER ---
        const guideCanvas = document.getElementById('guideCanvas');
        const drawingCanvas = document.getElementById('drawingCanvas');
        const ctxGuide = guideCanvas.getContext('2d');
        const ctxDraw = drawingCanvas.getContext('2d');
        const container = document.getElementById('canvasWrapper');
        const textInput = document.getElementById('textInput');
        const fontSizeSlider = document.getElementById('fontSizeSlider');
        const resetBtn = document.getElementById('resetBtn');
        const moveHint = document.getElementById('moveHint');

        let state = {
            mode: 'text', // 'text', 'pattern'
            pattern: 'straight',
            tool: 'pen', // 'pen', 'move', 'eraser'
            color: '#ef4444',
            offsetX: 0,
            offsetY: 0,
            isDrawing: false,
            isDragging: false,
            lastX: 0,
            lastY: 0,
            dragStartX: 0,
            dragStartY: 0
        };

        // --- 2. CANVAS AYARLARI ---
        function resizeCanvas() {
            const rect = container.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            
            guideCanvas.width = rect.width * dpr;
            guideCanvas.height = rect.height * dpr;
            drawingCanvas.width = rect.width * dpr;
            drawingCanvas.height = rect.height * dpr;

            guideCanvas.style.width = '100%';
            guideCanvas.style.height = '100%';
            drawingCanvas.style.width = '100%';
            drawingCanvas.style.height = '100%';

            ctxGuide.scale(dpr, dpr);
            ctxDraw.scale(dpr, dpr);
            
            ctxDraw.lineCap = 'round';
            ctxDraw.lineJoin = 'round';
            
            updateContent();
        }

        // --- 3. ARA√á Y√ñNETƒ∞Mƒ∞ ---
        function setTool(tool, color, btn) {
            state.tool = tool;
            
            // UI G√ºncellemeleri
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active', 'border-blue-500'));
            
            if (tool === 'move') {
                document.getElementById('btnMove').classList.add('active', 'border-blue-500');
                container.classList.remove('cursor-draw');
                container.classList.add('cursor-move');
                moveHint.classList.remove('hidden');
                setTimeout(() => moveHint.classList.add('hidden'), 2000); // 2 sn sonra gizle
                resetBtn.classList.remove('hidden');
            } else {
                // Kalem veya Silgi
                container.classList.add('cursor-draw');
                container.classList.remove('cursor-move', 'cursor-grabbing');
                
                if (tool === 'eraser') {
                    document.getElementById('btnEraser').classList.add('active', 'border-blue-500');
                    ctxDraw.globalCompositeOperation = 'destination-out';
                } else if (tool === 'pen') {
                    ctxDraw.globalCompositeOperation = 'source-over';
                    if (color) {
                        state.color = color;
                        document.querySelectorAll('.color-swatch').forEach(b => b.classList.remove('active'));
                        if(btn) btn.classList.add('active');
                    }
                }
            }
        }

        function setPaper(type) {
            container.classList.remove('bg-lined', 'bg-grid', 'bg-plain');
            if(type === 'lined') container.classList.add('bg-lined');
            else if(type === 'grid') container.classList.add('bg-grid');
            else container.classList.add('bg-plain');
        }

        function clearCanvas() {
            const w = container.clientWidth;
            const h = container.clientHeight;
            ctxDraw.clearRect(0, 0, w, h);
            container.style.opacity = '0.5';
            setTimeout(() => container.style.opacity = '1', 150);
        }

        function resetPosition() {
            state.offsetX = 0;
            state.offsetY = 0;
            updateContent();
        }

        // --- 4. MOD VE ƒ∞√áERƒ∞K ---
        function setMode(mode) {
            state.mode = mode;
            setTool('pen'); // Mod deƒüi≈üince kaleme d√∂n
            resetPosition();
            
            document.getElementById('btnModeText').className = mode === 'text' ? 'active' : '';
            document.getElementById('btnModePattern').className = mode === 'pattern' ? 'active' : '';
            
            document.getElementById('textControls').className = mode === 'text' ? 'flex flex-col md:flex-row gap-3 items-center' : 'hidden';
            document.getElementById('patternControls').className = mode === 'pattern' ? 'flex overflow-x-auto pb-1 w-full gap-2 no-scrollbar' : 'hidden';

            clearCanvas();
            updateContent();
        }

        function setPattern(patternType) {
            state.pattern = patternType;
            document.querySelectorAll('.pattern-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.textContent.toLowerCase().includes(getPatternNameTR(patternType).toLowerCase())) {
                    btn.classList.add('active');
                }
            });
            clearCanvas();
            updateContent();
        }

        function getPatternNameTR(type) {
            const names = { straight: 'D√ºz', zigzag: 'Zikzak', wave: 'Dalga', square: 'Kale', loop: 'ƒ∞lmek' };
            return names[type] || '';
        }

        function updateContent() {
            updateGuide(); // Alias
        }

        function updateGuide() {
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            ctxGuide.clearRect(0, 0, width, height);
            ctxGuide.save();
            ctxGuide.translate(state.offsetX, state.offsetY);

            // Kƒ±lavuz Stili
            ctxGuide.strokeStyle = '#94a3b8'; // Soluk gri
            ctxGuide.lineWidth = 3;
            ctxGuide.setLineDash([8, 8]);
            ctxGuide.lineCap = 'round';
            ctxGuide.lineJoin = 'round';

            if (state.mode === 'text') {
                const text = textInput.value;
                const fontSize = parseInt(fontSizeSlider.value);
                
                ctxGuide.font = `bold ${fontSize}px 'Lexend', sans-serif`;
                ctxGuide.textAlign = 'center';
                ctxGuide.textBaseline = 'middle';
                
                // Dƒ±≈ü √áizgi
                ctxGuide.strokeText(text, width / 2, height / 2);
                
                // ƒ∞√ß Dolgu
                ctxGuide.fillStyle = 'rgba(203, 213, 225, 0.4)';
                ctxGuide.setLineDash([]); 
                ctxGuide.fillText(text, width / 2, height / 2);
            } 
            else {
                drawPatternGuide(width, height);
            }
            
            ctxGuide.restore();
        }

        function drawPatternGuide(w, h) {
            const cy = h / 2;
            const amp = 60;
            const freq = 80;
            const startX = -w; // Ekran dƒ±≈üƒ±ndan ba≈üla ki kaydƒ±rƒ±nca g√∂r√ºns√ºn
            const endX = w * 2;

            ctxGuide.beginPath();
            ctxGuide.moveTo(startX, cy);

            if (state.pattern === 'straight') {
                ctxGuide.lineTo(endX, cy);
            }
            else if (state.pattern === 'zigzag') {
                for (let x = startX; x < endX; x += freq) {
                    ctxGuide.lineTo(x + freq/2, cy - amp);
                    ctxGuide.lineTo(x + freq, cy + amp);
                }
            }
            else if (state.pattern === 'wave') {
                for (let x = startX; x < endX; x+=5) {
                    ctxGuide.lineTo(x, cy + Math.sin(x/40) * amp);
                }
            }
            else if (state.pattern === 'square') {
                let x = startX;
                while (x < endX) {
                    ctxGuide.lineTo(x, cy - amp);
                    x += freq/2;
                    ctxGuide.lineTo(x, cy - amp);
                    ctxGuide.lineTo(x, cy + amp);
                    x += freq/2;
                    ctxGuide.lineTo(x, cy + amp);
                }
            }
            else if (state.pattern === 'loop') {
                let x = startX;
                while(x < endX) {
                     ctxGuide.bezierCurveTo(
                         x + freq/2, cy - amp * 2.5,
                         x - freq/4, cy - amp * 2.5,
                         x + freq, cy
                     );
                     x += freq;
                }
            }
            ctxGuide.stroke();
        }

        // --- 5. Gƒ∞Rƒ∞≈û (TOUCH/MOUSE) ---
        function getPointerPos(e) {
            const rect = drawingCanvas.getBoundingClientRect();
            let clientX, clientY;
            if (e.changedTouches && e.changedTouches.length > 0) {
                clientX = e.changedTouches[0].clientX;
                clientY = e.changedTouches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function handleStart(e) {
            if (e.cancelable) e.preventDefault();
            const pos = getPointerPos(e);

            if (state.tool === 'move') {
                state.isDragging = true;
                state.dragStartX = pos.x;
                state.dragStartY = pos.y;
                container.classList.add('cursor-grabbing');
            } else {
                state.isDrawing = true;
                state.lastX = pos.x;
                state.lastY = pos.y;
                handleDraw(pos); // Nokta koy
            }
        }

        function handleMove(e) {
            if (e.cancelable) e.preventDefault();
            const pos = getPointerPos(e);

            if (state.tool === 'move' && state.isDragging) {
                const dx = pos.x - state.dragStartX;
                const dy = pos.y - state.dragStartY;
                state.offsetX += dx;
                state.offsetY += dy;
                state.dragStartX = pos.x;
                state.dragStartY = pos.y;
                updateContent();
            }
            else if (state.isDrawing) {
                handleDraw(pos);
            }
        }

        function handleDraw(pos) {
            ctxDraw.beginPath();
            ctxDraw.moveTo(state.lastX, state.lastY);
            ctxDraw.lineTo(pos.x, pos.y);
            
            const lineWidth = document.getElementById('lineWidth').value;
            
            if (state.tool === 'eraser') {
                ctxDraw.lineWidth = lineWidth * 2;
            } else {
                ctxDraw.strokeStyle = state.color;
                ctxDraw.lineWidth = lineWidth;
            }
            
            ctxDraw.stroke();
            state.lastX = pos.x;
            state.lastY = pos.y;
        }

        function handleEnd(e) {
            state.isDrawing = false;
            state.isDragging = false;
            ctxDraw.beginPath();
            container.classList.remove('cursor-grabbing');
        }

        // --- 6. EKSTRALAR ---
        function celebrate() {
            const defaults = { origin: { y: 0.7 } };
            function fire(ratio, opts) {
                confetti(Object.assign({}, defaults, opts, {
                    particleCount: Math.floor(200 * ratio)
                }));
            }
            fire(0.25, { spread: 26, startVelocity: 55, });
            fire(0.2, { spread: 60, });
            fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
        }
        
        function downloadWork() {
            const temp = document.createElement('canvas');
            temp.width = drawingCanvas.width;
            temp.height = drawingCanvas.height;
            const tCtx = temp.getContext('2d');
            
            tCtx.fillStyle = '#ffffff';
            tCtx.fillRect(0, 0, temp.width, temp.height);
            tCtx.drawImage(guideCanvas, 0, 0);
            tCtx.drawImage(drawingCanvas, 0, 0);
            
            const link = document.createElement('a');
            link.download = 'calismam.png';
            link.href = temp.toDataURL();
            link.click();
        }

        // --- EVENT LISTENERS ---
        window.addEventListener('resize', resizeCanvas);
        textInput.addEventListener('input', updateGuide);

        // Canvas Dinleyicileri
        drawingCanvas.addEventListener('mousedown', handleStart);
        window.addEventListener('mousemove', handleMove); 
        window.addEventListener('mouseup', handleEnd);

        drawingCanvas.addEventListener('touchstart', handleStart, { passive: false });
        drawingCanvas.addEventListener('touchmove', handleMove, { passive: false });
        drawingCanvas.addEventListener('touchend', handleEnd);

        // Ba≈ülangƒ±√ß
        window.onload = () => {
            resizeCanvas();
            setMode('text');
            setPaper('lined'); // Varsayƒ±lan √ßizgili
            setPattern('straight'); // Hazƒ±rda beklesin
        };
    </script>
</body>
</html>


