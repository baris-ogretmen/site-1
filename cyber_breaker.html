<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Deadline Breaker: Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        html, body { 
            height: 100%; 
            width: 100%;
            overflow: hidden; 
            touch-action: none; 
        }
        body { 
            margin: 0; padding: 0; 
            background: #000; 
            font-family: 'Oswald', sans-serif; 
            user-select: none; 
            -webkit-user-select: none;
            background: linear-gradient(180deg, #020010 0%, #050a14 100%);
            color: #e7f9ff;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.5s;
        }

        /* Boss Modu Arka Planı */
        body.boss-mode {
            background: linear-gradient(180deg, #1a0000 0%, #330000 100%);
        }

        #game-container {
            width: 95vmin; 
            height: 95vmin;
            max-width: 600px;
            max-height: 600px;
            position: relative;
            background: radial-gradient(circle, rgba(15,25,50,1) 0%, rgba(0,0,0,1) 100%);
            border: 2px solid #00c8ff;
            box-shadow: 0 0 30px rgba(0, 200, 255, 0.3);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        /* Boss Modu Container */
        #game-container.boss-active {
            border-color: #ff004c;
            box-shadow: 0 0 50px rgba(255, 0, 76, 0.5);
            background: radial-gradient(circle, rgba(50,10,10,1) 0%, rgba(0,0,0,1) 100%);
        }

        .shake-screen { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-6px, 0, 0); }
            40%, 60% { transform: translate3d(6px, 0, 0); }
        }

        .glitch-active { animation: glitch-skew 0.3s infinite; filter: hue-rotate(90deg) contrast(200%); }
        @keyframes glitch-skew {
            0% { transform: skew(0deg); }
            20% { transform: skew(-10deg); }
            40% { transform: skew(10deg); }
            60% { transform: skew(-5deg); }
            80% { transform: skew(5deg); }
            100% { transform: skew(0deg); }
        }

        #lock-wrapper {
            position: relative;
            width: 60%; 
            height: 60%;
            margin-top: -10%;
            z-index: 10;
        }

        .lock-ring-static {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%;
            border: 8px solid #1a1a1a;
            box-shadow: inset 0 0 30px #000, 0 0 20px rgba(0,200,255,0.1);
            transition: border-color 0.3s;
        }
        #game-container.boss-active .lock-ring-static { border-color: #500; box-shadow: 0 0 20px rgba(255,0,0,0.3); }

        /* HEDEF ALANI (Geliştirilmiş Görsel) */
        #target-zone {
            position: absolute;
            top: -12%; left: 50%;
            transform: translateX(-50%);
            width: 24%; height: 24%;
            background: rgba(0, 200, 255, 0.05);
            border: 3px solid #00c8ff;
            border-radius: 50%;
            z-index: 20;
            box-shadow: 0 0 15px #00c8ff;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.1s;
        }
        
        /* Reticle Corners (Süsleme) */
        #target-zone::after {
            content: ''; position: absolute;
            top: -5px; left: -5px; right: -5px; bottom: -5px;
            border: 2px dashed rgba(0,200,255,0.5);
            border-radius: 50%;
            animation: spinReticle 10s linear infinite;
        }
        @keyframes spinReticle { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        #target-zone.locked-on {
            border-color: #00ff00;
            background: rgba(0, 255, 0, 0.25);
            box-shadow: 0 0 50px #00ff00, inset 0 0 20px #00ff00;
            transform: translateX(-50%) scale(1.15);
        }
        #target-zone.locked-on::after { border-color: #00ff00; animation-duration: 2s; }

        #target-arrow {
            color: #00c8ff; font-size: 2rem; margin-top: -55%;
            animation: bounceArrow 0.8s infinite;
            filter: drop-shadow(0 0 5px #00c8ff);
        }
        #target-zone.locked-on #target-arrow { color: #00ff00; filter: drop-shadow(0 0 8px #00ff00); }

        #spinner {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%; transition: transform 0.1s linear;
        }
        
        .pin-node {
            position: absolute;
            width: 16%; height: 16%;
            background: #111; border: 2px solid #444;
            border-radius: 50%; color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: clamp(16px, 4vw, 24px);
            box-shadow: 0 0 10px rgba(0,0,0,0.8);
            background: linear-gradient(135deg, #2a2a2a 0%, #111 100%);
            top: 50%; left: 50%; 
            margin-top: -8%; margin-left: -8%;
        }
        /* Güçlendirme Pini */
        .pin-node.powerup {
            border-color: #00ff9d; color: #00ff9d;
            box-shadow: 0 0 15px #00ff9d;
            animation: pulsePower 1s infinite;
        }
        @keyframes pulsePower { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .pin-node.glowing {
            border-color: #fff; background: #fff; color: #000;
            box-shadow: 0 0 40px #fff;
        }

        #center-display {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center; z-index: 30; width: 85%; pointer-events: none;
        }
        #math-question {
            font-size: clamp(28px, 8vw, 52px); font-weight: bold;
            text-shadow: 0 0 15px #00c8ff, 3px 3px 0px #000;
            color: #fff; font-family: 'Press Start 2P', cursive;
            line-height: 1.5; letter-spacing: -2px;
        }
        #lock-status {
            font-size: clamp(10px, 3vw, 14px); color: #00c8ff;
            margin-top: 5px; text-transform: uppercase;
            background: rgba(0,0,0,0.8); padding: 4px 12px;
            border-radius: 4px; border: 1px solid #005577;
        }
        #game-container.boss-active #math-question { text-shadow: 0 0 15px #ff004c, 3px 3px 0 #000; color: #ffe7e7; }
        #game-container.boss-active #lock-status { color: #ff004c; border-color: #ff004c; animation: flashText 0.5s infinite; }
        @keyframes flashText { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        #battle-area {
            position: absolute; bottom: 0; width: 100%; height: 20%;
            background: rgba(10, 15, 20, 0.9);
            border-top: 2px solid #00c8ff;
            display: flex; align-items: center; padding: 0 5%;
            backdrop-filter: blur(8px);
        }
        #game-container.boss-active #battle-area { border-top-color: #ff004c; }

        .status-bar-group { flex: 1; margin: 0 10px; }
        .bar-label {
            display: flex; justify-content: space-between;
            font-size: clamp(8px, 2.5vw, 12px); margin-bottom: 5px;
            font-family: 'Press Start 2P', cursive;
        }
        .progress-track {
            height: 12px; background: #000; border: 1px solid #333;
            border-radius: 4px; overflow: hidden; position: relative;
        }
        
        #security-bar {
            width: 100%; height: 100%;
            background: linear-gradient(90deg, #00c8ff, #00ffff);
            box-shadow: 0 0 15px #00c8ff; transition: width 0.2s;
        }
        #virus-bar {
            width: 0%; height: 100%;
            background: linear-gradient(90deg, #ff4d00, #ff0000);
            box-shadow: 0 0 15px #ff0000; transition: width 0.1s linear;
        }

        .char-icon { font-size: clamp(20px, 6vw, 32px); filter: drop-shadow(0 0 10px rgba(255,255,255,0.2)); }
        #char-designer { color: #00c8ff; }
        #char-death { color: #ff004c; }

        #overlay-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center; padding: 20px;
        }
        .neon-title {
            font-size: clamp(2rem, 8vw, 3.5rem); color: #fff;
            text-shadow: 0 0 10px #00c8ff, 0 0 30px #00c8ff;
            margin-bottom: 20px; font-family: 'Press Start 2P'; line-height: 1.4;
        }
        .action-btn {
            padding: 15px 30px; font-size: clamp(1rem, 5vw, 1.4rem);
            background: transparent; color: #00ff9d;
            border: 2px solid #00ff9d; cursor: pointer;
            box-shadow: 0 0 15px #00ff9d;
            font-family: 'Oswald', sans-serif; text-transform: uppercase;
            margin-top: 20px; width: 80%;
        }
        .action-btn:hover { background: #00ff9d; color: #000; box-shadow: 0 0 40px #00ff9d; }

        .particle {
            position: absolute; pointer-events: none;
            width: 6px; height: 6px; background: #fff;
            border-radius: 50%; z-index: 50;
        }

        #combo-display {
            position: absolute; top: 10%; right: 5%;
            text-align: right; font-family: 'Press Start 2P', cursive;
            z-index: 40; transform: rotate(-5deg);
        }
        #combo-count {
            font-size: clamp(24px, 7vw, 40px); color: #ffd700;
            text-shadow: 2px 2px 0 #ff0000;
        }
        #combo-label { font-size: 10px; color: #fff; opacity: 0.8; }

        @keyframes bounceArrow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        
        .feedback-float {
            position: absolute; font-size: clamp(20px, 6vw, 28px); font-weight: bold;
            pointer-events: none; animation: floatUp 0.8s forwards;
            z-index: 60; text-shadow: 2px 2px 0 #000;
            font-family: 'Oswald', sans-serif; text-transform: uppercase;
            width: 100%; text-align: center; left:0;
        }
        @keyframes floatUp {
            0% { transform: translateY(-50%) scale(0.5); opacity: 0; }
            20% { transform: translateY(-50%) scale(1.2); opacity: 1; }
            100% { transform: translateY(-150px) scale(1); opacity: 0; }
        }

    </style>
</head>
<body>

    <div id="game-container">
        <!-- Background Elements -->
        <div style="position: absolute; top:0; left:0; width:100%; height:100%; background: repeating-linear-gradient(0deg, transparent 0px, transparent 2px, rgba(0, 200, 255, 0.03) 3px); pointer-events:none;"></div>
        
        <!-- Combo UI -->
        <div id="combo-display" style="display:none;">
            <div id="combo-count">x2</div>
            <div id="combo-label">COMBO</div>
        </div>

        <!-- Start/Game Over Overlay -->
        <div id="overlay-screen">
            <h1 class="neon-title">CYBER<br>ULTIMATE</h1>
            <div id="instructions-box" style="color:#ddd; font-size: clamp(0.8rem, 3.5vw, 1rem); line-height: 1.6; margin-bottom: 20px; background: rgba(0,20,30,0.8); padding: 20px; border-radius: 10px; border: 1px solid #005577; width: 90%;">
                <p style="color:#00c8ff; font-weight:bold; margin-bottom:15px; font-size:1.2rem;">SİSTEM ÖZELLİKLERİ v2.0</p>
                <div style="text-align:left;">
                    <p><i class="fas fa-calculator text-yellow-400"></i> İşlemi Çöz (Örn: 2 + 3 = 5)</p>
                    <p><i class="fas fa-bullseye text-green-400"></i> Doğru cevap <b class="text-green-400">YEŞİL KUTUYA</b> gelince vur!</p>
                    <p><i class="fas fa-skull text-red-500"></i> <b>BOSS MODU:</b> Her 5 seviyede bir dikkat et!</p>
                    <p><i class="fas fa-heart text-pink-500"></i> <b>[+]</b> Pini canını yeniler.</p>
                </div>
            </div>
            <button class="action-btn" onclick="startGame()">BAŞLAT</button>
        </div>

        <!-- LOCK AREA -->
        <div id="lock-wrapper">
            <div class="lock-ring-static"></div>
            
            <div id="target-zone">
                <i id="target-arrow" class="fas fa-caret-down"></i>
            </div>

            <div id="spinner">
                <!-- Pins injected here -->
            </div>

            <div id="center-display">
                <div id="math-question">?</div>
                <div id="lock-status">HAZIR</div>
            </div>
        </div>

        <!-- BATTLE STATUS AREA -->
        <div id="battle-area">
            <div style="text-align:center;">
                <i id="char-designer" class="fas fa-user-secret char-icon"></i>
            </div>

            <div class="status-bar-group">
                <div class="bar-label">
                    <span style="color:#00c8ff">GÜÇ</span>
                    <span id="security-val">100%</span>
                </div>
                <div class="progress-track" style="margin-bottom:12px;">
                    <div id="security-bar"></div>
                </div>

                <div class="bar-label">
                    <span style="color:#ff004c">TEHDİT</span>
                    <span id="virus-val">0%</span>
                </div>
                <div class="progress-track">
                    <div id="virus-bar"></div>
                </div>
            </div>

            <div style="text-align:center;">
                <i id="char-death" class="fas fa-skull-crossbones char-icon"></i>
            </div>
        </div>
    </div>

<script>
    // --- SES MOTORU (Simple Synth) ---
    // Harici dosya gerektirmez, tarayıcıda ses üretir.
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        const now = audioCtx.currentTime;

        if (type === 'hit') {
            // Başarılı (Yüksek ince ses)
            osc.type = 'sine';
            osc.frequency.setValueAtTime(500, now);
            osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        } else if (type === 'lock') {
            // Hedefe kilitlenme (Kısa bip)
            osc.type = 'square';
            osc.frequency.setValueAtTime(800, now);
            gainNode.gain.setValueAtTime(0.05, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
            osc.start(now);
            osc.stop(now + 0.05);
        } else if (type === 'fail') {
            // Hata (Düşük testere sesi)
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.linearRampToValueAtTime(50, now + 0.3);
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.linearRampToValueAtTime(0.01, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.3);
        } else if (type === 'powerup') {
            // Güçlendirme (Melodik)
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.linearRampToValueAtTime(800, now + 0.2);
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.gain.linearRampToValueAtTime(0.01, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.3);
        } else if (type === 'boss') {
            // Boss Alarmı
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.linearRampToValueAtTime(400, now + 0.5);
            gainNode.gain.setValueAtTime(0.1, now);
            gainNode.gain.linearRampToValueAtTime(0.01, now + 0.6);
            osc.start(now);
            osc.stop(now + 0.6);
        }
    }

    // --- OYUN DEĞİŞKENLERİ ---
    const game = {
        active: false,
        level: 1,
        rotation: 0,
        speed: 0.8,
        correctAnswer: 0,
        pins: [], 
        securityIntegrity: 100, 
        virusUpload: 0,         
        score: 0,
        combo: 0,
        tolerance: 30,
        isBossLevel: false
    };

    // DOM Elements
    const elSpinner = document.getElementById('spinner');
    const elQuestion = document.getElementById('math-question');
    const elSecurityBar = document.getElementById('security-bar');
    const elVirusBar = document.getElementById('virus-bar');
    const elOverlay = document.getElementById('overlay-screen');
    const elLockStatus = document.getElementById('lock-status');
    const elContainer = document.getElementById('game-container');
    const elTargetZone = document.getElementById('target-zone');
    const elComboDisplay = document.getElementById('combo-display');
    const elComboCount = document.getElementById('combo-count');
    const elBody = document.body;

    // Controls
    const handleInput = (e) => {
        if(e.type === 'touchstart') e.preventDefault(); 
        if(e.code && e.code !== 'Space') return; 
        attemptUnlock();
    };

    elContainer.addEventListener('mousedown', handleInput);
    elContainer.addEventListener('touchstart', handleInput, {passive: false});
    document.addEventListener('keydown', handleInput);

    function startGame() {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        
        game.active = true;
        game.level = 1;
        game.score = 0;
        game.combo = 0;
        game.securityIntegrity = 100;
        game.virusUpload = 0;
        game.speed = 0.8; 
        
        elOverlay.style.display = 'none';
        elComboDisplay.style.display = 'none';
        elContainer.classList.remove('glitch-active');
        
        updateBars();
        generateLevel();
        gameLoop();
    }

    function generateLevel() {
        elSpinner.innerHTML = '';
        game.pins = [];

        // BOSS LEVEL CONTROL
        game.isBossLevel = (game.level % 5 === 0);
        
        if (game.isBossLevel) {
            elContainer.classList.add('boss-active');
            elBody.classList.add('boss-mode');
            elLockStatus.innerText = "⚠️ BOSS: FIREWALL ⚠️";
            playSound('boss');
        } else {
            elContainer.classList.remove('boss-active');
            elBody.classList.remove('boss-mode');
            elLockStatus.innerText = `KATMAN ${game.level}`;
            elLockStatus.style.color = "#00c8ff";
        }

        // Zorluk ve Sayı Üretimi
        const diffMultiplier = Math.ceil(game.level / 2);
        const maxNum = 4 + diffMultiplier * 2;
        
        const num1 = Math.floor(Math.random() * maxNum) + 1;
        const num2 = Math.floor(Math.random() * maxNum) + 1;
        
        const type = (game.level > 5 && Math.random() > 0.8) ? '*' : (Math.random() > 0.4 ? '+' : '-');

        let qText = "";
        if (type === '+') {
            game.correctAnswer = num1 + num2;
            qText = `${num1} + ${num2}`;
        } else if (type === '-') {
            game.correctAnswer = Math.abs(num1 - num2);
            qText = `${Math.max(num1,num2)} - ${Math.min(num1,num2)}`;
        } else {
            let n1 = Math.floor(Math.random() * 3) + 1;
            let n2 = Math.floor(Math.random() * 4) + 1;
            game.correctAnswer = n1 * n2;
            qText = `${n1} x ${n2}`;
        }

        elQuestion.innerText = qText;

        const pinCount = Math.min(6 + Math.floor(game.level/3), 10);
        const angleStep = 360 / pinCount;

        // Cevap Havuzu
        let answers = [game.correctAnswer];
        
        // ŞANS: Power-up Pini Ekle? (%25 ihtimal)
        let powerUpIndex = -1;
        if (Math.random() > 0.75) {
            answers.push("+"); // Özel sembol
            powerUpIndex = 1;
        }

        while(answers.length < pinCount) {
            let fake = game.correctAnswer + Math.floor(Math.random() * 10) - 5;
            if(fake !== game.correctAnswer && !answers.includes(fake) && fake >= 0 && fake !== "+") {
                answers.push(fake);
            }
        }
        
        // Karıştır
        answers.sort(() => Math.random() - 0.5);

        // Pinleri oluştur
        answers.forEach((val, index) => {
            const angle = index * angleStep;
            const pinEl = document.createElement('div');
            pinEl.className = 'pin-node';
            pinEl.innerText = val;
            
            // Eğer powerup ise stil ekle
            if (val === "+") {
                pinEl.classList.add('powerup');
            }
            
            // Konumlandırma
            // Mobilde %280 (yaklaşık 140px / 50px) oranını koruyoruz
            pinEl.style.transform = `rotate(${angle}deg) translate(280%) rotate(-${angle}deg)`;
            elSpinner.appendChild(pinEl);

            game.pins.push({ value: val, angle: angle, el: pinEl });
        });

        // Hız Ayarı
        game.rotation = 0;
        // Boss seviyesinde her zaman hızlı başla
        let baseSpeed = 0.6 + (game.level * 0.1);
        if (game.isBossLevel) baseSpeed *= 1.5;
        if (baseSpeed > 3.0) baseSpeed = 3.0;
        
        if (Math.random() > 0.5) game.speed = -baseSpeed;
        else game.speed = baseSpeed;
    }

    function gameLoop() {
        if(!game.active) return;

        let currentSpeed = game.speed;
        
        // Boss Level Mekaniği: Rastgele Hız/Yön Değişimi
        if (game.isBossLevel) {
            // Kaotik hareket
            currentSpeed += Math.sin(Date.now() / 150) * 0.5; 
            // Çok nadir yön değiştirme şansı (Her frame %1)
            if (Math.random() < 0.01) {
                game.speed *= -1;
            }
        } else if (game.level > 4) {
            // Normal zorlukta hafif dalgalanma
            currentSpeed += Math.sin(Date.now() / 200) * 0.2; 
        }

        game.rotation += currentSpeed;
        elSpinner.style.transform = `rotate(${game.rotation}deg)`;

        // Virüs Yükleme (Boss levelda daha hızlı)
        let pressure = 0.04 + (game.level * 0.005);
        if (game.isBossLevel) pressure *= 1.3;
        
        game.virusUpload += pressure;
        if(game.virusUpload >= 100) {
            gameOver(false);
            return;
        }

        checkTargetLock();
        updateBars();
        requestAnimationFrame(gameLoop);
    }

    let lastLockedState = false;

    function checkTargetLock() {
        const targetAngle = 270;
        let isLockedOn = false;

        game.pins.forEach(pin => {
            // Sadece doğru cevabı ve powerup'ı kilitle
            if (pin.value === game.correctAnswer || pin.value === "+") {
                let currentPinAbsAngle = (pin.angle + game.rotation) % 360;
                if(currentPinAbsAngle < 0) currentPinAbsAngle += 360;

                let diff = Math.abs(currentPinAbsAngle - targetAngle);
                if(diff > 180) diff = 360 - diff;

                if(diff < game.tolerance) {
                    isLockedOn = true;
                }
            }
        });

        if (isLockedOn) {
            elTargetZone.classList.add('locked-on');
            // Kilitlendiği an bir kez bip sesi çıkar
            if (!lastLockedState) {
                playSound('lock'); 
                // Mobilde titreşim (Haptic)
                if(navigator.vibrate) navigator.vibrate(10);
            }
        } else {
            elTargetZone.classList.remove('locked-on');
        }
        lastLockedState = isLockedOn;
    }

    function attemptUnlock() {
        if(!game.active) return;

        const targetAngle = 270;
        let hit = false;
        let hitPin = null;

        game.pins.forEach(pin => {
            let currentPinAbsAngle = (pin.angle + game.rotation) % 360;
            if(currentPinAbsAngle < 0) currentPinAbsAngle += 360;
            let diff = Math.abs(currentPinAbsAngle - targetAngle);
            if(diff > 180) diff = 360 - diff;

            if(diff < game.tolerance) {
                hit = true;
                hitPin = pin;
            }
        });

        if(hit) {
            if(hitPin.value === game.correctAnswer) {
                // DOĞRU CEVAP
                handleSuccess(hitPin);
            } else if (hitPin.value === "+") {
                // POWERUP
                handlePowerup(hitPin);
            } else {
                // YANLIŞ CEVAP
                handleFail("YANLIŞ!", 20);
            }
        } else {
            // BOŞA
            handleFail("ISKA!", 10);
        }
    }

    function handlePowerup(pin) {
        playSound('powerup');
        createParticles(elTargetZone.getBoundingClientRect(), '#00ff9d');
        pin.el.style.opacity = "0"; // Pini yok et
        
        game.securityIntegrity = Math.min(100, game.securityIntegrity + 20); // Can doldur
        showFloatingText("ONARILDI!", "#00ff9d");
        
        // Pini listeden kaldır ki tekrar vurulmasın (basitçe değerini değiştir)
        pin.value = null; 
    }

    function handleSuccess(pin) {
        playSound('hit');
        game.combo++;
        let bonus = "";
        if(game.combo > 1) {
            elComboDisplay.style.display = 'block';
            elComboCount.innerText = "x" + game.combo;
            elComboCount.style.transform = "scale(1.5)";
            setTimeout(() => elComboCount.style.transform = "scale(1)", 200);
            bonus = ` (x${game.combo})`;
        }

        createParticles(elTargetZone.getBoundingClientRect(), '#fff');

        pin.el.classList.add('glowing');
        successEffect("SÜPER!" + bonus, "#00ff9d");
        
        game.level++;
        game.virusUpload -= (15 + game.combo * 2); 
        if(game.virusUpload < 0) game.virusUpload = 0;
        
        setTimeout(generateLevel, 400);
    }

    function handleFail(msg, damage) {
        playSound('fail');
        game.combo = 0; 
        elComboDisplay.style.display = 'none';

        // Titreşim (Ceza)
        if(navigator.vibrate) navigator.vibrate(200);

        elContainer.classList.add('shake-screen');
        elContainer.classList.add('glitch-active');
        setTimeout(() => {
            elContainer.classList.remove('shake-screen');
            elContainer.classList.remove('glitch-active');
        }, 400);

        failEffect(msg, damage);
    }

    function createParticles(rect, color) {
        const count = 15;
        const containerRect = elContainer.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2 - containerRect.left;
        const centerY = rect.top + rect.height / 2 - containerRect.top;

        for (let i = 0; i < count; i++) {
            const p = document.createElement('div');
            p.classList.add('particle');
            elContainer.appendChild(p);
            
            const angle = Math.random() * Math.PI * 2;
            const velocity = Math.random() * 60 + 20;
            const tx = Math.cos(angle) * velocity;
            const ty = Math.sin(angle) * velocity;

            p.style.left = centerX + 'px';
            p.style.top = centerY + 'px';
            p.style.background = color || '#fff'; 

            p.animate([
                { transform: 'translate(0,0) scale(1)', opacity: 1 },
                { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
            ], {
                duration: 600,
                easing: 'cubic-bezier(0, .9, .57, 1)',
            }).onfinish = () => p.remove();
        }
    }

    function failEffect(msg, damage) {
        showFloatingText(msg, '#ff004c');
        game.securityIntegrity -= damage;
        elContainer.style.boxShadow = "0 0 50px red, inset 0 0 50px red";
        setTimeout(() => elContainer.style.boxShadow = "", 200);

        if(game.securityIntegrity <= 0) {
            game.securityIntegrity = 0;
            gameOver(false);
        }
        updateBars();
    }

    function successEffect(msg, color) {
        showFloatingText(msg, color);
        elContainer.style.boxShadow = "0 0 60px #00ff9d";
        setTimeout(() => elContainer.style.boxShadow = "", 200);
    }

    function updateBars() {
        elSecurityBar.style.width = game.securityIntegrity + '%';
        elVirusBar.style.width = game.virusUpload + '%';
        document.getElementById('security-val').innerText = Math.floor(game.securityIntegrity) + '%';
        document.getElementById('virus-val').innerText = Math.floor(game.virusUpload) + '%';

        if(game.securityIntegrity < 30) elSecurityBar.style.background = "red";
        else elSecurityBar.style.background = "linear-gradient(90deg, #00c8ff, #0066ff)";
    }

    function showFloatingText(text, color) {
        const floatEl = document.createElement('div');
        floatEl.className = 'feedback-float';
        floatEl.innerText = text;
        floatEl.style.color = color;
        floatEl.style.top = '40%'; 
        elContainer.appendChild(floatEl);
        setTimeout(() => floatEl.remove(), 800);
    }

    function gameOver(win) {
        game.active = false;
        playSound('fail'); // Son kez fail sesi
        
        elOverlay.style.display = 'flex';
        const title = elOverlay.querySelector('h1');
        const box = document.getElementById('instructions-box');
        const btn = elOverlay.querySelector('button');

        title.innerText = "SİSTEM ÇÖKTÜ";
        title.style.color = "#ff004c";
        box.innerHTML = `
            <p style="font-size:1.5rem; color:#fff">ULAŞILAN KATMAN: <span style="color:#00c8ff">${game.level}</span></p>
            <p style="font-size:1rem; color:#aaa; margin-top:10px">En Yüksek Kombo: x${game.combo}</p>
        `;
        btn.innerText = "YENİDEN BAŞLAT";
        
        btn.onclick = () => {
             // Reset UI
             box.innerHTML = `
                <p style="color:#00c8ff; font-weight:bold; margin-bottom:15px; font-size:1.2rem;">SİSTEM ÖZELLİKLERİ v2.0</p>
                <div style="text-align:left;">
                    <p><i class="fas fa-calculator text-yellow-400"></i> İşlemi Çöz (Örn: 2 + 3 = 5)</p>
                    <p><i class="fas fa-bullseye text-green-400"></i> Doğru cevap <b class="text-green-400">YEŞİL KUTUYA</b> gelince vur!</p>
                    <p><i class="fas fa-skull text-red-500"></i> <b>BOSS MODU:</b> Her 5 seviyede bir dikkat et!</p>
                    <p><i class="fas fa-heart text-pink-500"></i> <b>[+]</b> Pini canını yeniler.</p>
                </div>
             `;
             title.innerHTML = "CYBER<br>ULTIMATE";
             title.style.color = "#fff";
             
             // Boss efektlerini temizle
             elContainer.classList.remove('boss-active');
             elBody.classList.remove('boss-mode');
             
             startGame();
        };
    }

</script>
</body>
</html>
