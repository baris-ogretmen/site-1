<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Siber Görev: Neon Şehir | Barış Hoca</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg: #050a14;
            --neon-cyan: #00fff2;
            --neon-pink: #ff00ff;
            --neon-purple: #bc13fe;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }

        body {
            margin: 0; padding: 0; overflow: hidden; background: var(--bg); font-family: 'Orbitron', sans-serif; color: white;
            height: 100dvh; width: 100vw; display: flex; flex-direction: column;
            background-image: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
        }

        /* 1. ÜST BİLGİ */
        .hud-panel {
            height: 50px; flex-shrink: 0; padding: 0 15px; display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.6); border-bottom: 1px solid var(--neon-cyan); z-index: 10;
        }
        .hud-title { font-size: 1rem; color: var(--neon-cyan); }
        .hud-level { font-size: 1rem; color: var(--neon-pink); }

        /* 2. OYUN ALANI */
        #canvas-wrapper {
            flex: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; width: 100%;
        }
        canvas { box-shadow: 0 0 20px rgba(188, 19, 254, 0.3); border-radius: 4px; }

        /* 3. KONTROL PANELİ */
        .control-panel {
            flex-shrink: 0; background: rgba(5, 10, 20, 0.95); border-top: 2px solid var(--neon-purple);
            padding: 10px; display: flex; flex-direction: column; gap: 8px; padding-bottom: 20px;
        }

        /* Komut Göstergesi */
        .cmd-display {
            height: 45px; background: rgba(0,0,0,0.5); border: 1px solid rgba(0,255,242,0.3);
            border-radius: 5px; display: flex; align-items: center; gap: 5px; overflow-x: auto; padding: 0 5px;
        }
        .cmd-block {
            min-width: 35px; height: 35px; background: rgba(0, 255, 242, 0.15); border: 1px solid var(--neon-cyan);
            display: flex; align-items: center; justify-content: center; font-size: 1rem; color: var(--neon-cyan);
            border-radius: 4px; flex-shrink: 0; animation: popIn 0.2s;
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* Buton Grubu */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; max-width: 500px; margin: 0 auto; width: 100%; }
        
        /* Yön Tuşları (Sol) */
        .dpad-area {
            grid-column: 1 / 3; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;
        }
        /* Aksiyon Tuşları (Sağ) */
        .action-area {
            grid-column: 3 / 4; display: flex; flex-direction: column; gap: 5px;
        }

        .cyber-btn {
            background: rgba(0, 255, 242, 0.1); border: 1px solid var(--neon-cyan); color: var(--neon-cyan);
            border-radius: 8px; cursor: pointer; font-size: 1.3rem; height: 55px;
            display: flex; align-items: center; justify-content: center; transition: 0.1s; touch-action: manipulation;
        }
        .cyber-btn:active { background: var(--neon-cyan); color: black; transform: scale(0.95); }
        
        .btn-run { border-color: #0aff0a; color: #0aff0a; background: rgba(10, 255, 10, 0.1); flex: 2; font-weight: bold; }
        .btn-undo { border-color: #fbbf24; color: #fbbf24; flex: 1; }
        .btn-del { border-color: var(--neon-pink); color: var(--neon-pink); flex: 1; }

        /* POP-UP MESAJLARI */
        .overlay-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95); padding: 20px; border: 2px solid var(--neon-cyan);
            text-align: center; display: none; z-index: 100; border-radius: 15px; width: 80%; max-width: 400px;
            box-shadow: 0 0 30px var(--neon-cyan);
        }
        .overlay-msg h2 { font-size: 1.5rem; color: var(--neon-cyan); margin: 0 0 10px 0; }
        .overlay-msg button { margin-top: 15px; width: 100%; }

    </style>
</head>
<body>

    <div class="hud-panel">
        <a href="robot.html" style="color:white; text-decoration:none; font-size:1.2rem;"><i class="fas fa-arrow-left"></i></a>
        <div class="hud-title">NEON KODLAMA</div>
        <div class="hud-level">LVL <span id="level-num">1</span></div>
    </div>

    <div id="canvas-wrapper">
        <canvas id="gameCanvas"></canvas>
        
        <div id="winMsg" class="overlay-msg">
            <h2>BAŞARILI!</h2>
            <p>Sistem Hacklendi.</p>
            <button class="cyber-btn btn-run" onclick="nextLevel()" style="height:40px;">SONRAKİ SEVİYE >></button>
        </div>
        <div id="crashMsg" class="overlay-msg" style="border-color:var(--neon-pink);">
            <h2 style="color:var(--neon-pink);">HATA!</h2>
            <p>Robot çarptı.</p>
            <button class="cyber-btn btn-del" onclick="resetLevel()" style="height:40px;">TEKRAR DENE ↻</button>
        </div>
    </div>

    <div class="control-panel">
        <div class="cmd-display" id="cmdDisplay"></div>
        
        <div class="btn-grid">
            <div class="dpad-area">
                <div></div> 
                <button class="cyber-btn" onclick="addCommand('up')"><i class="fas fa-arrow-up"></i></button>
                <div></div> 
                <button class="cyber-btn" onclick="addCommand('left')"><i class="fas fa-arrow-left"></i></button>
                <button class="cyber-btn" onclick="addCommand('down')"><i class="fas fa-arrow-down"></i></button>
                <button class="cyber-btn" onclick="addCommand('right')"><i class="fas fa-arrow-right"></i></button>
            </div>
            
            <div class="action-area">
                <button class="cyber-btn btn-run" onclick="runCode()"><i class="fas fa-play"></i></button>
                <div style="display:flex; gap:5px; height:100%;">
                    <button class="cyber-btn btn-undo" onclick="undoCommand()"><i class="fas fa-undo"></i></button>
                    <button class="cyber-btn btn-del" onclick="resetCommands()"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const cmdDisplay = document.getElementById('cmdDisplay');
        const wrapper = document.getElementById('canvas-wrapper');

        // AYARLAR
        let TILE_SIZE = 40;
        let map = [];
        let currentLevel = 0;
        let commandQueue = [];
        let isRunning = false;
        let player = { x: 0, y: 0, px: 0, py: 0 };
        let collectibles = [];
        let particles = [];

        // SEVİYELER (1:Duvar, 0:Yol, 2:Başlangıç, 3:Bitiş, 4:Puan)
        const levels = [
            [ [1,1,1,1,1,1],[1,2,0,4,0,1],[1,1,1,1,0,1],[1,3,0,0,0,1],[1,1,1,1,1,1] ],
            [ [1,1,1,1,1,1,1],[1,2,0,1,0,3,1],[1,0,1,1,0,1,1],[1,4,0,0,4,0,1],[1,1,1,1,1,1,1] ],
            [ [1,1,1,1,1,1,1,1],[1,2,0,0,0,1,3,1],[1,1,1,0,1,1,0,1],[1,4,0,0,0,0,0,1],[1,0,1,1,1,1,1,1],[1,0,0,4,0,0,0,1],[1,1,1,1,1,1,1,1] ]
        ];

        // EKRAN BOYUTLANDIRMA
        function resizeGame() {
            const rows = map.length; const cols = map[0].length;
            const availableWidth = wrapper.clientWidth; const availableHeight = wrapper.clientHeight;
            const tileW = (availableWidth - 20) / cols; const tileH = (availableHeight - 20) / rows;
            TILE_SIZE = Math.floor(Math.min(tileW, tileH));
            canvas.width = cols * TILE_SIZE; canvas.height = rows * TILE_SIZE;
            player.px = player.x * TILE_SIZE; player.py = player.y * TILE_SIZE;
            draw();
        }
        window.addEventListener('resize', () => { if(map.length>0) resizeGame(); });

        // OYUN BAŞLATMA
        function initLevel(idx) {
            currentLevel = idx % levels.length;
            document.getElementById('level-num').innerText = currentLevel + 1;
            document.getElementById('winMsg').style.display = 'none';
            document.getElementById('crashMsg').style.display = 'none';
            
            map = JSON.parse(JSON.stringify(levels[currentLevel]));
            collectibles = [];
            for(let r=0; r<map.length; r++) {
                for(let c=0; c<map[0].length; c++) {
                    if(map[r][c] === 2) { player.x = c; player.y = r; }
                    if(map[r][c] === 4) collectibles.push({x:c, y:r, active:true});
                }
            }
            resetCommands(); isRunning = false;
            setTimeout(resizeGame, 50); 
        }

        // ÇİZİM
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for(let r=0; r<map.length; r++) {
                for(let c=0; c<map[0].length; c++) {
                    const type = map[r][c]; const x = c * TILE_SIZE; const y = r * TILE_SIZE;
                    if(type === 1) { 
                        ctx.fillStyle = '#0f172a'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                        ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 1; ctx.strokeRect(x, y, TILE_SIZE, TILE_SIZE);
                        ctx.fillStyle = 'rgba(59, 130, 246, 0.2)'; ctx.fillRect(x+5, y+5, TILE_SIZE-10, TILE_SIZE-10);
                    } else if (type === 3) {
                        ctx.fillStyle = 'rgba(0, 255, 242, 0.3)'; ctx.beginPath(); 
                        ctx.arc(x+TILE_SIZE/2, y+TILE_SIZE/2, TILE_SIZE/3, 0, Math.PI*2); ctx.fill(); 
                        ctx.strokeStyle = '#00fff2'; ctx.stroke();
                    }
                }
            }
            collectibles.forEach(c => {
                if(c.active) {
                    const cx = c.x * TILE_SIZE + TILE_SIZE/2; const cy = c.y * TILE_SIZE + TILE_SIZE/2;
                    ctx.fillStyle = '#ff00ff'; ctx.beginPath(); 
                    ctx.moveTo(cx, cy-TILE_SIZE/4); ctx.lineTo(cx+TILE_SIZE/4, cy); 
                    ctx.lineTo(cx, cy+TILE_SIZE/4); ctx.lineTo(cx-TILE_SIZE/4, cy); ctx.fill();
                }
            });
            player.px += (player.x * TILE_SIZE - player.px) * 0.3; player.py += (player.y * TILE_SIZE - player.py) * 0.3;
            ctx.fillStyle = '#00fff2'; ctx.shadowColor = '#00fff2'; ctx.shadowBlur = 15;
            ctx.beginPath(); ctx.arc(player.px + TILE_SIZE/2, player.py + TILE_SIZE/2, TILE_SIZE/3, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0;
            updateParticles();
            if(isRunning || Math.abs(player.px - player.x*TILE_SIZE) > 1) requestAnimationFrame(draw);
        }

        // OYUN MANTIĞI
        function addCommand(cmd) {
            if(isRunning) return;
            commandQueue.push(cmd);
            let icon = '';
            if(cmd=='up') icon='fa-arrow-up'; if(cmd=='down') icon='fa-arrow-down';
            if(cmd=='left') icon='fa-arrow-left'; if(cmd=='right') icon='fa-arrow-right';
            const el = document.createElement('div'); el.className = 'cmd-block'; el.innerHTML = `<i class="fas ${icon}"></i>`;
            cmdDisplay.appendChild(el);
            cmdDisplay.scrollLeft = cmdDisplay.scrollWidth;
            playSound(600, 'square');
        }

        function undoCommand() {
            if(isRunning || commandQueue.length === 0) return;
            commandQueue.pop(); // Son komutu diziden sil
            cmdDisplay.removeChild(cmdDisplay.lastChild); // Görselden sil
            playSound(200, 'sawtooth');
        }

        function resetCommands() {
            if(isRunning) return;
            commandQueue = []; cmdDisplay.innerHTML = ''; playSound(300, 'sawtooth');
        }

        function resetLevel() { initLevel(currentLevel); }

        async function runCode() {
            if(isRunning || commandQueue.length === 0) return;
            isRunning = true; draw();
            for(let i=0; i<commandQueue.length; i++) {
                const blocks = document.querySelectorAll('.cmd-block');
                blocks.forEach(b => b.style.borderColor = 'var(--neon-cyan)');
                if(blocks[i]) blocks[i].style.borderColor = 'white';
                const cmd = commandQueue[i]; let nx = player.x; let ny = player.y;
                if(cmd === 'up') ny--; if(cmd === 'down') ny++; if(cmd === 'left') nx--; if(cmd === 'right') nx++;
                if(nx < 0 || ny < 0 || nx >= map[0].length || ny >= map.length || map[ny][nx] === 1) {
                    createExplosion(player.x, player.y, '#ff0000'); playSound(100, 'sawtooth');
                    document.getElementById('crashMsg').style.display = 'block'; isRunning = false; return;
                }
                player.x = nx; player.y = ny; playSound(400, 'sine');
                const item = collectibles.find(c => c.x === nx && c.y === ny && c.active);
                if(item) { item.active = false; createExplosion(nx, ny, '#ff00ff'); playSound(800, 'square'); }
                if(map[ny][nx] === 3) {
                    createExplosion(nx, ny, '#00fff2'); playSound(1000, 'sine');
                    document.getElementById('winMsg').style.display = 'block'; isRunning = false; return;
                }
                await new Promise(r => setTimeout(r, 600));
            }
            isRunning = false;
        }

        function nextLevel() { initLevel(currentLevel + 1); }

        // EFEKTLER
        function createExplosion(gx, gy, color) {
            const x = gx * TILE_SIZE + TILE_SIZE/2; const y = gy * TILE_SIZE + TILE_SIZE/2;
            for(let i=0; i<20; i++) { particles.push({ x: x, y: y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10, life: 1, color: color }); }
        }
        function updateParticles() {
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.05;
                ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
                if(p.life <= 0) particles.splice(i, 1);
            }
            ctx.globalAlpha = 1;
        }

        // SES
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(freq, type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.value = freq; osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1); setTimeout(() => osc.stop(), 100);
        }

        initLevel(0);
    </script>
</body>
</html>
