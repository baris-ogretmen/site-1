<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S√ºper Tatil √áarkƒ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #10B981;
            --accent: #F59E0B;
            --danger: #ef4444;
            --bg: #F3F4F6;
            --dark: #1f2937;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg);
            background-image: radial-gradient(#d1d5db 1px, transparent 1px);
            background-size: 20px 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        /* Giri≈ü Ekranƒ± (Modal) */
        #loginScreen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 400px;
            text-align: center;
            border: 4px solid var(--primary);
            position: relative;
        }

        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; font-weight: 700; margin-bottom: 8px; color: #374151; }
        .input-group input, .input-group select {
            width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 12px;
            font-size: 1rem; font-family: 'Nunito', sans-serif; outline: none; transition: 0.3s; background: #f9fafb;
        }
        .input-group input:focus, .input-group select:focus { border-color: var(--primary); background: white; }

        .btn-start {
            background: var(--primary); color: white; width: 100%; padding: 16px;
            border: none; border-radius: 12px; font-size: 1.2rem; font-weight: 700;
            cursor: pointer; box-shadow: 0 5px 0 #4338ca; transition: 0.1s;
        }
        .btn-start:active { transform: translateY(4px); box-shadow: 0 0 0 #4338ca; }

        /* Ana Oyun Alanƒ± */
        #gameScreen { display: none; width: 100%; max-width: 600px; flex-direction: column; align-items: center; padding: 20px; padding-top: 10px; position: relative; }

        .top-nav {
            width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }

        .btn-home {
            background: #e5e7eb; color: #374151; border: none; padding: 8px 16px;
            border-radius: 20px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 5px;
            transition: 0.2s;
        }
        .btn-home:hover { background: #d1d5db; }

        header { margin-bottom: 15px; text-align: center; width: 100%; }
        h1 { font-family: 'Fredoka', sans-serif; color: var(--primary); font-size: 1.8rem; text-shadow: 2px 2px 0px rgba(0,0,0,0.05); }
        .welcome-text { color: #6B7280; font-weight: 600; font-size: 0.95rem; }

        /* ƒ∞statistikler ve Progress Bar */
        .stats-container {
            width: 100%; background: white; padding: 15px; border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px;
            border: 2px solid white;
        }

        .stats-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .stat-item { display: flex; flex-direction: column; align-items: flex-start; }
        .stat-val { font-family: 'Fredoka', sans-serif; font-size: 1.5rem; color: var(--accent); font-weight: bold; line-height: 1; }
        .stat-lbl { font-size: 0.7rem; font-weight: 800; color: #9CA3AF; letter-spacing: 0.5px; }

        .progress-wrapper { width: 100%; background: #E5E7EB; height: 10px; border-radius: 10px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--secondary), var(--primary)); width: 0%; transition: width 0.5s ease; border-radius: 10px; }
        .progress-text { font-size: 0.7rem; color: #6B7280; margin-top: 5px; text-align: right; font-weight: 700; }

        /* √áark Alanƒ± */
        .wheel-container {
            position: relative;
            width: 320px; height: 320px;
            margin-bottom: 20px;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.15));
        }

        canvas { width: 100%; height: 100%; /* transform transition JS ile yapƒ±lƒ±yor */ }

        .pointer {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 40px; height: 50px; background: #ef4444;
            clip-path: polygon(100% 0, 50% 100%, 0 0);
            z-index: 10; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
        }

        /* √áevir Butonu */
        .spin-btn {
            background: white; border: 4px solid var(--primary); color: var(--primary);
            width: 70px; height: 70px; border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-weight: 800; font-size: 1rem; cursor: pointer; z-index: 5;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
            font-family: 'Fredoka', sans-serif;
            transition: all 0.2s;
        }
        .spin-btn:active { transform: translate(-50%, -50%) scale(0.9); background: var(--bg); }
        .spin-btn:disabled { opacity: 0.7; cursor: not-allowed; border-color: #9CA3AF; color: #9CA3AF; }

        /* G√∂rev Ge√ßmi≈üi */
        .history-section {
            width: 100%; background: rgba(255,255,255,0.6); padding: 15px; border-radius: 16px; margin-top: 20px;
        }
        .history-title { font-size: 0.9rem; font-weight: 800; color: #4B5563; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .history-list { list-style: none; }
        .history-item { 
            font-size: 0.85rem; color: #4B5563; padding: 8px 0; border-bottom: 1px dashed #D1D5DB; 
            display: flex; justify-content: space-between;
        }
        .history-item:last-child { border-bottom: none; }
        .history-score { color: var(--secondary); font-weight: 700; }

        /* G√∂rev Kartƒ± (Sonu√ß) */
        #resultModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 2000;
            display: none; justify-content: center; align-items: center; padding: 20px;
            backdrop-filter: blur(3px);
        }

        .mission-card {
            background: white; padding: 40px 30px; border-radius: 24px;
            width: 100%; max-width: 400px; text-align: center;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-bottom: 8px solid #E5E7EB;
            position: relative;
        }

        .mission-icon { font-size: 4rem; margin-bottom: 20px; display: block; animation: bounce 2s infinite; }
        .mission-cat { background: #EFF6FF; color: var(--primary); padding: 5px 15px; border-radius: 20px; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 15px; display: inline-block; }
        .mission-text { font-size: 1.3rem; font-weight: 700; color: #1f2937; margin-bottom: 30px; line-height: 1.4; }

        .btn-complete {
            background: var(--secondary); color: white; width: 100%; padding: 15px;
            border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 700;
            cursor: pointer; border-bottom: 4px solid #059669; transition: 0.2s;
        }
        .btn-complete:active { border-bottom: 0; transform: translateY(4px); margin-top: 4px; }

        .btn-close-modal {
            position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; color: #9CA3AF; cursor: pointer;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* Mobil Uyum */
        @media (max-width: 400px) {
            .wheel-container { width: 280px; height: 280px; }
            h1 { font-size: 1.5rem; }
            .mission-text { font-size: 1.1rem; }
        }
    </style>
</head>
<body>

    <!-- Gƒ∞Rƒ∞≈û EKRANI -->
    <div id="loginScreen">
        <div class="login-card">
            <h1 style="margin-bottom: 10px;">Tatil √áarkƒ± üé°</h1>
            <p style="margin-bottom: 20px; color: #666;">ƒ∞lerlemeni kaydetmek i√ßin bilgilerini gir.</p>
            
            <div class="input-group">
                <label>Adƒ±n Nedir?</label>
                <input type="text" id="playerName" placeholder="√ñrn: Ali" maxlength="15">
            </div>

            <div class="input-group">
                <label>Sƒ±nƒ±fƒ±n Ka√ß?</label>
                <select id="playerGrade">
                    <option value="ilkokul">ƒ∞lkokul (1-4. Sƒ±nƒ±f)</option>
                    <option value="ortaokul">Ortaokul (5-8. Sƒ±nƒ±f)</option>
                    <option value="lise">Lise (9-12. Sƒ±nƒ±f)</option>
                </select>
            </div>

            <button class="btn-start" onclick="startGame()">OYUNA BA≈ûLA ‚ñ∂</button>
            <div style="margin-top: 15px; font-size: 0.75rem; color: #9CA3AF;">* Puanlarƒ±n otomatik saklanƒ±r.</div>
        </div>
    </div>

    <!-- OYUN EKRANI -->
    <div id="gameScreen">
        <div class="top-nav">
            <button class="btn-home" onclick="goHome()">üè† Ana Men√º</button>
            <div id="gradeLabel" style="font-weight: 700; color: #6B7280; font-size: 0.8rem;">-</div>
        </div>

        <header>
            <h1 id="welcomeTitle">Ho≈ü Geldin!</h1>
            <div class="welcome-text">Bug√ºnk√º ≈üanslƒ± g√∂revin ne?</div>
        </header>

        <div class="stats-container">
            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-lbl">TOPLAM PUAN</div>
                    <div class="stat-val" id="score">0</div>
                </div>
                <div class="stat-item" style="align-items: flex-end;">
                    <div class="stat-lbl">R√úTBE</div>
                    <div class="stat-val" id="rankBadge" style="color:var(--primary); font-size: 1.1rem;">√áaylak</div>
                </div>
            </div>
            
            <div class="progress-wrapper">
                <div class="progress-fill" id="xpBar"></div>
            </div>
            <div class="progress-text" id="nextRankInfo">Sonraki r√ºtbeye: 50 Puan</div>
        </div>

        <div class="wheel-container">
            <div class="pointer"></div>
            <canvas id="wheelCanvas" width="400" height="400"></canvas>
            <button class="spin-btn" id="spinBtn" onclick="spinWheel()">√áEVƒ∞R</button>
        </div>

        <div class="history-section">
            <div class="history-title">üìú Son G√∂revlerin</div>
            <ul class="history-list" id="historyList">
                <li class="history-item" style="justify-content: center; color: #9CA3AF;">Hen√ºz g√∂rev tamamlamadƒ±n.</li>
            </ul>
        </div>
    </div>

    <!-- SONU√á MODALI -->
    <div id="resultModal">
        <div class="mission-card">
            <button class="btn-close-modal" onclick="closeModalWithoutPoint()">√ó</button>
            <div class="mission-icon" id="mIcon">üéÅ</div>
            <div class="mission-cat" id="mCat">KATEGORƒ∞</div>
            <div class="mission-text" id="mText">G√∂rev burada yazacak...</div>
            <button class="btn-complete" onclick="acceptMission()">G√∂revi Tamamladƒ±m (+20P)</button>
        </div>
    </div>

    <script>
        // --- SES EFEKTLERƒ∞ (GELƒ∞≈ûMƒ∞≈û) ---
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        // √áark D√∂nme Sesi (Tƒ±k)
        function playTick() {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            // Kƒ±sa, perk√ºsif bir ses
            osc.frequency.setValueAtTime(300, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.05);
            
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.05);
        }

        // Kazanma Sesi (Akor - Ta-Da!)
        function playWin() {
            if (!audioCtx) return;
            
            const now = audioCtx.currentTime;
            
            // C Major Akor (Do-Mi-Sol-Do) - Arpej ≈üeklinde
            const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
            
            notes.forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                
                osc.type = 'sine'; // Veya 'triangle' daha yumu≈üak olabilir
                osc.frequency.value = freq;
                
                // Zamanlamayƒ± biraz kaydƒ±rarak √ßal (Arpej etkisi)
                const startTime = now + (i * 0.08); 
                
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.2, startTime + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.8);
                
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(startTime);
                osc.stop(startTime + 1);
            });
        }

        // --- VERƒ∞ & AYARLAR ---
        // Kategorilerin sƒ±rasƒ± √ßarkta √ßizilirken √∂nemlidir.
        // Index 0: Zeka, Index 1: Spor...
        const categories = [
            { name: "Zeka", color: "#6366f1", icon: "üß†" },
            { name: "Spor", color: "#10B981", icon: "‚öΩ" },
            { name: "Sanat", color: "#F59E0B", icon: "üé®" },
            { name: "Aile", color: "#EC4899", icon: "üë®‚Äçüë©‚Äçüëß" },
            { name: "Doƒüa", color: "#84CC16", icon: "üå±" },
            { name: "Joker", color: "#F43F5E", icon: "‚≠ê" }
        ];

        // GENƒ∞≈ûLETƒ∞LMƒ∞≈û G√ñREV HAVUZU
        const missionsDB = {
            'ilkokul': {
                'Zeka': [
                    "En sevdiƒüin kitabƒ± ailene sesli oku.", 
                    "20'den geriye 2'≈üer ritmik say.", 
                    "Bir tekerlemeyi ezberle ve hƒ±zla s√∂yle.",
                    "Odandaki mavi renkli 5 e≈üyayƒ± bul ve say.",
                    "ƒ∞sminin harfleriyle ba≈ülayan birer hayvan ismi bul.",
                    "Ailenle 'Evet-Hayƒ±r' oyunu oyna (Sorulara evet/hayƒ±r demek yasak).",
                    "Bir kaƒüƒ±da 2025 yƒ±lƒ± i√ßin bir hayalini √ßiz."
                ],
                'Spor': [
                    "Sevdiƒüin ≈üarkƒ±da 2 dakika dans et.", 
                    "10 kez zƒ±pla ve 5 kez √ß√∂mel.", 
                    "Tek ayak √ºst√ºnde 10 saniye durmaya √ßalƒ±≈ü.",
                    "Koridorda yenge√ß gibi yan yan y√ºr√º.",
                    "Bir balonu yere d√º≈ü√ºrmeden 1 dakika havada tut.",
                    "Hayali bir ip atlama oyunu oyna (50 kez).",
                    "Yataƒüƒ±nƒ± kendin d√ºzelt (Bu da spordur!)."
                ],
                'Sanat': [
                    "Hayalindeki evi √ßiz ve boya.", 
                    "Bir kaƒüƒ±ttan en uzaƒüa giden u√ßaƒüƒ± yap.", 
                    "Patates veya yaprak baskƒ±sƒ± yapmayƒ± dene.",
                    "Tuvalet kaƒüƒ±dƒ± rulosundan bir d√ºrb√ºn yap.",
                    "En sevdiƒüin meyvenin resmini √ßiz.",
                    "Bir ≈üarkƒ± uydur ve ailene s√∂yle.",
                    "Oyun hamurundan bir hayvan yap."
                ],
                'Aile': [
                    "Annene veya babana kocaman sarƒ±l.", 
                    "Sofrayƒ± kurmaya yardƒ±m et.", 
                    "Bir aile b√ºy√ºƒü√ºn√º g√∂r√ºnt√ºl√º ara.",
                    "Karde≈üinle veya ailenle sessiz sinema oyna.",
                    "Ak≈üam yemeƒüinde herkese 'G√ºn√ºn nasƒ±l ge√ßti?' diye sor.",
                    "Ailene bir fƒ±kra anlat ve onlarƒ± g√ºld√ºr.",
                    "Evdeki √ßi√ßekleri sula (Ailenle birlikte)."
                ],
                'Doƒüa': [
                    "Pencereden dƒ±≈üarƒ± bak ve 3 farklƒ± ku≈ü bul.", 
                    "Bir √ßi√ßeƒüi veya bitkiyi incele, yapraklarƒ±nƒ± say.", 
                    "G√∂ky√ºz√ºne bak ve bulutlarƒ± bir ≈üeye benzet.",
                    "Dƒ±≈üarƒ± √ßƒ±karsan bir sokak hayvanƒ±na mama/su ver.",
                    "Meyve √ßekirdeklerini √ß√∂pe atma, biriktirip topraƒüa g√∂m.",
                    "Odanƒ± havalandƒ±r ve derin bir nefes al.",
                    "Doƒüa ile ilgili bir belgesel izle (kƒ±sa bir b√∂l√ºm)."
                ],
                'Joker': [
                    "Bug√ºn senin g√ºn√ºn! Ak≈üam yemeƒüini sen se√ß.", 
                    "1 saat boyunca istediƒüin oyunu oyna.",
                    "Bug√ºn evde 'Pijamalƒ± Pazar' ilan et (G√ºn√º pijamayla ge√ßir).",
                    "Ailenden sana bir masal anlatmalarƒ±nƒ± iste.",
                    "Kendi gizli selamla≈üma hareketini uydur."
                ]
            },
            'ortaokul': {
                'Zeka': [
                    "ƒ∞ngilizce 5 yeni kelime √∂ƒüren ve c√ºmle i√ßinde kullan.", 
                    "Satran√ß, Dama veya Sudoku oyna.", 
                    "ƒ∞lgin√ß bir bilimsel ger√ßeƒüi ara≈ütƒ±r ve ailene anlat.",
                    "Bir √ºlkenin ba≈ükentini ve bayraƒüƒ±nƒ± √∂ƒüren.",
                    "Bug√ºn okuduƒüun kitaptan 20 sayfa fazla oku.",
                    "G√∂zlerini kapatƒ±p odandaki e≈üyalarƒ±n yerini hatƒ±rlamaya √ßalƒ±≈ü.",
                    "Bir matematik problemini aklƒ±ndan √ß√∂zmeye √ßalƒ±≈ü."
                ],
                'Spor': [
                    "20 mekik √ßek.", 
                    "Dƒ±≈üarƒ± √ßƒ±kƒ±p 15 dakika tempolu y√ºr√º veya ko≈ü.", 
                    "YouTube'dan bir egzersiz videosu a√ß ve yap.",
                    "Evde 'Plank' duru≈üunda rekorunu kƒ±rmaya √ßalƒ±≈ü.",
                    "Varsa merdivenleri 3 kez inip √ßƒ±k.",
                    "50 tane 'Jumping Jack' (Zƒ±plama) hareketi yap.",
                    "V√ºcut esnetme hareketleri yap (En az 5 dakika)."
                ],
                'Sanat': [
                    "Gelecekteki mesleƒüini anlatan bir resim veya yazƒ± hazƒ±rla.", 
                    "Origami ile turna ku≈üu veya gemi yap.", 
                    "Kendi √ßizgi romanƒ±nƒ±n bir sayfasƒ±nƒ± tasarla.",
                    "Eski bir ti≈ü√∂rt√ºn√º veya e≈üyanƒ± boyayarak yenile.",
                    "Telefonunla sanatsal bir 'G√∂lge Fotoƒürafƒ±' √ßek.",
                    "Sevdiƒüin bir ≈üarkƒ±nƒ±n s√∂zlerini bir kaƒüƒ±da g√ºzel yazƒ±yla yaz.",
                    "Bir karikat√ºr √ßiz."
                ],
                'Aile': [
                    "Evdeki bir tamir i≈üine veya temizliƒüe yardƒ±m et.", 
                    "Bula≈üƒ±k makinesini bo≈üalt veya yerle≈ütir.", 
                    "Ailenle eski fotoƒüraf alb√ºmlerine bak.",
                    "Ak≈üam √ßayƒ±nƒ±/kahvesini sen demle ve servis et.",
                    "Ailene bug√ºn √∂ƒürendiƒüin ilgin√ß bir ≈üeyi anlat.",
                    "Karde≈üine veya kuzenine bir konuda yardƒ±m et.",
                    "B√ºy√ºklerinle √ßocukluk anƒ±larƒ± hakkƒ±nda r√∂portaj yap."
                ],
                'Doƒüa': [
                    "Plastik atƒ±klarƒ± geri d√∂n√º≈ü√ºme ayƒ±r.", 
                    "Balkonda veya bah√ßede 10 dk sessizce otur ve dinle.", 
                    "Doƒüa fotoƒürafƒ± √ßek (Aƒüa√ß, b√∂cek veya g√∂ky√ºz√º).",
                    "Evin √∂n√ºn√º veya bah√ßeyi temizle.",
                    "Sokak hayvanlarƒ± i√ßin kapƒ±ya bir kap su koy.",
                    "Gereksiz yanan ƒ±≈üƒ±klarƒ± kapat, enerji tasarrufu yap.",
                    "Bir bitkinin bakƒ±mƒ±nƒ± √ºstlen."
                ],
                'Joker': [
                    "2 saat ekran detoksu yap (Telefon/Tablet yok!).", 
                    "Bir arkada≈üƒ±na 'Seni seviyorum' veya '√ñzledim' mesajƒ± at.",
                    "Bug√ºn yataƒüƒ±nƒ± toplama, daƒüƒ±nƒ±k kalsƒ±n! (≈ûaka, topla tabii).",
                    "Kendine bir 'Yapƒ±lacaklar Listesi' hazƒ±rla.",
                    "Bug√ºn tatlƒ± yeme hakkƒ±n var!"
                ]
            },
            'lise': {
                'Zeka': [
                    "√úniversite hedefinle ilgili bir b√∂l√ºm√º detaylƒ± ara≈ütƒ±r.", 
                    "ƒ∞lgi duyduƒüun konuda bir TEDx konu≈ümasƒ± izle.", 
                    "G√ºnde en az 40 sayfa kitap oku.",
                    "ƒ∞ngilizce bir makale veya haber oku.",
                    "Tarihte bug√ºn ne olduƒüunu ara≈ütƒ±r.",
                    "Bir kodlama diline (Python vb.) ba≈ülangƒ±√ß videosu izle.",
                    "G√ºnl√ºk tutmaya ba≈üla veya bug√ºn√º yaz."
                ],
                'Spor': [
                    "30 ≈üƒ±nav veya 50 squat yap.", 
                    "Sabah erken kalkƒ±p 30 dk y√ºr√ºy√º≈ü yap.", 
                    "Yoga veya meditasyon denemesi yap.",
                    "Evde kendi v√ºcut aƒüƒ±rlƒ±ƒüƒ±nla antrenman yap.",
                    "Varsa bisiklet s√ºr veya ip atla.",
                    "Post√ºr (Duru≈ü) egzersizleri yap.",
                    "G√ºnde 2 litre su i√ßmeyi hedefle."
                ],
                'Sanat': [
                    "Favori ≈üiirini ezberlemeye √ßalƒ±≈ü.", 
                    "Telefonunla 'Minimalist' bir fotoƒüraf √ßek.", 
                    "ƒ∞zlediƒüin bir filme ele≈ütiri yazƒ±sƒ± yaz.",
                    "Bir 'Mood Board' (ƒ∞lham panosu) hazƒ±rla (Pinterest vb.).",
                    "Kendi podcast kaydƒ±nƒ± yapmayƒ± dene (Sadece deneme).",
                    "Bir ≈üarkƒ±yƒ± farklƒ± bir tarzda mƒ±rƒ±ldan/s√∂yle.",
                    "Odanƒ±n dekorasyonunu deƒüi≈ütir."
                ],
                'Aile': [
                    "Bu ak≈üam yemeƒüini sen yap veya b√ºy√ºk katkƒ± saƒüla.", 
                    "Karde≈üine veya bir k√º√ß√ºƒü√ºne ders √ßalƒ±≈ütƒ±r.", 
                    "Ailenle siyaset dƒ±≈üƒ±, keyifli bir sohbet a√ß.",
                    "Ev alƒ±≈üveri≈üine √ßƒ±k veya listeyi hazƒ±rla.",
                    "Bozuk bir e≈üyayƒ± tamir etmeye √ßalƒ±≈ü.",
                    "Ailene bir film √∂nerisi yap ve birlikte izleyin.",
                    "B√ºy√ºklerini ara ve hatƒ±rlarƒ±nƒ± sor."
                ],
                'Doƒüa': [
                    "Sokak hayvanlarƒ± i√ßin mama al veya yap.", 
                    "Karbon ayak izini hesapla (ƒ∞nternetten test yap).", 
                    "Kullanmadƒ±ƒüƒ±n kƒ±yafetleri ayƒ±r ve baƒüƒ±≈üla.",
                    "Plastik kullanƒ±mƒ±nƒ± bug√ºn minimuma indir.",
                    "Yakƒ±ndaki bir parka git ve y√ºr√ºy√º≈ü yap.",
                    "Bir belgesel izle (Gezegenimiz vb.).",
                    "Odandaki kaƒüƒ±t atƒ±klarƒ± geri d√∂n√º≈ü√ºme g√∂nder."
                ],
                'Joker': [
                    "Yarƒ±m bƒ±raktƒ±ƒüƒ±n bir i≈üi tamamla.", 
                    "Kendine bir kariyer planƒ± veya vizyon panosu yap.",
                    "Eski bir arkada≈üƒ±nƒ± ara.",
                    "Bug√ºn sosyal medyayƒ± sadece 30 dakika kullan.",
                    "Kendine bir kahve ƒ±smarla veya g√ºzel bir i√ßecek hazƒ±rla."
                ]
            }
        };

        let currentUser = { name: "", grade: "" };
        let stats = { score: 0, completed: 0, history: [] };
        let currentRotation = 0;
        let isSpinning = false;
        let selectedCategory = null;
        let lastMissionText = ""; 

        // --- √áƒ∞Zƒ∞M ---
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        const centerX = width / 2;
        const centerY = height / 2;
        const radius = width / 2 - 10;
        const segmentAngle = (2 * Math.PI) / categories.length;

        function drawWheel() {
            ctx.clearRect(0, 0, width, height);
            
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(currentRotation);

            categories.forEach((cat, i) => {
                const angle = i * segmentAngle;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, radius, angle, angle + segmentAngle);
                ctx.fillStyle = cat.color;
                ctx.fill();
                ctx.stroke();

                ctx.save();
                ctx.rotate(angle + segmentAngle / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = "white";
                ctx.font = "bold 20px Fredoka";
                ctx.fillText(cat.name, radius - 20, 5);
                ctx.font = "24px Arial";
                ctx.fillText(cat.icon, radius - 80, 5);
                ctx.restore();
            });

            ctx.restore();
            
            ctx.beginPath();
            ctx.arc(centerX, centerY, 40, 0, 2 * Math.PI);
            ctx.fillStyle = "white";
            ctx.fill();
            ctx.lineWidth = 4;
            ctx.strokeStyle = "#e5e7eb";
            ctx.stroke();
        }

        // --- MANTIK ---
        
        function startGame() {
            const nameInput = document.getElementById('playerName').value.trim();
            const gradeInput = document.getElementById('playerGrade').value;

            if(!nameInput) {
                alert("L√ºtfen bir isim gir!");
                return;
            }

            initAudio(); // Ses motorunu ba≈ülat

            currentUser.name = nameInput;
            currentUser.grade = gradeInput;

            // LocalStorage'dan y√ºkle
            const storageKey = `tatil_${nameInput.toLowerCase()}_${gradeInput}`;
            const savedData = JSON.parse(localStorage.getItem(storageKey));
            
            if(savedData) {
                stats = savedData;
                if(!stats.history) stats.history = [];
            } else {
                stats = { score: 0, completed: 0, history: [] };
            }

            // Aray√ºz√º Hazƒ±rla
            document.getElementById('welcomeTitle').innerText = `Ho≈ü Geldin, ${currentUser.name}!`;
            
            let gradeText = "";
            if(gradeInput === 'ilkokul') gradeText = "ƒ∞LKOKUL SEVƒ∞YESƒ∞";
            else if(gradeInput === 'ortaokul') gradeText = "ORTAOKUL SEVƒ∞YESƒ∞";
            else gradeText = "Lƒ∞SE SEVƒ∞YESƒ∞";
            document.getElementById('gradeLabel').innerText = gradeText;
            
            updateStatsUI();
            updateHistoryUI();

            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'flex';
            
            drawWheel();
        }

        function goHome() {
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
        }

        function spinWheel() {
            if (isSpinning) return;
            isSpinning = true;
            document.getElementById('spinBtn').disabled = true;

            const duration = 4000;
            let startTime = null;
            let startRot = currentRotation;
            let finalRot = startRot + (Math.PI * 2 * 5) + (Math.random() * Math.PI * 4); 

            let lastAngleForSound = startRot;

            function step(timestamp) {
                if (!startTime) startTime = timestamp;
                const progress = Math.min((timestamp - startTime) / duration, 1);
                const ease = 1 - Math.pow(1 - progress, 4); // Quartic ease-out
                
                currentRotation = startRot + (finalRot - startRot) * ease;
                drawWheel();

                // SES TETƒ∞KLEME MANTIƒûI: Her dilim ge√ßi≈üinde ses √ßal
                // currentRotation radyan cinsinden. segmentAngle radyan cinsinden.
                // Ka√ß dilim ge√ßtiƒüimizi hesaplayalƒ±m.
                const currentStep = Math.floor(currentRotation / segmentAngle);
                const lastStep = Math.floor(lastAngleForSound / segmentAngle);
                
                if (currentStep > lastStep) {
                     playTick();
                     lastAngleForSound = currentRotation;
                }

                if (progress < 1) {
                    requestAnimationFrame(step);
                } else {
                    isSpinning = false;
                    document.getElementById('spinBtn').disabled = false;
                    determineWinner();
                }
            }
            requestAnimationFrame(step);
        }

        function determineWinner() {
            // MATEMATƒ∞KSEL D√úZELTME
            // ƒ∞bre tepede (270 derece / 3PI/2).
            // √áark saat y√∂n√ºnde d√∂n√ºyor (pozitif a√ßƒ± artƒ±≈üƒ±).
            // ƒ∞brenin g√∂sterdiƒüi a√ßƒ± = (270 - d√∂n√º≈üMiktarƒ±) (Mod√ºler aritmetikte)
            
            const normalizedRotation = currentRotation % (2 * Math.PI);
            
            // Pointer a√ßƒ±sƒ± (radyan olarak 3PI/2 yani 270 derece)
            const pointerAngle = (3 * Math.PI) / 2;
            
            // √áarkƒ±n √ºzerindeki hangi a√ßƒ±nƒ±n pointer'a denk geldiƒüini bulalƒ±m
            // √áizim yaparken rotate(currentRotation) yaptƒ±k.
            // Yani koordinat sistemi d√∂nd√º.
            // Pointer'ƒ±n yeni koordinat sistemindeki a√ßƒ±sƒ±:
            let relativeAngle = pointerAngle - normalizedRotation;
            
            // A√ßƒ±yƒ± 0 ile 2PI arasƒ±na sƒ±kƒ±≈ütƒ±r (Normalize et)
            while (relativeAngle < 0) relativeAngle += 2 * Math.PI;
            relativeAngle = relativeAngle % (2 * Math.PI);

            // Hangi dilime denk geldiƒüini bul
            // Index = A√ßƒ± / DilimGeni≈üliƒüi
            const index = Math.floor(relativeAngle / segmentAngle);
            
            selectedCategory = categories[index];

            // Sonucu g√∂ster (Hemen deƒüil, √ßok kƒ±sa bir bekleme ile, g√∂z yanƒ±lmasƒ±nƒ± √∂nlemek i√ßin)
            // Konfeti ve sesi burada, showResult i√ßinde √ßaƒüƒ±rƒ±yoruz.
            showResult(selectedCategory);
        }

        function showResult(category) {
            // SES VE KONFETƒ∞ BURADA (Tam durduƒüu an)
            playWin();
            
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: [category.color, '#ffffff']
            });
            
            const gradeMissions = missionsDB[currentUser.grade][category.name];
            
            let randomMission = "";
            let attempts = 0;
            
            do {
                randomMission = gradeMissions[Math.floor(Math.random() * gradeMissions.length)];
                attempts++;
            } while (randomMission === lastMissionText && attempts < 3);
            
            lastMissionText = randomMission;

            document.getElementById('mIcon').innerText = category.icon;
            document.getElementById('mCat').innerText = category.name;
            document.getElementById('mCat').style.color = category.color;
            document.getElementById('mCat').style.backgroundColor = category.color + "20";
            document.getElementById('mText').innerText = randomMission;

            const modal = document.getElementById('resultModal');
            modal.style.display = 'flex';
        }

        function closeModalWithoutPoint() {
            document.getElementById('resultModal').style.display = 'none';
        }

        function acceptMission() {
            // Puan Ekle
            stats.score += 20;
            stats.completed += 1;
            
            // Ge√ßmi≈üe Ekle
            const missionText = document.getElementById('mText').innerText;
            stats.history.unshift({ text: missionText, cat: document.getElementById('mCat').innerText });
            if(stats.history.length > 5) stats.history.pop(); 

            // Kaydet
            const storageKey = `tatil_${currentUser.name.toLowerCase()}_${currentUser.grade}`;
            localStorage.setItem(storageKey, JSON.stringify(stats));

            updateStatsUI();
            updateHistoryUI();

            document.getElementById('resultModal').style.display = 'none';
        }

        function updateStatsUI() {
            document.getElementById('score').innerText = stats.score;
            
            let rank = "√áaylak";
            let nextRankScore = 50;
            let currentBase = 0;

            if(stats.score >= 50) { rank = "Ka≈üif"; nextRankScore = 150; currentBase = 50; }
            if(stats.score >= 150) { rank = "Kaptan"; nextRankScore = 300; currentBase = 150; }
            if(stats.score >= 300) { rank = "Efsane"; nextRankScore = 500; currentBase = 300; }
            if(stats.score >= 500) { rank = "Lider"; nextRankScore = 1000; currentBase = 500; }

            document.getElementById('rankBadge').innerText = rank;

            let percent = 0;
            if (stats.score < 500) {
                 percent = ((stats.score - currentBase) / (nextRankScore - currentBase)) * 100;
                 document.getElementById('nextRankInfo').innerText = `Sonraki r√ºtbeye: ${nextRankScore - stats.score} Puan`;
            } else {
                percent = 100;
                document.getElementById('nextRankInfo').innerText = "Maksimum Seviye!";
            }
            
            document.getElementById('xpBar').style.width = `${percent}%`;
        }

        function updateHistoryUI() {
            const list = document.getElementById('historyList');
            if(stats.history.length === 0) {
                list.innerHTML = '<li class="history-item" style="justify-content: center; color: #9CA3AF;">Hen√ºz g√∂rev tamamlamadƒ±n.</li>';
                return;
            }
            
            let html = "";
            stats.history.forEach(h => {
                html += `
                    <li class="history-item">
                        <span>${h.text.substring(0, 30)}...</span>
                        <span class="history-score">+20</span>
                    </li>
                `;
            });
            list.innerHTML = html;
        }

    </script>
</body>
</html>
