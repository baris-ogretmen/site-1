<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mega Zeka: SÄ±nÄ±rsÄ±z Okul YarÄ±ÅŸmasÄ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- Tema ve Animasyonlar --- */
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            overscroll-behavior-y: none;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .font-fun { font-family: 'Fredoka', sans-serif; }

        /* Cam Efekti */
        .glass {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }

        /* Butonlar */
        .option-btn {
            transition: transform 0.1s, box-shadow 0.1s;
            touch-action: manipulation;
        }
        .option-btn:active { transform: scale(0.97); }
        @media (hover: hover) {
            .option-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        }

        /* Kura YazÄ±sÄ± */
        .raffle-text {
            font-size: clamp(3rem, 8vw, 6rem);
            font-weight: 900;
            background: linear-gradient(to right, #6366f1, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }

        /* Timer */
        .timer-fill {
            transition: width 1s linear;
        }

        /* Animasyonlar */
        .pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* Kategori Etiketi */
        .badge-cat {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 20;
        }
        .cat-mat { background: #3b82f6; }
        .cat-tr { background: #ef4444; }
        .cat-fen { background: #10b981; }
        .cat-sos { background: #f59e0b; }
        .cat-ing { background: #8b5cf6; }
        .cat-gen { background: #6366f1; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <!-- ==================== GÄ°RÄ°Å EKRANI ==================== -->
    <div id="setup-screen" class="w-full max-w-6xl glass rounded-3xl p-6 md:p-10 pop-in relative z-10 my-auto">
        <div class="text-center mb-8">
            <h1 class="font-fun text-4xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-2">
                MEGA ZEKA
            </h1>
            <p class="text-gray-600 font-bold uppercase tracking-widest text-sm md:text-base">SÄ±nÄ±rsÄ±z Soru FabrikasÄ±</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Ayarlar -->
            <div class="space-y-6">
                <div>
                    <label class="block text-gray-700 font-bold mb-2"><i class="fa-solid fa-layer-group text-blue-500 mr-2"></i>SÄ±nÄ±f Seviyesi</label>
                    <select id="grade-select" class="w-full p-4 rounded-xl bg-gray-50 border-2 border-gray-200 focus:border-blue-500 outline-none font-bold text-lg cursor-pointer">
                        <option value="0">ğŸ§¸ Anaokulu</option>
                        <option value="1">1ï¸âƒ£ 1. SÄ±nÄ±f</option>
                        <option value="2">2ï¸âƒ£ 2. SÄ±nÄ±f</option>
                        <option value="3">3ï¸âƒ£ 3. SÄ±nÄ±f</option>
                        <option value="4">4ï¸âƒ£ 4. SÄ±nÄ±f</option>
                        <option value="5">5ï¸âƒ£ 5. SÄ±nÄ±f</option>
                        <option value="6">6ï¸âƒ£ 6. SÄ±nÄ±f</option>
                        <option value="7">7ï¸âƒ£ 7. SÄ±nÄ±f</option>
                        <option value="8">8ï¸âƒ£ 8. SÄ±nÄ±f</option>
                    </select>
                </div>

                <div>
                    <label class="block text-gray-700 font-bold mb-2">
                        <i class="fa-solid fa-users text-pink-500 mr-2"></i>Ã–ÄŸrenci Listesi
                        <span id="player-status" class="float-right text-xs bg-gray-200 px-2 py-1 rounded text-gray-600">HenÃ¼z BaÅŸlamadÄ±</span>
                    </label>
                    <textarea id="student-list" rows="5" class="w-full p-4 rounded-xl bg-gray-50 border-2 border-gray-200 focus:border-pink-500 outline-none resize-none font-medium" placeholder="Ali&#10;AyÅŸe&#10;Mehmet..."></textarea>
                    <div class="flex justify-between mt-2">
                        <button onclick="fillSample()" class="text-sm text-blue-500 font-bold hover:underline">ğŸ² Ã–rnek Liste</button>
                        <span id="count-display" class="text-sm font-bold text-gray-500">0 KiÅŸi</span>
                    </div>
                </div>
            </div>

            <!-- Bilgi ve BaÅŸlat -->
            <div class="flex flex-col justify-center items-center gap-6 bg-white/50 p-6 rounded-2xl border border-white">
                <div class="text-center w-full">
                    <div class="grid grid-cols-3 gap-2 mb-4 text-xs font-bold text-white">
                        <span class="bg-blue-500 py-1 rounded">Matematik</span>
                        <span class="bg-red-500 py-1 rounded">TÃ¼rkÃ§e</span>
                        <span class="bg-green-500 py-1 rounded">Fen Bil.</span>
                        <span class="bg-yellow-500 py-1 rounded">Sosyal</span>
                        <span class="bg-purple-500 py-1 rounded">Ä°ngilizce</span>
                        <span class="bg-indigo-500 py-1 rounded">Genel K.</span>
                    </div>
                    <p class="text-gray-600 text-sm">
                        <i class="fa-solid fa-robot text-2xl mb-2 block text-blue-500"></i>
                        Sistem her Ã¶ÄŸrenci iÃ§in Ã¶zel, tekrarsÄ±z sorular Ã¼retir.
                        Adil seÃ§im modÃ¼lÃ¼ ile herkes sÄ±rayla yarÄ±ÅŸÄ±r.
                    </p>
                </div>

                <button onclick="initGameSession()" class="w-full py-5 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-black text-2xl shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all">
                    BAÅLAT
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== KURA EKRANI ==================== -->
    <div id="raffle-overlay" class="fixed inset-0 z-50 hidden flex-col items-center justify-center bg-white/95 backdrop-blur-xl">
        <h2 class="text-gray-400 font-bold tracking-[0.5em] mb-8 animate-pulse">YARIÅMACI SEÃ‡Ä°LÄ°YOR</h2>
        <div id="raffle-display" class="raffle-text">...</div>
        <div id="remaining-count" class="mt-8 text-gray-500 font-bold bg-gray-100 px-4 py-2 rounded-full text-sm">
            Kalan Ã–ÄŸrenci: 0
        </div>
    </div>

    <!-- ==================== OYUN EKRANI ==================== -->
    <div id="game-screen" class="hidden w-full max-w-7xl h-full flex flex-col z-10">
        
        <!-- Ãœst Bar -->
        <div class="flex items-center justify-between bg-white rounded-2xl p-4 shadow-lg mb-4">
            <div class="flex items-center gap-3">
                <div class="hidden md:block bg-gray-100 px-3 py-1 rounded-lg font-bold text-gray-600 text-sm">
                    <i class="fa-solid fa-graduation-cap"></i> <span id="game-grade">5</span>
                </div>
                <div class="bg-blue-50 px-3 py-1 rounded-lg font-bold text-blue-600 text-xl font-mono">
                    <span id="q-curr">1</span>/<span id="q-total">10</span>
                </div>
            </div>

            <div class="relative w-full max-w-xs mx-4">
                <div class="h-3 bg-gray-200 rounded-full overflow-hidden">
                    <div id="timer-bar" class="h-full bg-green-500 timer-fill w-full"></div>
                </div>
                <div id="timer-text" class="absolute top-4 left-1/2 transform -translate-x-1/2 font-mono font-bold text-gray-400 text-xs">30sn</div>
            </div>

            <div class="bg-yellow-100 px-4 py-2 rounded-xl font-black text-yellow-700 text-xl flex items-center gap-2">
                <i class="fa-solid fa-star"></i> <span id="score">0</span>
            </div>
        </div>

        <!-- Ana Alan -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-grow">
            <!-- Rakipler Sol -->
            <div class="hidden lg:flex col-span-2 flex-col gap-4" id="rivals-left"></div>

            <!-- Soru KartÄ± -->
            <div class="col-span-1 lg:col-span-8 flex flex-col h-full">
                <div class="glass rounded-[2rem] p-6 md:p-10 flex-grow relative flex flex-col justify-center">
                    
                    <!-- Kategori Rozeti -->
                    <div id="cat-badge" class="badge-cat cat-mat">MATEMATÄ°K</div>

                    <!-- YarÄ±ÅŸmacÄ± -->
                    <div class="absolute top-0 left-0 w-full flex justify-center -mt-8">
                        <div class="bg-white p-2 rounded-full shadow-lg">
                            <div class="bg-gradient-to-br from-blue-400 to-purple-500 text-white w-16 h-16 md:w-20 md:h-20 rounded-full flex items-center justify-center font-bold text-2xl shadow-inner">
                                <i class="fa-solid fa-user"></i>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-8 mb-6">
                        <h2 id="player-name" class="font-bold text-xl text-gray-800">Ã–ÄŸrenci AdÄ±</h2>
                    </div>

                    <!-- Soru -->
                    <div class="flex-grow flex items-center justify-center py-4">
                        <h3 id="question-text" class="text-2xl md:text-4xl font-bold text-center text-gray-700 leading-snug">
                            Soru HazÄ±rlanÄ±yor...
                        </h3>
                    </div>

                    <!-- ÅÄ±klar -->
                    <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-auto">
                        <!-- JS Dolduracak -->
                    </div>
                </div>
            </div>

            <!-- Rakipler SaÄŸ & Durum -->
            <div class="hidden lg:flex col-span-2 flex-col gap-6 items-center">
                <div class="w-full space-y-4" id="rivals-right"></div>
                <div class="mt-auto bg-white p-4 rounded-xl shadow-lg w-full text-center">
                    <span class="text-xs font-bold text-gray-400 uppercase">Seri (Combo)</span>
                    <div id="combo-box" class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-red-500">x1</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== SONUÃ‡ MODALI ==================== -->
    <div id="result-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-white rounded-3xl p-8 max-w-lg w-full text-center pop-in relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-purple-500"></div>
            
            <i class="fa-solid fa-trophy text-6xl text-yellow-400 mb-4 shadow-yellow-200 drop-shadow-lg"></i>
            <h2 class="text-4xl font-black text-gray-800 mb-2">OYUN BÄ°TTÄ°</h2>
            <p id="res-player" class="text-xl font-bold text-purple-600 mb-6">Ã–ÄŸrenci</p>

            <div class="grid grid-cols-3 gap-4 mb-8">
                <div class="bg-gray-50 p-3 rounded-xl"><div class="text-xs text-gray-500 font-bold">PUAN</div><div id="res-score" class="text-2xl font-black text-blue-600">0</div></div>
                <div class="bg-gray-50 p-3 rounded-xl"><div class="text-xs text-gray-500 font-bold">DOÄRU</div><div id="res-correct" class="text-2xl font-black text-green-600">0</div></div>
                <div class="bg-gray-50 p-3 rounded-xl"><div class="text-xs text-gray-500 font-bold">YANLIÅ</div><div id="res-wrong" class="text-2xl font-black text-red-600">0</div></div>
            </div>

            <div class="flex flex-col gap-3">
                <button onclick="nextPlayer()" class="w-full py-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl shadow-lg transition">
                    <i class="fa-solid fa-forward mr-2"></i> SÄ±radaki Ã–ÄŸrenci
                </button>
                <button onclick="exitToMenu()" class="w-full py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-xl transition">
                    <i class="fa-solid fa-home mr-2"></i> Ana MenÃ¼
                </button>
            </div>
        </div>
    </div>

    <script>
        /* ==========================================================================
           1. SORU FABRÄ°KASI (SÄ±nÄ±rsÄ±z Soru Motoru)
           ========================================================================== */
        
        // YardÄ±mcÄ±: Rastgele sayÄ±
        const rnd = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        // YardÄ±mcÄ±: Diziden rastgele Ã¶ÄŸe
        const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
        
        // VeritabanÄ± ParÃ§alarÄ± (Generators iÃ§in)
        const db = {
            tr_synonyms: [['Al', 'KÄ±rmÄ±zÄ±'], ['Ak', 'Beyaz'], ['Kara', 'Siyah'], ['Okul', 'Mektep'], ['Ã–ÄŸrenci', 'Talebe'], ['Doktor', 'Hekim'], ['YaÅŸlÄ±', 'Ä°htiyar'], ['Konuk', 'Misafir'], ['Hediye', 'ArmaÄŸan'], ['YÄ±l', 'Sene'], ['Cevap', 'YanÄ±t'], ['Kelime', 'SÃ¶zcÃ¼k']],
            tr_antonyms: [['Siyah', 'Beyaz'], ['Uzun', 'KÄ±sa'], ['BÃ¼yÃ¼k', 'KÃ¼Ã§Ã¼k'], ['AÅŸaÄŸÄ±', 'YukarÄ±'], ['Var', 'Yok'], ['Gel', 'Git'], ['AÃ§Ä±k', 'KapalÄ±'], ['SÄ±cak', 'SoÄŸuk'], ['GenÃ§', 'YaÅŸlÄ±'], ['Dolu', 'BoÅŸ'], ['Gece', 'GÃ¼ndÃ¼z'], ['Dost', 'DÃ¼ÅŸman']],
            eng_vocab: [['Apple', 'Elma'], ['Red', 'KÄ±rmÄ±zÄ±'], ['Cat', 'Kedi'], ['Dog', 'KÃ¶pek'], ['School', 'Okul'], ['Pencil', 'Kalem'], ['Blue', 'Mavi'], ['Book', 'Kitap'], ['Teacher', 'Ã–ÄŸretmen'], ['House', 'Ev'], ['Car', 'Araba'], ['Water', 'Su'], ['Sun', 'GÃ¼neÅŸ'], ['Moon', 'Ay'], ['Star', 'YÄ±ldÄ±z']],
            science_planets: ['MerkÃ¼r', 'VenÃ¼s', 'DÃ¼nya', 'Mars', 'JÃ¼piter', 'SatÃ¼rn', 'UranÃ¼s', 'NeptÃ¼n'],
            social_cities: ['Ankara', 'Ä°stanbul', 'Ä°zmir', 'Antalya', 'Bursa', 'Adana', 'Konya', 'Trabzon', 'Erzurum', 'DiyarbakÄ±r'],
            social_regions: ['Akdeniz', 'Karadeniz', 'Ege', 'Marmara', 'Ä°Ã§ Anadolu', 'DoÄŸu Anadolu', 'GÃ¼neydoÄŸu Anadolu']
        };

        // --- Generator FonksiyonlarÄ± ---

        function genMath(grade) {
            let n1, n2, ans, q, opts = [];
            let g = parseInt(grade);
            
            if (g === 0) { // Anaokulu: Basit sayma/toplama
                n1 = rnd(1,5); n2 = rnd(1,3); ans = n1+n2; q = `${n1} elma + ${n2} elma kaÃ§ eder? ğŸ`;
            } else if (g <= 2) { // 1-2: Toplama/Ã‡Ä±karma
                if (Math.random() > 0.5) { n1=rnd(5,20); n2=rnd(1,9); ans=n1+n2; q = `${n1} + ${n2} = ?`; }
                else { n1=rnd(10,20); n2=rnd(1,9); ans=n1-n2; q = `${n1} - ${n2} = ?`; }
            } else if (g <= 4) { // 3-4: Ã‡arpma
                n1=rnd(2,9); n2=rnd(2,9); ans=n1*n2; q = `${n1} x ${n2} = ?`;
            } else if (g <= 6) { // 5-6: BÃ¶lme/BÃ¼yÃ¼k Ä°ÅŸlem
                n2=rnd(2,9); ans=rnd(5,15); n1=n2*ans; q = `${n1} Ã· ${n2} = ?`;
            } else { // 7-8: ÃœslÃ¼/KÃ¶k/Cebir
                let type = rnd(1,3);
                if (type === 1) { ans=rnd(2,12); q = `${ans} sayÄ±sÄ±nÄ±n karesi (${ans}Â²) kaÃ§tÄ±r?`; ans=ans*ans; }
                else if (type === 2) { let sq=rnd(2,12); ans=sq; sq=sq*sq; q = `âˆš${sq} kaÃ§tÄ±r?`; }
                else { n1=rnd(2,5); n2=rnd(10,50); ans=(n2-n1); q = `x + ${n1} = ${n2} ise x kaÃ§tÄ±r?`; }
            }

            // ÅÄ±k Ã¼retimi
            let fakes = new Set();
            while(fakes.size < 3) {
                let f = ans + rnd(-5, 5);
                if (f !== ans && f >= 0) fakes.add(f);
            }
            return { cat: 'mat', q: q, opts: [ans, ...fakes] };
        }

        function genTurkish(grade) {
            let type = rnd(1, 2);
            let pair, q, ans, pool;
            
            if (grade === '0') return genGeneral(grade); // Anaokulu iÃ§in pas

            if (type === 1) { // EÅŸ Anlam
                pair = pick(db.tr_synonyms);
                q = `"${pair[0]}" kelimesinin eÅŸ anlamlÄ±sÄ± nedir?`;
                ans = pair[1];
                pool = db.tr_synonyms.map(p => p[1]);
            } else { // ZÄ±t Anlam
                pair = pick(db.tr_antonyms);
                q = `"${pair[0]}" kelimesinin zÄ±t anlamlÄ±sÄ± nedir?`;
                ans = pair[1];
                pool = db.tr_antonyms.map(p => p[1]);
            }
            
            let fakes = new Set();
            while(fakes.size < 3) {
                let f = pick(pool);
                if(f !== ans) fakes.add(f);
            }
            return { cat: 'tr', q: q, opts: [ans, ...fakes] };
        }

        function genEnglish(grade) {
            if (grade === '0') return genGeneral(grade);
            
            let pair = pick(db.eng_vocab);
            let direction = Math.random() > 0.5;
            let q, ans, pool;

            if (direction) {
                q = `"${pair[0]}" kelimesinin TÃ¼rkÃ§esi nedir?`;
                ans = pair[1];
                pool = db.eng_vocab.map(p => p[1]);
            } else {
                q = `"${pair[1]}" kelimesinin Ä°ngilizcesi nedir?`;
                ans = pair[0];
                pool = db.eng_vocab.map(p => p[0]);
            }

            let fakes = new Set();
            while(fakes.size < 3) {
                let f = pick(pool);
                if(f !== ans) fakes.add(f);
            }
            return { cat: 'ing', q: q, opts: [ans, ...fakes] };
        }

        function genScience(grade) {
            if(grade === '0') return genGeneral(grade);
            
            // Gezegen sorusu ÅŸablonu
            let planet = pick(db.science_planets);
            let q = `GÃ¼neÅŸ sistemindeki gezegenlerden biri hangisidir? (Cevap: ${planet})`; 
            // Basit tutmak iÃ§in cevabÄ± ÅŸÄ±klar arasÄ±ndan buldurma mantÄ±ÄŸÄ±
            // Daha geliÅŸmiÅŸ: "KÄ±zÄ±l gezegen hangisidir?" -> Mars.
            // Åimdilik basit ÅŸablon:
            
            let type = rnd(1,2);
            let ans, fakesArr;
            
            if (type === 1) {
                ans = pick(['KatÄ±', 'SÄ±vÄ±', 'Gaz']);
                q = `Buz, maddenin hangi halidir? (Cevap: KatÄ±)`;
                if (ans === 'SÄ±vÄ±') q = `Su, maddenin hangi halidir?`;
                if (ans === 'Gaz') q = `Su buharÄ±, maddenin hangi halidir?`;
                fakesArr = ['KatÄ±', 'SÄ±vÄ±', 'Gaz', 'Plazma'].filter(x => x !== ans);
            } else {
                ans = pick(db.science_planets);
                q = "AÅŸaÄŸÄ±dakilerden hangisi bir gezegendir?";
                fakesArr = ['Ay', 'GÃ¼neÅŸ', 'YÄ±ldÄ±z', 'Kuyruklu YÄ±ldÄ±z'];
            }
            
            return { cat: 'fen', q: q, opts: [ans, ...fakesArr.slice(0,3)] };
        }
        
        function genSocial(grade) {
             if(grade === '0') return genGeneral(grade);
             
             let city = pick(db.social_cities);
             let q = `${city} hangi Ã¼lkenin ilidir?`;
             let ans = "TÃ¼rkiye";
             let fakes = ["Almanya", "Fransa", "Ä°talya"];
             
             // Daha zor: BÃ¶lge sorusu
             if (Math.random() > 0.5) {
                 ans = pick(db.social_regions);
                 q = `${ans} BÃ¶lgesi TÃ¼rkiye'nin bir bÃ¶lgesidir. DoÄŸru mu?`;
                 // ÅÄ±klarÄ± bÃ¶lge isimleri yapalÄ±m
                 q = "AÅŸaÄŸÄ±dakilerden hangisi TÃ¼rkiye'nin bir bÃ¶lgesidir?";
                 fakes = ["Amazon", "Sibirya", "Alpler"];
             }

             return { cat: 'sos', q: q, opts: [ans, ...fakes] };
        }

        function genGeneral(grade) {
             // Anaokulu ve genel kÃ¼ltÃ¼r
             let q, ans, fakes;
             let type = rnd(1,3);
             
             if(type === 1) {
                 ans = "Mavi"; q = "GÃ¶kyÃ¼zÃ¼ ne renktir?"; fakes = ["YeÅŸil", "KÄ±rmÄ±zÄ±", "Mor"];
             } else if (type === 2) {
                 ans = "KÄ±ÅŸ"; q = "Hangi mevsimde kar yaÄŸar?"; fakes = ["Yaz", "Bahar", "GÃ¼z"];
             } else {
                 ans = "7"; q = "Bir haftada kaÃ§ gÃ¼n vardÄ±r?"; fakes = ["5", "10", "12"];
             }
             return { cat: 'gen', q: q, opts: [ans, ...fakes] };
        }

        function generateQuestion(grade) {
            // SÄ±nÄ±fa gÃ¶re kategori aÄŸÄ±rlÄ±klarÄ±
            let g = parseInt(grade);
            let roll = Math.random();
            
            // Kategori seÃ§imi
            if (g === 0) return genGeneral(grade);
            
            // 1-3. SÄ±nÄ±f: %40 Mat, %40 TR, %20 Hayat Bilgisi
            if (g <= 3) {
                if(roll < 0.4) return genMath(grade);
                if(roll < 0.8) return genTurkish(grade);
                return genGeneral(grade);
            }
            
            // 4-8. SÄ±nÄ±f: Dengeli daÄŸÄ±lÄ±m
            if (roll < 0.20) return genMath(grade);
            if (roll < 0.40) return genTurkish(grade);
            if (roll < 0.60) return genScience(grade);
            if (roll < 0.80) return genSocial(grade);
            return genEnglish(grade);
        }

        /* ==========================================================================
           2. OYUN YÃ–NETÄ°MÄ° (OYUNCU HAVUZU VE MANTIÄI)
           ========================================================================== */
        
        let session = {
            grade: '5',
            allPlayers: [],
            remainingPlayers: [], // Oynamayanlar
            currentPlayer: null,
            score: 0,
            combo: 1,
            qIndex: 0,
            correct: 0,
            wrong: 0,
            questionHistory: new Set(), // Soru tekrarÄ±nÄ± Ã¶nlemek iÃ§in hash tutabiliriz (basit versiyonda metni tutuyoruz)
            timer: 30,
            interval: null
        };

        const el = id => document.getElementById(id);

        function fillSample() {
            el('student-list').value = "Ahmet\nMehmet\nAyÅŸe\nFatma\nZeynep\nCan\nEfe\nElif\nBurak\nSelin";
            updateCount();
        }

        el('student-list').addEventListener('input', updateCount);
        function updateCount() {
            const list = el('student-list').value.split('\n').filter(x => x.trim());
            el('count-display').innerText = `${list.length} KiÅŸi`;
        }

        function initGameSession() {
            const rawList = el('student-list').value.split('\n').filter(x => x.trim());
            
            if (rawList.length === 0) {
                alert("LÃ¼tfen en az bir Ã¶ÄŸrenci ismi girin!");
                return;
            }

            session.grade = el('grade-select').value;
            session.allPlayers = rawList;
            session.remainingPlayers = [...rawList]; // Havuzu doldur
            
            // UI GÃ¼ncelle
            el('setup-screen').classList.add('hidden');
            el('player-status').innerText = "Devam Ediyor";
            
            startRaffle();
        }

        /* ==========================================================================
           3. KURA VE OYUN AKIÅI
           ========================================================================== */

        function startRaffle() {
            // EÄŸer kimse kalmadÄ±ysa havuzu sÄ±fÄ±rla (DÃ¶ngÃ¼)
            if (session.remainingPlayers.length === 0) {
                session.remainingPlayers = [...session.allPlayers];
                alert("TÃ¼m sÄ±nÄ±f yarÄ±ÅŸtÄ±! Liste baÅŸa dÃ¶nÃ¼yor.");
            }

            el('raffle-overlay').classList.remove('hidden');
            el('raffle-overlay').classList.add('flex');
            el('remaining-count').innerText = `SÄ±radaki Havuzu: ${session.remainingPlayers.length} KiÅŸi`;

            // Animasyon
            let pool = session.remainingPlayers;
            let counter = 0;
            let rounds = 0;
            let speed = 50;
            const disp = el('raffle-display');

            const spin = () => {
                disp.innerText = pool[counter % pool.length];
                counter++;
                rounds++;
                
                if (rounds > 20 && speed > 200) {
                    // SeÃ§im Bitti
                    setTimeout(() => {
                        // SeÃ§ilen kiÅŸiyi bul ve havuzdan Ã§Ä±kar
                        let selectedName = disp.innerText;
                        let idx = session.remainingPlayers.indexOf(selectedName);
                        if (idx > -1) session.remainingPlayers.splice(idx, 1);
                        
                        finalizePlayer(selectedName);
                    }, 1000);
                    return;
                }

                if (rounds > 15) speed += 30;
                setTimeout(spin, speed);
            }
            spin();
        }

        function finalizePlayer(name) {
            session.currentPlayer = name;
            el('raffle-overlay').classList.add('hidden');
            el('raffle-overlay').classList.remove('flex');
            
            // Oyunu SÄ±fÄ±rla
            session.score = 0;
            session.qIndex = 0;
            session.combo = 1;
            session.correct = 0;
            session.wrong = 0;
            session.questionHistory.clear(); // Her Ã¶ÄŸrenci iÃ§in sÄ±fÄ±rla (veya global tutulabilir, ÅŸimdilik per-student)
            
            startGame();
        }

        function startGame() {
            el('game-screen').classList.remove('hidden');
            el('result-modal').classList.remove('flex');
            el('result-modal').classList.add('hidden');
            
            el('player-name').innerText = session.currentPlayer;
            el('game-grade').innerText = session.grade === '0' ? 'Anaokulu' : session.grade + '. SÄ±nÄ±f';
            
            // Rakipler (SÃ¼s)
            renderRivals();
            
            nextQuestion();
        }

        function renderRivals() {
            const bots = ["Robot Alfa", "Beta", "Gama", "Delta"];
            const l = el('rivals-left');
            const r = el('rivals-right');
            l.innerHTML = ''; r.innerHTML = '';
            
            bots.forEach((b, i) => {
                const html = `<div class="bg-white p-2 rounded-xl shadow opacity-70 flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-gray-200"></div><span class="text-xs font-bold text-gray-500">${b}</span></div>`;
                if(i<2) l.innerHTML += html; else r.innerHTML += html;
            });
        }

        function nextQuestion() {
            if (session.qIndex >= 10) {
                endGame();
                return;
            }

            session.qIndex++;
            el('q-curr').innerText = session.qIndex;
            el('score').innerText = session.score;
            el('combo-box').innerText = "x" + session.combo;

            // Soru Ãœret (EÅŸsizlik KontrolÃ¼)
            let qData;
            let attempts = 0;
            do {
                qData = generateQuestion(session.grade);
                attempts++;
            } while (session.questionHistory.has(qData.q) && attempts < 10);
            
            session.questionHistory.add(qData.q);

            // UI Bas
            el('question-text').innerText = qData.q;
            
            // Kategori Rengi
            const badge = el('cat-badge');
            badge.className = 'badge-cat';
            badge.classList.add(`cat-${qData.cat}`);
            const names = {mat:'MATEMATÄ°K', tr:'TÃœRKÃ‡E', fen:'FEN BÄ°L.', sos:'SOSYAL', ing:'Ä°NGÄ°LÄ°ZCE', gen:'GENEL K.'};
            badge.innerText = names[qData.cat];

            // ÅÄ±klar
            const grid = el('options-container');
            grid.innerHTML = '';
            
            let opts = qData.opts.map((txt, i) => ({ txt, isCorrect: i===0 }));
            opts.sort(() => Math.random() - 0.5); // ÅÄ±klarÄ± karÄ±ÅŸtÄ±r

            opts.forEach(o => {
                let btn = document.createElement('button');
                btn.className = "option-btn w-full p-4 bg-white text-gray-700 font-bold rounded-xl shadow-md border-b-4 border-gray-200 text-lg md:text-xl";
                btn.innerText = o.txt;
                btn.onclick = () => handleAnswer(btn, o.isCorrect);
                grid.appendChild(btn);
            });

            // Timer BaÅŸlat
            startTimer();
        }

        function startTimer() {
            clearInterval(session.interval);
            session.timer = 30;
            updateTimerUI();
            session.interval = setInterval(() => {
                session.timer--;
                updateTimerUI();
                if (session.timer <= 0) {
                    clearInterval(session.interval);
                    handleAnswer(null, false); // SÃ¼re bitti
                }
            }, 1000);
        }

        function updateTimerUI() {
            el('timer-text').innerText = session.timer + "sn";
            el('timer-bar').style.width = (session.timer/30)*100 + "%";
            if (session.timer < 10) el('timer-bar').classList.replace('bg-green-500', 'bg-red-500');
            else el('timer-bar').classList.replace('bg-red-500', 'bg-green-500');
        }

        function handleAnswer(btn, isCorrect) {
            clearInterval(session.interval);
            // ButonlarÄ± kilitle
            const btns = document.querySelectorAll('.option-btn');
            btns.forEach(b => b.disabled = true);

            if (isCorrect) {
                if(btn) {
                    btn.classList.remove('bg-white', 'text-gray-700');
                    btn.classList.add('bg-green-500', 'text-white', 'border-green-700');
                }
                let pts = Math.round((100 + session.timer) * session.combo);
                session.score += pts;
                session.correct++;
                session.combo = Math.min(session.combo + 0.5, 5);
                playSound(true);
            } else {
                if(btn) {
                    btn.classList.remove('bg-white', 'text-gray-700');
                    btn.classList.add('bg-red-500', 'text-white', 'border-red-700', 'shake');
                }
                session.wrong++;
                session.combo = 1;
                playSound(false);
                
                // DoÄŸruyu gÃ¶ster
                // (Burada basitlik iÃ§in doÄŸru cevabÄ± bulup yeÅŸil yapabiliriz ama kod uzamasÄ±n diye geÃ§iyorum)
            }

            setTimeout(nextQuestion, 1500);
        }

        // --- Oyun Sonu ---

        function endGame() {
            el('game-screen').classList.add('hidden');
            el('result-modal').classList.remove('hidden');
            el('result-modal').classList.add('flex');
            
            el('res-player').innerText = session.currentPlayer;
            el('res-score').innerText = session.score;
            el('res-correct').innerText = session.correct;
            el('res-wrong').innerText = session.wrong;
        }

        function nextPlayer() {
            el('result-modal').classList.add('hidden');
            el('result-modal').classList.remove('flex');
            startRaffle();
        }

        function exitToMenu() {
            el('result-modal').classList.add('hidden');
            el('result-modal').classList.remove('flex');
            el('setup-screen').classList.remove('hidden');
        }

        // Basit ses efekti (AudioContext yerine basit gÃ¶rsel feedback yeterli, ama structure hazÄ±r)
        function playSound(success) {
            // Ä°stenirse buraya beep sesi eklenebilir.
        }

    </script>
</body>
</html>

