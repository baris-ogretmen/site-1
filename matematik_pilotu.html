<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Matematik Pilotu: G√∂ky√ºz√º Macerasƒ±</title>
    <style>
        body {
            overflow: hidden;
            margin: 0;
            background: linear-gradient(to bottom, #0f172a 0%, #1e3a8a 30%, #3b82f6 60%, #93c5fd 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        /* Aray√ºz (UI) */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .score-box {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 1.4rem;
            font-weight: bold;
            color: #fff;
            border: 2px solid rgba(255,255,255,0.4);
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #question-box {
            background: rgba(255, 255, 255, 0.95);
            color: #1e3a8a;
            padding: 10px 30px;
            border-radius: 25px;
            font-size: 2.5rem;
            font-weight: 900;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            border: 5px solid #f59e0b;
            min-width: 200px;
            transition: transform 0.3s;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        #settings-btn {
            pointer-events: auto;
            background: #fff;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            color: #333;
        }
        #settings-btn:active { transform: scale(0.9); }

        #control-hint {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.2rem;
            font-weight: bold;
            color: rgba(255,255,255,0.9);
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            pointer-events: none;
            background: rgba(0,0,0,0.4);
            padding: 8px 25px;
            border-radius: 30px;
            animation: pulse 2s infinite;
            display: none; /* JS ile g√∂sterilecek */
        }

        @keyframes pulse {
            0% { transform: translateX(-50%) scale(1); opacity: 0.8; }
            50% { transform: translateX(-50%) scale(1.05); opacity: 1; }
            100% { transform: translateX(-50%) scale(1); opacity: 0.8; }
        }

        #feedback-msg {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            font-weight: 900;
            text-shadow: 0 5px 20px rgba(0,0,0,0.4), 0 0 50px rgba(255,255,255,0.8);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 20;
            pointer-events: none;
            white-space: nowrap;
        }

        /* Ortak Modal */
        .modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            color: #333;
            padding: 25px;
            border-radius: 25px;
            width: 85%;
            max-width: 450px;
            pointer-events: auto;
            box-shadow: 0 25px 80px rgba(0,0,0,0.6);
            z-index: 100;
            text-align: center;
        }

        /* Giri≈ü Ekranƒ± √ñzel */
        #start-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
        }

        .title-text {
            font-size: 2.5rem;
            color: #1e3a8a;
            margin-bottom: 10px;
            font-weight: 900;
        }
        
        .subtitle-text {
            font-size: 1.2rem;
            color: #64748b;
            margin-bottom: 30px;
        }

        .modal h2 { margin-top: 0; color: #1e3a8a; font-size: 2rem; }
        .modal-row { margin-bottom: 15px; text-align: left; }
        .modal-row label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 1.1rem; color: #475569; }
        select {
            width: 100%; padding: 12px; font-size: 1.1rem; border-radius: 12px; border: 2px solid #e2e8f0;
            background: #f8fafc; color: #334155;
        }
        
        button.action-btn {
            width: 100%; padding: 15px; font-size: 1.5rem; border-radius: 15px;
            background: linear-gradient(to right, #3b82f6, #2563eb); 
            color: white; border: none; font-weight: bold; margin-top: 10px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        button.action-btn:active { transform: scale(0.98); box-shadow: 0 2px 5px rgba(37, 99, 235, 0.4); }
        button.restart-btn { background: linear-gradient(to right, #22c55e, #16a34a); box-shadow: 0 4px 15px rgba(22, 163, 74, 0.4); }

        .final-stars { font-size: 3rem; color: #fbbf24; margin: 20px 0; text-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .passenger-list { margin-top: 15px; font-size: 2.2rem; line-height: 1.4; letter-spacing: 5px; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="top-bar">
            <div class="score-box">
                <span>‚≠ê <span id="score-text">0</span></span>
                <span style="opacity: 0.5">|</span>
                <span style="font-size: 1rem;" id="progress-text">1/10</span>
            </div>
            <div id="question-box">???</div>
            <button id="settings-btn" onclick="toggleSettings()">‚öôÔ∏è</button>
        </div>
        <div id="control-hint">üëÜ U√ßaƒüƒ± parmaƒüƒ±nla s√ºr√ºkle!</div>
    </div>

    <div id="feedback-msg">Harika!</div>

    <!-- Giri≈ü Ekranƒ± -->
    <div id="start-screen" class="modal" style="display: flex;">
        <div class="title-text">Matematik Pilotu</div>
        <div class="subtitle-text">Yolcular seni bekliyor Kaptan!</div>
        <div style="font-size: 4rem; margin-bottom: 20px;">‚úàÔ∏è</div>
        <button class="action-btn" onclick="startGame()">U√áU≈ûA BA≈ûLA</button>
    </div>

    <!-- Ayarlar Modalƒ± -->
    <div id="settings-modal" class="modal">
        <h2>Ayarlar</h2>
        <div class="modal-row">
            <label>Ders Modu:</label>
            <select id="mode-select">
                <option value="counting">Sayƒ±larƒ± Tanƒ±ma (Sayma)</option>
                <option value="addition">Basit Toplama (1-10)</option>
                <option value="addition_carry" selected>Eldeli Toplama (Zor)</option>
                <option value="subtraction">√áƒ±karma ƒ∞≈ülemi</option>
            </select>
        </div>
        <div class="modal-row">
            <label>Ses:</label>
            <select id="sound-select">
                <option value="on">A√ßƒ±k</option>
                <option value="off">Kapalƒ±</option>
            </select>
        </div>
        <button class="action-btn" onclick="saveSettings()">Kaydet ve Devam Et</button>
    </div>

    <!-- Biti≈ü Modalƒ± -->
    <div id="gameover-modal" class="modal">
        <h2>G√∂rev Tamamlandƒ±!</h2>
        <div class="final-stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
        <p>Harika bir i≈ü √ßƒ±kardƒ±n!</p>
        <div class="passenger-list" id="final-passengers"></div>
        <p style="font-size: 1.2rem; color: #64748b; margin-top: 10px;">Mutlu Yolcular</p>
        <button class="action-btn restart-btn" onclick="restartGame()">YENƒ∞ U√áU≈û</button>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        (function() {
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            const scoreText = document.getElementById("score-text");
            const progressText = document.getElementById("progress-text");
            const questionBox = document.getElementById("question-box");
            const feedbackMsg = document.getElementById("feedback-msg");
            const settingsModal = document.getElementById("settings-modal");
            const gameOverModal = document.getElementById("gameover-modal");
            const startScreen = document.getElementById("start-screen");
            const finalPassengersDiv = document.getElementById("final-passengers");
            const controlHint = document.getElementById("control-hint");

            let w, h;
            const { sin, cos, PI, abs, random, floor, atan2, hypot } = Math;
            const rnd = (min, max) => Math.random() * (max - min) + min;

            // --- Ses Sistemi (Web Audio API) ---
            let audioCtx = null;
            
            function initAudio() {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }

            function playSound(type) {
                if(config.sound === false || !audioCtx) return;
                if (audioCtx.state === 'suspended') audioCtx.resume();
                
                const osc = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                osc.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                const now = audioCtx.currentTime;

                if (type === 'success') { // Ding
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(500, now);
                    osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
                    gainNode.gain.setValueAtTime(0.2, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
                    osc.start(now); osc.stop(now + 0.6);
                } else if (type === 'passenger') { // Melodi
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(300, now);
                    osc.frequency.linearRampToValueAtTime(400, now + 0.1);
                    osc.frequency.linearRampToValueAtTime(600, now + 0.2);
                    gainNode.gain.setValueAtTime(0.2, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.5);
                    osc.start(now); osc.stop(now + 0.5);
                } else if (type === 'bump') { // Uyarƒ±
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                    gainNode.gain.setValueAtTime(0.1, now);
                    gainNode.gain.linearRampToValueAtTime(0.01, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                } else if (type === 'win') { // Zafer
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(400, now);
                    osc.frequency.setValueAtTime(600, now + 0.2);
                    osc.frequency.setValueAtTime(800, now + 0.4);
                    gainNode.gain.setValueAtTime(0.1, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 1.5);
                    osc.start(now); osc.stop(now + 1.5);
                }
            }

            // --- Ayarlar ---
            let config = {
                mode: 'addition_carry',
                tts: true,
                sound: true,
                maxQuestions: 10
            };

            // --- Oyun Durumu ---
            let game = {
                state: 'start', // start, playing, gameover
                score: 0,
                questionCount: 0,
                particles: [],
                bubbles: [],
                clouds: [],
                landscape: [],
                birds: [], // Ku≈ülar
                currentQuestion: { text: "", answer: 0 },
                questionTime: 0,
                time: 0
            };

            const passengerEmojis = ['üë©‚ÄçüöÄ', 'üëÆ‚Äç‚ôÇÔ∏è', 'üë®‚Äçüöí', 'üßë‚Äçüé®', 'üïµÔ∏è‚Äç‚ôÄÔ∏è', 'üßú‚Äç‚ôÇÔ∏è', 'üßô‚Äç‚ôÄÔ∏è', 'üßõ‚Äç‚ôÇÔ∏è', 'üßù‚Äç‚ôÄÔ∏è', 'üßû‚Äç‚ôÇÔ∏è'];
            
            // --- U√ßak ---
            let plane = {
                x: 0, y: 0, targetX: 0, targetY: 0, vx: 0, vy: 0, angle: 0,
                isDragging: false,
                passengers: [],

                addPassenger() {
                    if (this.passengers.length < config.maxQuestions) {
                        const newPassenger = passengerEmojis[this.passengers.length % passengerEmojis.length];
                        this.passengers.push(newPassenger);
                        playSound('passenger');
                        return newPassenger;
                    }
                    return null;
                },

                update() {
                    if (game.state !== 'playing') return;
                    
                    if (this.isDragging) {
                        this.vx = (this.targetX - this.x) * 0.12;
                        this.vy = (this.targetY - this.y) * 0.12;
                    } else {
                        this.vx *= 0.95; this.vy *= 0.95;
                        this.vy += sin(game.time * 2) * 0.05; // Salƒ±nƒ±m
                    }

                    this.x += this.vx;
                    this.y += this.vy;
                    // Sƒ±nƒ±r
                    this.x = Math.max(50, Math.min(w - 50, this.x));
                    this.y = Math.max(80, Math.min(h - 80, this.y));
                    // A√ßƒ±
                    this.angle = this.vx * 0.03;
                    this.angle = Math.max(Math.min(this.angle, 0.35), -0.35);
                },

                draw() {
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.angle);
                    const scale = 1.6;
                    ctx.scale(scale, scale);

                    // Pervane
                    ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
                    const propW = 5 + sin(game.time * 60) * 3;
                    ctx.beginPath(); ctx.ellipse(45, 0, 5, 28, 0, 0, PI*2); ctx.fill();

                    // Kanatlar
                    ctx.fillStyle = "#fbbf24";
                    ctx.beginPath(); ctx.roundRect(-20, -40, 30, 80, 6); ctx.fill();
                    ctx.strokeStyle = "#d97706"; ctx.lineWidth = 1; ctx.stroke();

                    // G√∂vde
                    ctx.fillStyle = "#f8fafc";
                    ctx.beginPath(); ctx.ellipse(0, 0, 50, 18, 0, 0, PI*2); ctx.fill();

                    // Kuyruk
                    ctx.fillStyle = "#ef4444";
                    ctx.beginPath(); ctx.moveTo(-35, 0); ctx.lineTo(-60, -22); ctx.lineTo(-50, 5); ctx.fill();

                    // Pencereler ve Yolcular (Son 3 yolcuyu g√∂ster)
                    const wins = [-20, -5, 10];
                    ctx.font = "12px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                    
                    for(let i=0; i<3; i++) {
                        ctx.fillStyle = "#3b82f6";
                        ctx.beginPath(); ctx.arc(wins[i], 2, 7, 0, PI*2); ctx.fill();
                        
                        // Sondan geriye doƒüru yolcularƒ± yerle≈ütir
                        const pIndex = this.passengers.length - 1 - (2-i);
                        if (pIndex >= 0 && this.passengers[pIndex]) {
                            ctx.fillStyle = "white"; 
                            ctx.beginPath(); ctx.arc(wins[i], 2, 6, 0, PI*2); ctx.fill();
                            ctx.fillText(this.passengers[pIndex], wins[i], 4);
                        } else {
                            // Bo≈ü
                            ctx.fillStyle = "rgba(255,255,255,0.4)";
                            ctx.beginPath(); ctx.arc(wins[i]-2, 0, 2, 0, PI*2); ctx.fill();
                        }
                    }

                    // Kokpit
                    ctx.fillStyle = "#0ea5e9";
                    ctx.beginPath(); ctx.ellipse(25, -5, 15, 10, 0, 0, PI*2); ctx.fill();
                    ctx.fillStyle = "rgba(255,255,255,0.9)";
                    ctx.beginPath(); ctx.ellipse(28, -7, 5, 2, -0.5, 0, PI*2); ctx.fill();

                    ctx.restore();
                }
            };

            // --- Arka Plan ---
            function initLandscape() {
                game.landscape = [];
                for(let i=0; i<15; i++) { // Daƒülar
                    game.landscape.push({
                        x: rnd(0, w), y: h, w: rnd(300, 600), h: rnd(150, 300),
                        color: `rgba(255, 255, 255, ${rnd(0.05, 0.2)})`, speed: 0.2, type: 'mountain'
                    });
                }
                for(let i=0; i<20; i++) { // Tepeler
                    game.landscape.push({
                        x: rnd(0, w), y: h + 50, r: rnd(150, 400),
                        color: `rgba(16, 185, 129, ${rnd(0.3, 0.6)})`, speed: 0.8, type: 'hill'
                    });
                }
            }

            function spawnBird() {
                if(game.birds.length < 5 && random() < 0.01) {
                    game.birds.push({
                        x: w + 50, y: rnd(50, h/2), speed: rnd(1, 3), 
                        size: rnd(15, 25), wingOffset: rnd(0, 100)
                    });
                }
            }

            // --- Soru Sistemi ---
            function generateQuestion() {
                if (game.questionCount >= config.maxQuestions) {
                    endGame(); return;
                }

                game.questionCount++;
                progressText.innerText = `${game.questionCount}/${config.maxQuestions}`;
                game.questionTime = game.time;
                
                let qText = "", ans = 0;
                
                if (config.mode === 'counting') {
                    ans = floor(rnd(1, 10)); qText = `Bu ${ans}`;
                } else if (config.mode === 'subtraction') {
                    let a = floor(rnd(5, 10)); let b = floor(rnd(1, a));
                    ans = a - b; qText = `${a} - ${b} = ?`;
                } else if (config.mode === 'addition_carry') {
                    let a = floor(rnd(5, 10)); let minB = 11 - a; let b = floor(rnd(minB, 10));
                    ans = a + b; qText = `${a} + ${b} = ?`;
                } else { 
                    let a = floor(rnd(1, 6)); let b = floor(rnd(1, 5));
                    ans = a + b; qText = `${a} + ${b} = ?`;
                }

                game.currentQuestion = { text: qText, answer: ans };
                questionBox.innerText = qText;
                questionBox.style.transform = "scale(1.2)";
                setTimeout(() => questionBox.style.transform = "scale(1)", 300);

                if (config.tts && config.sound) {
                    const cleanText = qText.replace('=', 'eder').replace('?', '').replace('-', 'eksi').replace('+', 'artƒ±');
                    speak(cleanText);
                }

                spawnBubbles(ans);
            }

            const balloonColors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];

            function spawnBubbles(correctAnswer) {
                game.bubbles = [];
                // Doƒüru
                game.bubbles.push(createBubble(correctAnswer, true));
                // Yanlƒ±≈ülar
                for(let i=0; i<3; i++) {
                    let wrong;
                    do { wrong = correctAnswer + floor(rnd(-5, 6)); } 
                    while(wrong === correctAnswer || wrong < 0);
                    game.bubbles.push(createBubble(wrong, false));
                }
            }

            function createBubble(val, isCorrect) {
                // Rastgele renk se√ß (Cevap rengi ele vermesin diye)
                const color = balloonColors[floor(rnd(0, balloonColors.length))];
                return {
                    x: w + rnd(50, 400), y: rnd(100, h - 250),
                    val: val, isCorrect: isCorrect,
                    r: 50, color: color,
                    speed: 2.0 * rnd(0.9, 1.1), wobble: rnd(0, 100)
                };
            }

            // --- Oyun Akƒ±≈üƒ± ---
            window.startGame = function() {
                initAudio();
                startScreen.style.display = 'none';
                game.state = 'playing';
                controlHint.style.display = 'block';
                setTimeout(() => controlHint.style.display = 'none', 4000);
                restartGame();
            };

            window.restartGame = function() {
                gameOverModal.style.display = 'none';
                game.state = 'playing';
                game.score = 0;
                game.questionCount = 0;
                scoreText.innerText = "0";
                plane.x = w * 0.2; plane.y = h * 0.4;
                plane.passengers = [];
                generateQuestion();
            };

            function endGame() {
                game.state = 'gameover';
                finalPassengersDiv.innerText = plane.passengers.join(" ");
                playSound('win');
                gameOverModal.style.display = 'block';
            }

            // --- Efektler ---
            class Particle {
                constructor(x, y, color) {
                    this.x = x; this.y = y; this.color = color;
                    const a = rnd(0, PI*2); const s = rnd(3, 8);
                    this.vx = cos(a) * s; this.vy = sin(a) * s;
                    this.life = 1.0; this.decay = rnd(0.02, 0.04);
                }
                update() {
                    this.x += this.vx; this.y += this.vy;
                    this.vy += 0.15; this.life -= this.decay;
                }
                draw() {
                    ctx.globalAlpha = Math.max(0, this.life);
                    ctx.fillStyle = this.color;
                    ctx.beginPath(); ctx.arc(this.x, this.y, 5, 0, PI*2); ctx.fill();
                    ctx.globalAlpha = 1;
                }
            }

            function showFeedback(text, color) {
                feedbackMsg.innerText = text;
                feedbackMsg.style.color = color;
                feedbackMsg.style.opacity = 1;
                feedbackMsg.style.transform = "translate(-50%, -50%) scale(1.3)";
                if(config.tts && config.sound) speak(text);
                setTimeout(() => {
                    feedbackMsg.style.opacity = 0;
                    feedbackMsg.style.transform = "translate(-50%, -50%) scale(1)";
                }, 1500);
            }

            function speak(text) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const ut = new SpeechSynthesisUtterance(text);
                    ut.lang = 'tr-TR';
                    window.speechSynthesis.speak(ut);
                }
            }

            // --- Update & Draw ---
            function update() {
                if(game.state !== 'playing' && game.state !== 'start') return;
                game.time += 0.016;
                plane.update();

                // Arka Plan Hareketi
                game.landscape.forEach(l => {
                    l.x -= l.speed;
                    if (l.type === 'mountain' && l.x < -l.w) l.x = w;
                    if (l.type === 'hill' && l.x < -l.r) l.x = w + l.r;
                });

                // Ku≈ülar
                spawnBird();
                game.birds.forEach((b, i) => {
                    b.x -= b.speed; b.y += sin(game.time * 5 + b.wingOffset) * 0.5;
                    if(b.x < -50) game.birds.splice(i, 1);
                });

                // S√ºs Bulutlarƒ±
                if(random() < 0.015) game.clouds.push({x: w+100, y: rnd(20, h/2), size: rnd(40, 70), speed: 1.2});
                game.clouds.forEach((c, i) => {
                    c.x -= c.speed;
                    if(c.x < -150) game.clouds.splice(i, 1);
                });

                // Balonlar
                if (game.state === 'playing') {
                    game.bubbles.forEach((b, i) => {
                        b.x -= b.speed;
                        b.y += sin(game.time * 2 + b.wobble) * 0.5;

                        const dist = hypot(plane.x - b.x, plane.y - b.y);
                        if(dist < b.r + 45) {
                            if(b.isCorrect) {
                                game.score += 10;
                                scoreText.innerText = game.score;
                                const p = plane.addPassenger();
                                showFeedback(p ? `Yolcu Bindi! ${p}` : "S√ºper!", "#4ade80");
                                playSound('success');
                                for(let k=0; k<30; k++) game.particles.push(new Particle(b.x, b.y, b.color));
                                generateQuestion();
                            } else {
                                showFeedback("Tekrar Dene", "#facc15");
                                playSound('bump');
                                game.bubbles.splice(i, 1);
                                if (game.bubbles.filter(bu => bu.isCorrect).length === 0) {
                                    setTimeout(() => spawnBubbles(game.currentQuestion.answer), 800);
                                }
                                return;
                            }
                        }
                        if(b.x < -80) {
                            b.x = w + rnd(100, 300); b.y = rnd(100, h - 200);
                        }
                    });
                }

                for(let i = game.particles.length - 1; i >= 0; i--) {
                    game.particles[i].update();
                    if(game.particles[i].life <= 0) game.particles.splice(i, 1);
                }
            }

            function draw() {
                ctx.clearRect(0, 0, w, h);

                // Peyzaj
                game.landscape.forEach(l => {
                    ctx.fillStyle = l.color;
                    ctx.beginPath();
                    if (l.type === 'mountain') {
                        ctx.moveTo(l.x, l.y); ctx.lineTo(l.x + l.w/2, l.y - l.h); ctx.lineTo(l.x + l.w, l.y);
                    } else {
                        ctx.arc(l.x, l.y, l.r, 0, PI*2);
                    }
                    ctx.fill();
                });

                // Ku≈ülar
                ctx.strokeStyle = "rgba(255,255,255,0.6)"; ctx.lineWidth = 2;
                game.birds.forEach(b => {
                    ctx.beginPath();
                    const wingY = sin(game.time * 15 + b.wingOffset) * 5;
                    ctx.moveTo(b.x, b.y);
                    ctx.lineTo(b.x - 10, b.y - wingY);
                    ctx.moveTo(b.x, b.y);
                    ctx.lineTo(b.x + 10, b.y - wingY);
                    ctx.stroke();
                });

                // S√ºs Bulutlarƒ±
                ctx.fillStyle = "rgba(255,255,255,0.7)";
                game.clouds.forEach(c => {
                    ctx.beginPath(); ctx.arc(c.x, c.y, c.size, 0, PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(c.x-c.size*0.6, c.y+15, c.size*0.7, 0, PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(c.x+c.size*0.6, c.y+15, c.size*0.7, 0, PI*2); ctx.fill();
                });

                // ƒ∞pucu √áizgisi
                if (game.state === 'playing' && game.time - game.questionTime > 8) {
                    const correctBubble = game.bubbles.find(b => b.isCorrect);
                    if (correctBubble) {
                        ctx.save();
                        ctx.beginPath(); ctx.moveTo(plane.x, plane.y); ctx.lineTo(correctBubble.x, correctBubble.y);
                        ctx.strokeStyle = `rgba(255, 255, 255, ${0.4 + sin(game.time * 5) * 0.3})`;
                        ctx.lineWidth = 4; ctx.setLineDash([15, 15]); ctx.stroke(); ctx.restore();
                    }
                }

                // Balonlar (Hepsi aynƒ± stilde, renkli)
                if (game.state === 'playing') {
                    game.bubbles.forEach(b => {
                        ctx.save(); ctx.translate(b.x, b.y);
                        
                        // ƒ∞p
                        ctx.beginPath(); ctx.moveTo(0, b.r); 
                        ctx.quadraticCurveTo(sin(game.time*5+b.wobble)*5, b.r+30, 0, b.r+60);
                        ctx.strokeStyle = "rgba(255,255,255,0.7)"; ctx.lineWidth = 2; ctx.stroke();
                        
                        // Sepet
                        ctx.fillStyle = "#a16207";
                        ctx.fillRect(-10, b.r+60, 20, 15);

                        // Balon
                        const grad = ctx.createRadialGradient(-15, -15, 5, 0, 0, b.r);
                        grad.addColorStop(0, "rgba(255,255,255,0.4)");
                        grad.addColorStop(1, b.color);
                        ctx.fillStyle = grad;
                        ctx.beginPath(); ctx.arc(0, 0, b.r, 0, PI*2); ctx.fill();
                        
                        // Kenar Parlamasƒ±
                        ctx.strokeStyle = "rgba(255,255,255,0.2)"; ctx.lineWidth = 2; ctx.stroke();

                        // Sayƒ±
                        ctx.fillStyle = "#fff"; 
                        ctx.font = "900 45px 'Segoe UI', Arial"; 
                        ctx.textAlign = "center"; ctx.textBaseline = "middle";
                        ctx.shadowColor = "rgba(0,0,0,0.3)"; ctx.shadowBlur = 5;
                        ctx.fillText(b.val, 0, 0);

                        ctx.restore();
                    });
                }

                plane.draw();
                game.particles.forEach(p => p.draw());
            }

            // --- Input ---
            function handleInputStart(x, y) {
                if(game.state !== 'playing') return;
                const dist = hypot(x - plane.x, y - plane.y);
                if (dist < 150) {
                    plane.isDragging = true;
                    plane.targetX = x; plane.targetY = y;
                    controlHint.style.display = 'none';
                }
            }
            function handleInputMove(x, y) {
                if (plane.isDragging) { plane.targetX = x; plane.targetY = y; }
            }
            function handleInputEnd() { plane.isDragging = false; }

            window.addEventListener('mousedown', e => handleInputStart(e.clientX, e.clientY));
            window.addEventListener('mousemove', e => handleInputMove(e.clientX, e.clientY));
            window.addEventListener('mouseup', handleInputEnd);
            
            canvas.addEventListener('touchstart', e => { e.preventDefault(); handleInputStart(e.touches[0].clientX, e.touches[0].clientY); }, {passive: false});
            canvas.addEventListener('touchmove', e => { e.preventDefault(); handleInputMove(e.touches[0].clientX, e.touches[0].clientY); }, {passive: false});
            canvas.addEventListener('touchend', e => { e.preventDefault(); handleInputEnd(); }, {passive: false});

            // UI
            window.toggleSettings = function() {
                if(game.state === 'start') return;
                game.isSettingsOpen = !game.isSettingsOpen;
                settingsModal.style.display = game.isSettingsOpen ? 'block' : 'none';
            };
            window.saveSettings = function() {
                config.mode = document.getElementById('mode-select').value;
                config.sound = document.getElementById('sound-select').value === 'on';
                toggleSettings();
                restartGame();
            };

            function resize() {
                w = canvas.width = window.innerWidth;
                h = canvas.height = window.innerHeight;
                plane.x = w * 0.2; plane.y = h * 0.4;
                initLandscape();
            }
            window.addEventListener('resize', resize);
            
            resize();
            requestAnimationFrame(function loop() { update(); draw(); requestAnimationFrame(loop); });
        })();
    </script>
</body>
</html>
